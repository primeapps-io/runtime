"use strict";angular.module("primeapps").controller("ModuleListController",["$rootScope","$scope","$sce","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","exportFile","operations","ModuleService","$http","components","HelpService","mdToast","$mdDialog","customScripting","$timeout","$compile",function(e,t,a,i,r,l,o,n,s,d,c,u,g,p,m,f,v,w,y,h,_,b,V){function S(e,a,r){for(var l=t.freezeFields||[],o=0;o<e.length;o++){var n=e[o],s=i("filter")(t.module.fields,{name:n.parent_field,deleted:!1},!0)[0];s&&r?l.push(s):s&&k(a,n,s)}return r?l:void 0}function k(e,a,i){for(var r=0;r<e.length;r++)if(!e[r].freeze){var l=f.processRecordSingle(angular.copy(e[r]),t.module,t.modulePicklists),o=!1;if(1===l.process_status)return;if(a.values_array&&a.values_array.length>0)for(var n=0;n<a.values_array.length;n++){var s=parseInt(a.values_array[n]);!l[i.name]||s!==l[i.name]&&s!==l[i.name].id||(o=!0)}else"Yes"===l[i.name]&&(o=!0);e[r].freeze=o}}function F(){return i("filter")(t.module.dependencies,{dependency_type:"freeze",deleted:!1},!0)}function x(e){if(null!=e.group&&null!=e.group.filters&&e.group.filters.length>0){t.logic="";for(var a=0;a<e.group.filters.length;a++){var i=e.group.filters[a];if(null!=i.group)t.logic+=1!==i.group.level&&0!==a?" "+e.group.logic+" ":"",t.logic+=x(i);else if(null!=i.operator&&""!=i.operator){O++;var i=t.processViewFilter(i,O);if(!i)continue;A.push(i),t.logic+=(0===a?"":" "+e.group.logic+" ")+O}}}return t.logic="("+t.logic+")",t.logic}function R(){t.viewChangeStatus||(t.viewChangeStatus=!0)}function D(){if(Array.isArray(e.activeView.filters))for(var a=0;a<e.activeView.filters.length;a++){const r=e.activeView.filters[a];if(r){var l=i("filter")(t.viewFields.selectedFields,{name:r.field},!0)[0];l||(l=i("filter")(t.viewFields.availableFields,{name:r.field},!0)[0],l&&"lookup"===l.data_type&&t.findRequest.fields.push(l.name))}}}t.type=n.type,t.operations=m,t.hasPermission=r.hasPermission,t.loading=!0,t.module=t.modulus[t.type],t.lookupUser=r.lookupUser,t.lookupProfile=r.lookupProfile,t.lookupRole=r.lookupRole,t.searchingDocuments=!1,t.isAdmin=e.user.profile.has_admin_rights,t.hasActionButtonDisplayPermission=f.hasActionButtonDisplayPermission,t.hideDeleteAll=i("filter")(e.deleteAllHiddenModules,t.type+"|"+t.type,!0)[0],t.actionButtonDisabled=!1,t.showExportButton=!0,t.hasViewPermission=!1,t.views=[],t.chartTypes=f.getChartsTypes(),t.showHelp=!1,t.primaryField=t.module.primaryField.name,t.hasBulkUpdatePermission=!1,t.buttonsParametersData={},t.tenantLanguage=tenantLanguage,t.viewChangeStatus=!1,t.gridGroupBy=[];var T=i("filter")(t.module.helps,{modal_type:"side_modal",module_type:"module_list"},!0)[0];T&&(t.showHelp=!0),t.goUrl=function(e){window.location=e},t.goUrl2=function(e){var a=window.getSelection();0===a.toString().length&&(window.location=t.module.primaryField&&t.module.primaryField.external_link?t.module.primaryField.external_link+"?id="+e:"#/app/record/"+t.module.name+"?id="+e)};var M=t.locale||t.language;if(t.isAdmin||(r.hasCustomProfilePermission("view")&&(t.hasViewPermission=!0),r.hasCustomProfilePermission("record_bulk_update")&&(t.hasBulkUpdatePermission=!0)),t.reportTypeOptions={dataSource:[{value:"summary",title:i("translate")("Report.SummaryReport")},{value:"tabular",title:i("translate")("Report.ListViewReport")},{value:"single",title:i("translate")("Report.Single")}],dataTextField:"title",dataValueField:"value",change:function(){}},!t.module)return h.warning(i("translate")("Common.NotFound")),void o.go("app.dashboard");if(e.breadcrumblist=[{title:i("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:e.getLanguageValue(t.module.languages,"label","plural")}],t.bulkUpdate={},t.filter={},!t.hasPermission(t.type,t.operations.read))return h.error(i("translate")("Common.Forbidden")),void o.go("app.dashboard");t.changeAggregationType=function(){t.changeView(!1,!0),R()},f.getActionButtons(t.module.id).then(function(a){t.actionButtons=a,t.toolbarOptions={resizable:!0,items:[]},e.processLanguages(a);for(var i=0;a.length>i;i++){const r=e.getLanguageValue(a[i].languages,"label");if("Detail"!==a[i].trigger&&"Form"!==a[i].trigger&&"Relation"!==a[i].trigger){if("Scripting"===a[i].type&&t.hasActionButtonDisplayPermission(a[i],!0)){var l={template:'<md-button class="btn '+a[i].color+'"   ng-click="runScript('+i+')"  aria-label="'+r+'" > <i class="'+a[i].icon+'"></i> <span>'+r+"</span></md-button>",overflowTemplate:'<md-button ng-click="runScript('+i+')"   class="action-dropdown-item"><i class="'+a[i].icon+'"></i><span> '+r+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("Webhook"===a[i].type&&t.hasActionButtonDisplayPermission(a[i],!0)){var l={template:'<md-button class="btn '+a[i].color+'"  ng-click="webhookRequest('+i+')"    aria-label="'+r+'" > <i class="'+a[i].icon+'"></i> <span>'+r+"</span></md-button>",overflowTemplate:'<md-button ng-click="webhookRequest('+i+')"  class="action-dropdown-item" ><i class="'+a[i].icon+'"></i><span> '+r+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("ModalFrame"===a[i].type&&t.hasActionButtonDisplayPermission(a[i],!0)){var l={template:'<md-button class="btn '+a[i].color+'"  ng-click="showModuleFrameModal(\''+a[i].url+'\')"   aria-label="'+r+'" > <i class="'+a[i].icon+'"></i> <span>'+r+"</span></md-button>",overflowTemplate:"<md-button  ng-click=\"showModuleFrameModal('"+a[i].url+'\')"   class="action-dropdown-item"><i class="'+a[i].icon+'"></i><span> '+r+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("CallMicroflow"===a[i].type&&t.hasActionButtonDisplayPermission(a[i],!0)){var l={template:'<md-button class="btn '+a[i].color+'"  ng-click="runMicroflow('+a[i].microflow_id+","+i+')"   aria-label="'+r+'" > <i class="'+a[i].icon+'"></i> <span>'+r+"</span></md-button>",overflowTemplate:'<md-button ng-click="runMicroflow('+a[i].microflow_id+","+i+')"   class="action-dropdown-item"><i class="'+a[i].icon+'"></i><span> '+r+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}}}}),t.fields=[],t.fieldskey={},t.selectedRows=[],t.selectedRecords=[],t.isAllSelected=!1,t.currentUser=f.processUser(e.user),t.currentDayMin=r.getCurrentDateMin().toISOString(),t.currentDayMax=r.getCurrentDateMax().toISOString(),t.currentHour=r.floorMinutes(new Date),t.allFields=[],t.numberFields=[],t.picklistFields=[],t.dateFields=[],t.calculationFields=[],t.aggregationTypes=[{label:i("translate")("Report.sum"),value:"sum"},{label:i("translate")("Report.avg"),value:"avg"},{label:i("translate")("Report.min"),value:"min"},{label:i("translate")("Report.max"),value:"max"}];for(var B=0;B<t.module.fields.length;B++){var P=t.module.fields[B];f.hasFieldDisplayPermission(P)&&(t.allFields.push(Object.assign({},P)),t.fieldskey[P.name]=P,"numeric"===P.data_type||"number"===P.data_type||"number_auto"===P.data_type||"currency"===P.data_type||"number_decimal"===P.data_type?t.numberFields.push(P):"date"===P.data_type||"date_time"===P.data_type?t.dateFields.push(P):"picklist"===P.data_type&&t.picklistFields.push(P))}t.parseInt=function(e){return parseInt(e)},t.colorPaletOptions={columns:6,palette:["#D24D57","#BE90D4","#5AABE3","#87D37C","#F4D03E","#B8BEC2","#DC3023","#8e44ad","#19B5FE","#25A65B","#FFB61E","#959EA4","#C3272B","#763668","#1F4688","#006442","#CA6924","#4D5C66"]};var C=function(e){var a=t.freezeDependencies||F(t.module.dependencies);a&&a.length>0&&(S(a,e,!1),t.isAllSelected&&(t.isAllSelected=!1,t.selectAll(void 0,e)))};t.chartFilter=function(a){e.activeView.aggregation.aggregation_type&&e.activeView.aggregation.field||(e.activeView.aggregation={aggregation_type:"count",field:"created_by"},t.totalCount=!0);var r=t.fieldskey[e.activeView.group_field];if("groupField"===a&&(t.reportSummary.chart.xaxisname=e.getLanguageValue(r.languages,"label"),t.reportSummary.chart.yaxisname=t.totalCount?i("translate")("Report.count"):"Report."+e.activeView.aggregation.aggregation_type),"aggregationType"===a&&(t.reportSummary.chart.yaxisname=i("translate")(t.totalCount?"Report.count":"Report."+e.activeView.aggregation.aggregation_type)),r&&"lookup"===r.data_type)var l=r.name+"."+r.lookup_type+"."+r.lookupModulePrimaryField.name;var o={module_name:t.module.name,aggregation_field:e.activeView.aggregation.aggregation_type+"("+e.activeView.aggregation.field+")",chart_type:t.reportSummary.chart.chart_type,aggregation_type:e.activeView.aggregation.aggregation_type,group_by:l||e.activeView.group_field,filters:e.activeView.filters,filter_logic:e.activeView.filter_logic};f.chartFilter(o).then(function(e){t.reportSummary.data=e.data,t.reportSummary.isNew||t.initilazSummaryReport()})},t.widgetFilter=function(){e.activeView.aggregation.aggregation_type&&e.activeView.aggregation.field||(e.activeView.aggregation={aggregation_type:"count",field:"created_by"},t.totalCount=!0);var a=e.activeView.aggregation.aggregation_type+"("+e.activeView.aggregation.field+")",i={fields:[a],limit:1,offset:0,filters:e.activeView.filters};f.findRecords(t.module.name,i).then(function(a){e.activeView.value=a.data[0][e.activeView.aggregation.aggregation_type],t.loading=!1})},t.filtera={group:{logic:"and",filters:[],level:1}};var O=0,A=[];t.count=0,t.processViewFilter=function(a,i){var r=t.fieldskey[a.field],l={field:a.field,operator:a.operator,no:i};switch(r.data_type){case"date_time":case"date":if(a.value&&a.value.name)switch(a.value.value){case"costumeN":if(!a.valueX&&!a.nextprevdatetype&&!a.nextprevdatetype.value)return!1;l.value="today("+a.valueX+a.nextprevdatetype.value+")";break;case"costumeM":if(!a.valueX&&!a.nextprevdatetype&&!a.nextprevdatetype.value)return!1;l.value="this_month("+a.valueX+a.nextprevdatetype.value+")";break;case"costumeW":if(!a.valueX&&!a.nextprevdatetype&&!a.nextprevdatetype.value)return!1;l.value="this_week("+a.valueX+a.nextprevdatetype.value+")";break;case"costumeY":if(!a.valueX&&!a.nextprevdatetype&&!a.nextprevdatetype.value)return!1;l.value="this_year("+a.valueX+a.nextprevdatetype.value+")";break;default:if("costume"===a.value.name){if(!a.costumeDate)return!1;l.value=a.costumeDate}else l.value=a.value.value}break;case"multiselect":for(var o=[],n=0;n<a.value.length;n++){var s=a.value[n];o.push(e.getLanguageValue(s.languages,"label"))}l.value=o;break;case"tag":for(var o="",n=0;n<a.value.length;n++)o+=a.value[n].text+"|";l.value=o.slice(0,-1);break;case"lookup":"users"===r.lookup_type?l.value=a.value.id:(l.field=r.name+"."+r.lookup_type+"."+r.lookupModulePrimaryField.name,l.value=a.value);break;case"picklist":l.value=a.value.labelStr;break;default:l.value=a.value}return("empty"===l.operator||"not_empty"===l.operator)&&(l.value="-"),l},t.setListGrid=function(a){var i="tabular"===e.activeView.report_type?e.activeView:t.newGridData;"report"===a?(i.report_type="tabular",i.view_type="report"):(i.report_type="",i.view_type="grid"),i.aggregations=null,i.aggregation=null,t.changeView(i,!1)},t.reportTypeChange=function(){switch(R(),e.activeView.report_type){case"tabular":t.setListGrid("report");break;case"summary":t.reportSummary={config:{dataEmptyMessage:i("translate")("Dashboard.ChartEmptyMessage")}},t.totalCount=!0,e.activeView.aggregation={field:"",aggregation_type:""},t.reportSummary.config={dataEmptyMessage:i("translate")("Dashboard.ChartEmptyMessage")},t.reportSummary.isNew=!0,t.reportSummary.chart={languages:{}},t.reportSummary.chart[e.globalization.Label]={xaxisname:"",yaxisname:""},t.reportSummary.chart.chart_type="column3d",t.reportSummary.chart.report_aggregation_field=e.activeView.aggregation.field,t.reportSummary.chart.showToolTip=e.isMobile()?"0":"1",t.reportSummary.chart.showPercentValues="1",t.reportSummary.chart.showPercentInTooltip="0",t.reportSummary.chart.animateClockwise="1",t.reportSummary.chart.enableMultiSlicing="0",t.reportSummary.chart.isHollow="0",t.reportSummary.chart.is2D="0",t.reportSummary.chart.formatNumberScale="0",t.reportSummary.chart.exportEnabled="1",t.reportSummary.chart.exportTargetWindow="_self",t.reportSummary.chart.exportFileName=t.reportSummary.chart.languages?e.getLanguageValue(t.reportSummary.chart.languages,"caption"):"",t.reportSummary.chart.exportFormats="PNG="+i("translate")("Report.ExportImage")+"|PDF="+i("translate")("Report.ExportPdf")+"|XLS=Export Chart Data";break;case"single":t.totalCount=!0,e.activeView.aggregation={field:"created_by",aggregation_type:"count"},t.widgetFilter()}},t.changeViewType=function(a){return e.activeView.view_type===a?!1:("grid"===a?(e.activeView.groups_json=null,e.activeView.aggregations=[],t.gridGroupBy=[],t.setListGrid("grid")):"report"===a?(e.activeView.view_type="report",e.activeView.report_type="tabular",e.activeView.groups_json=null,t.gridGroupBy=[],t.setListGrid("report"),t.setViewAggregationsFields(t.viewFields.selectedFields)):"calendar"===a?(e.activeView.view_type="calendar",e.activeView.report_type="",e.activeView.groups_json=null,t.gridGroupBy=[],t.setViewCalendar()):"kanban"===a&&(e.activeView.view_type="kanban",e.activeView.report_type="",e.activeView.groups_json=null,t.gridGroupBy=[],e.activeView.settings=null,t.setViewKanban()),void R())},t.viewFilter=function(){O=0,A=[];x(t.filtera);return e.activeView.filters=A,e.activeView.filter_logic=A.length>1?t.logic:"",t.changeView(!1,!0),"single"===e.activeView.report_type?(t.widgetFilter(),!0):"summary"===e.activeView.report_type?(t.chartFilter(),!0):"calendar"===e.activeView.view_type?(t.refreshViewCalendar(),!1):void 0},t.initilazSummaryReport=function(){if(t.module){if(e.activeView.group_field.indexOf(".")<0){var a=t.fieldskey[e.activeView.group_field];a&&(t.reportSummary.groupField=e.getLanguageValue(a.languages,"label"))}else{var r=e.activeView.group_field.split("."),l=i("filter")(e.modules,{name:r[1]},!0)[0],o=i("filter")(t.module.fields,{name:r[0]},!0)[0],n=i("filter")(l.fields,{name:r[2]},!0)[0];t.reportSummary.groupField=e.getLanguageValue(n.languages,"label")+" ("+e.getLanguageValue(o.languages,"label")+")"}e.activeView.aggregations&&angular.isArray(e.activeView.aggregations)&&(e.activeView.aggregation=e.activeView.aggregations[0]);var s;if(e.activeView.aggregation.field.indexOf(".")<0)s=t.fieldskey[e.activeView.aggregation.field];else{var d=e.activeView.aggregation.field.split("."),c=t.module[d[1]];s=i("filter")(c.fields,{name:d[2]},!0)[0]}s&&"currency"===s.data_type&&(t.reportSummary.chart.numberPrefix=e.currencySymbol),!s||"currency"!==s.data_type&&"number_decimal"!==s.data_type||(t.reportSummary.chart.forceDecimals="1")}t.loading=!1},t.setSummary=function(a){t.reportSummary={config:{dataEmptyMessage:i("translate")("Dashboard.ChartEmptyMessage")}},t.current={field:"",direction:""},f.getChart(a.id).then(function(a){var r=angular.isObject(a.data.chart.languages)?a.data.chart.languages:JSON.parse(a.data.chart.languages);t.reportSummary=a.data,t.reportSummary.config={dataEmptyMessage:i("translate")("Dashboard.ChartEmptyMessage")},t.reportSummary.chart.showToolTip=e.isMobile()?"0":"1",t.reportSummary.chart.showPercentValues="1",t.reportSummary.chart.showPercentInTooltip="0",t.reportSummary.chart.animateClockwise="1",t.reportSummary.chart.enableMultiSlicing="0",t.reportSummary.chart.isHollow="0",t.reportSummary.chart.is2D="0",t.reportSummary.chart.formatNumberScale="0",t.reportSummary.chart.exportEnabled="1",t.reportSummary.chart.exportTargetWindow="_self",t.reportSummary.chart.exportFileName=e.getLanguageValue(t.reportSummary.chart.languages,"caption"),t.reportSummary.chart.exportFormats="PNG="+i("translate")("Report.ExportImage")+"|PDF="+i("translate")("Report.ExportPdf")+"|XLS=Export Chart Data",t.reportSummary.chart.xaxisname=r[e.globalization.Label].xaxis_name,t.reportSummary.chart.yaxisname=r[e.globalization.Label].yaxis_name,"tr"===t.locale&&(t.reportSummary.chart.decimalSeparator=",",t.reportSummary.chart.thousandSeparator="."),t.initilazSummaryReport()})},t.setSingleReport=function(a){f.getWidget(a.id).then(function(a){var i=a.data[0];e.activeView.color=i.color,e.activeView.field=i.field,e.activeView.icon=i.icon,e.activeView.type=i.type,e.activeView.value=i.value,e.activeView.aggregation={field:i.field,aggregation_type:i.type},t.loading=!1})},t.setView=function(a){if(a){if(t.viewChangeStatus=!1,o.go("app.moduleList",{type:t.module.name,viewid:a.id},{notify:!1}),e.activeView=a,"report"===a.view_type)switch(("summary"===a.report_type||"single"===a.report_type)&&a.aggregations&&a.aggregations.length>0&&(t.totalCount="count"===a.aggregations[0].aggregation_type?!0:!1),a.report_type){case"summary":t.setSummary(a);break;case"tabular":if(e.activeView=a,a.aggregations)for(var r=0;r<a.fields.length;r++)if(t.fieldskey[a.fields[r].field]&&("numeric"===t.fieldskey[a.fields[r].field].data_type||"number"===t.fieldskey[a.fields[r].field].data_type||"number_auto"===t.fieldskey[a.fields[r].field].data_type||"currency"===t.fieldskey[a.fields[r].field].data_type||"number_decimal"===t.fieldskey[a.fields[r].field].data_type)){var l=i("filter")(a.aggregations,{field:a.fields[r].field})[0];l||a.aggregations.push({field:a.fields[r].field})}t.changeView(e.activeView);break;case"single":t.setSingleReport(a)}else"grid"===a.view_type?(t.gridGroupBy=e.activeView.groups_json?JSON.parse(e.activeView.groups_json):[],t.changeView(e.activeView)):"calendar"===a.view_type?(e.activeView.settings&&!angular.isObject(e.activeView.settings)&&(e.activeView.settings=JSON.parse(e.activeView.settings)),t.loading=!1,t.setViewCalendar()):"kanban"===a.view_type&&(e.activeView.settings&&!angular.isObject(e.activeView.settings)&&(e.activeView.settings=JSON.parse(e.activeView.settings)),f.getPicklists(t.module).then(function(a){e.processPicklistLanguages(a),t.picklistsModule=a,t.setViewKanban()}));"report"===e.activeView.view_type&&"tabular"===e.activeView.report_type&&e.activeView.aggregations&&e.activeView.aggregations.length>0&&e.activeView.aggregations[0].aggregation_type&&(e.activeView.aggregation=e.activeView.aggregations[0]),e.activeView.filter_logic_json&&(t.filtera=JSON.parse(e.activeView.filter_logic_json))}},t.getProfilisByIds=function(t){for(var a=[],r=0;r<t.length;r++){var l=i("filter")(e.profiles,{id:parseInt(t[r])},!0);l&&a.push(l[0])}return a},t.saveModal=function(a){if(!a.validate()||!t.validSelectedFields())return h.error(i("translate")("Module.RequiredError")),!0;if(e.user.profile.has_admin_rights||(e.activeView.sharing_type="me"),"profile"===e.activeView.sharing_type&&(e.activeView.profile=t.getProfilisByIds(e.activeView.profiles)),"report"===e.activeView.view_type&&"summary"===e.activeView.report_type&&!e.activeView.group_field)return void h.error(i("translate")("Module.RequiredError"));e.preview&&(e.activeView.editable="custom"===e.activeView.system_type?!0:!1),t.viewIsSaveing=!1;var r=angular.element(document.body);_.show({parent:r,templateUrl:"view/app/module/common/viewSaveModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.viewNameMax=function(){t.viewName.length>50&&(t.viewName=e.getLanguageValue(e.activeView.languages,"label"),h.error(i("translate")("View.ViewNameMaxLength",{maxLength:50})))},t.SaveView=function(a){if(!t.viewSaveModalForm.validate())return h.error(i("translate")("Module.RequiredError")),void(t.viewIsSaveing=!1);if("add"===a&&(t.viewIsSaveing=!0),t.viewFields&&t.viewFields.selectedFields){e.activeView.fields=[];for(var r=0;r<t.viewFields.selectedFields.length;r++){var l=t.viewFields.selectedFields[r].name;"lookup"!==t.viewFields.selectedFields[r].data_type||t.viewFields.selectedFields[r].labelExt?e.activeView.fields.push({field:t.viewFields.selectedFields[r].name,order:r}):(l=l.split(".")[0],e.activeView.fields.push({field:l,order:r}),e.activeView.fields.push({field:t.viewFields.selectedFields[r].name+".primary",order:r}))}}e.activeView.filter_logic_json=JSON.stringify(t.filtera);var o={filters:e.activeView.filters,module_id:e.activeView.module_id,sharing_type:e.activeView.sharing_type,filter_logic_json:e.activeView.filter_logic_json,view_type:e.activeView.view_type,languages:e.activeView.languages};if(o.languages[e.globalization.Label].label=t.viewName||e.getLanguageValue(e.activeView.languages,"label"),"report"===e.activeView.view_type?o.report_type=e.activeView.report_type:"grid"===e.activeView.view_type?(o.fields=e.activeView.fields,o.report_type="",o.aggregations=e.activeView.aggregations.length>0?i("filter")(e.activeView.aggregations,{active:!0}):null,o.groups_json=t.gridGroupBy.length>0?JSON.stringify(t.gridGroupBy):null):("calendar"===o.view_type||"kanban"===o.view_type)&&(o.fields=e.activeView.fields,o.settings=JSON.stringify(e.activeView.settings),o.report_type="",o.aggregations=null,o.groups_json=null),"edit"===a&&(o.id=e.activeView.id),"custom"===e.activeView.sharing_type){if(o.shares=[],e.activeView.shares.length<1)return h.error(i("translate")("Module.RequiredError")),t.viewIsSaveing=!1,!1;for(var n=0;n<e.activeView.shares.length;n++)o.shares.push(e.activeView.shares[n].id)}if("profile"===e.activeView.sharing_type){if(o.profiles=[],!e.activeView.profile)return void(t.viewIsSaveing=!1);for(var r=0;r<e.activeView.profile.length;r++)o.profiles.push(e.activeView.profile[r].id)}switch(e.activeView.report_type){case"summary":o.group_field=e.activeView.group_field,o.sort_field=e.activeView.sort_field,o.sort_direction="asc",o.aggregations=[{field:e.activeView.aggregation.field,aggregation_type:e.activeView.aggregation.aggregation_type}],o.chart={type:t.reportSummary.chart.chart_type,languages:{}},o.chart.languages[e.globalization.Label]={caption:o.languages[e.globalization.Label].label,name:o.languages[e.globalization.Label].label,xaxis_name:t.reportSummary.chart.xaxisname,yaxis_name:t.reportSummary.chart.yaxisname};break;case"tabular":o.fields=e.activeView.fields,o.aggregations=e.activeView.aggregations;break;case"single":o.aggregations=[{field:e.activeView.aggregation.field||"created_by",aggregation_type:e.activeView.aggregation.aggregation_type||"count"}],o.widget={color:e.activeView.color,icon:e.activeView.icon,languages:{}},o.widget.languages[e.globalization.Label]={name:e.getLanguageValue(e.activeView.languages,"label")}}e.preview&&(o["default"]=e.activeView["default"],o.system_type=e.activeView.editable?"custom":"system"),e.languageStringify(o),f.saveView(a,o).then(function(){h.success(i("translate")("View.ViewUpdateSucces")),f.getViews(t.module).then(function(a){e.processLanguages(a),t.views=a,t.views.reverse(),e.activeView=t.views[0],u.put(t.module.name+"-activeView",e.activeView);var r=i("filter")(t.views,{"default":!0},!0)[0];if(r){var l=t.views.indexOf(r);t.views[l]=e.activeView,t.views[0]=r}if(e.activeView.shares){for(var o=[],n=0;n<e.activeView.shares.length;n++)o.push({id:e.activeView.shares[n].user_id,full_name:e.activeView.shares[n].user.full_name});e.activeView.shares=o}t.setView(e.activeView)}),t.closeLightBox(),e.closeSide("sideModal")})},t.sharesOptions={dataSource:t.users,filter:"contains",dataTextField:"full_name",dataValueField:"id",optionLabel:i("translate")("Common.Select")},t.profilesOptions={dataSource:e.profiles,filter:"contains",dataTextField:"languages."+e.globalization.Label+".name",dataValueField:"id",optionLabel:i("translate")("Common.Select")},t.reloadFieldSelection=function(){var e=$("#available-fields").data("kendoListBox"),a=$("#selected-fields").data("kendoListBox");if(e)for(t.selectedFieldsOptions.dataSource=new kendo.data.DataSource({data:t.viewFields.selectedFields}),t.availableFieldsOptions.dataSource=new kendo.data.DataSource({data:t.preview?t.viewFields.availableFields:i("filter")(t.viewFields.availableFields,{name:"!is_sample"},!0)}),e.setDataSource(t.availableFieldsOptions.dataSource),a.setDataSource(t.selectedFieldsOptions.dataSource),B=0;e.options.dataSource._data.length>B;B++)e.options.dataSource._data[B].name.includes("seperator-")&&e.enable($(".k-item").eq(B),!1)},t.refreshColumn=function(a){setTimeout(function(){R();var r=$("#selected-fields").data("kendoListBox"),l=$("#available-fields").data("kendoListBox"),o=r.wrapper.find(".k-item"),n=l.wrapper.find(".k-item"),s=[],d=[];$.each(o,function(e,t){s.push(r.dataItem(t))}),$.each(n,function(e,t){d.push(l.dataItem(t))}),t.viewFields.selectedFields=s,t.viewFields.availableFields=i("orderBy")(d,"order"),a||t.reloadFieldSelection(),"tabular"===e.activeView.report_type?t.setViewAggregationsFields(t.viewFields.selectedFields):"grid"===e.activeView.view_type&&(t.gridGroupAggregationFields(t.viewFields.selectedFields),t.gridGroupFields(t.viewFields.selectedFields)),t.changeView(!1,!0)},200)},t.changeView=function(a,r){t.selectedRows.length>0&&(t.isAllSelected=!1,t.selectedRows=[]),r||(e.activeView=a,a.filter_logic_json&&(t.filtera=JSON.parse(a.filter_logic_json)),t.viewFields=f.getViewFields(t.module,e.activeView),t.availableFieldsOptions={disabled:!0,draggable:!0,dataTextField:"label",dataValueField:"name",connectWith:"selected-fields",autoScroll:!0,dataSource:t.preview?t.viewFields.availableFields:i("filter")(t.viewFields.availableFields,{name:"!is_sample"},!0),dropSources:["selected-fields"],template:"<div class='list-title'>#:label#</div>",enable:function(){},reorder:function(e){e.preventDefault()},add:function(e){var a=e.dataItems[0];if(a.labelExt){var r=a.name.substring(0,a.name.lastIndexOf(".")),l=i("filter")(t.viewFields.availableFields,function(e){return e.name.indexOf(r)>-1&&e.labelExt===a.labelExt});l&&l.length>0&&(a.parent_id=l[0].parent_id,a.order+=a.parent_id)}else a.parent_id=0;t.refreshColumn()}},t.selectedFieldsOptions={draggable:!0,dataTextField:"label",dataValueField:"name",autoScroll:!0,template:"<div class='list-title'>#:label# #:labelExt ?? ''#</div>",connectWith:"available-fields",dataSource:t.viewFields.selectedFields,dropSources:["available-fields"],reorder:function(){t.refreshColumn(!0)},add:function(){t.refreshColumn()}},t.reloadFieldSelection()),"grid"!==e.activeView.view_type?t.gridGroupBy=[]:(e.activeView.groups_json=t.gridGroupBy.length>0?JSON.stringify(t.gridGroupBy):null,t.gridGroupBy=e.activeView.groups_json?JSON.parse(e.activeView.groups_json):[]);var l={moduleName:t.module.name};if("report"===e.activeView.view_type&&e.activeView.report_type?l.activeView=e.activeView:"grid"===e.activeView.view_type&&(l.activeView=e.activeView,l.gridGroupBy=t.gridGroupBy),e.isMobile()){for(var o=[],n=t.viewFields.selectedFields.length>3?3:t.viewFields.selectedFields.length,s=0;n>s;s++)o.push(t.viewFields.selectedFields[s]);t.viewFields.selectedFields=o}var d=f.generatRowtmpl(t.viewFields.selectedFields,!1,l);if("report"===e.activeView.view_type&&"tabular"===e.activeView.report_type&&e.activeView.aggregations&&d.columns.map(function(a){for(var i=0;i<e.activeView.aggregations.length;i++)if(a.field===e.activeView.aggregations[i].field&&e.activeView.aggregations[i].aggregation_type){var r=e.activeView.aggregations[i].aggregation_type+"("+e.activeView.aggregations[i].field+")";a.footerTemplate="<div> {{ 'Report."+e.activeView.aggregations[i].aggregation_type+"' | translate  }} : {{ "+r.replace("(","_").replace(")","")+"}} </div>";var l={fields:[r],limit:1,offset:0,filters:e.activeView.filters};f.findRecords(t.module.name,l).then(function(e){t[e.config.data.fields[0].replace("(","_").replace(")","")]=e.data[0][[e.config.data.fields[0].split("(")[0]]]})}}),t.findRequest={module:t.module.name,filter_logic:e.activeView.filter_logic,filters:e.activeView.filters,convert:!0,fields:d.requestFields},D(),t.freezeDependencies=F(t.module.dependencies),t.freezeDependencies&&(t.freezeFields=S(t.freezeDependencies,void 0,!0),t.freezeFields))for(var c=0;c<t.freezeFields.length;c++)t.findRequest.fields.indexOf(t.freezeFields[c].name)<0&&t.findRequest.fields.push(t.freezeFields[c].name);if(u.put(t.module.name+"-activeView",e.activeView),u.put(t.module.name+"-activeViewFields",t.viewFields.selectedFields),e.activeView.filter_logic_json=JSON.stringify(t.filtera),t.loading=!0,t.executeCode=!1,w.run("BeforeListRequest","Script",t),!t.executeCode)if("tabular"===e.activeView.report_type)t.mainGridTabularOptions={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:function(a){$.ajax({url:"/api/record/find_custom?locale="+M,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest,a.data)),success:function(i){if(i.data&&i.data.length>0&&C(i.data),a.success(i),t.loading=!1,e.isMobile()||$(".k-pager-wrap").removeClass("k-pager-sm"),"report"===e.activeView.view_type&&i.total_count<1)$(".k-grid-footer").addClass("hide");else{var r=!1;if(e.activeView.aggregations)for(var l=0;l<e.activeView.aggregations.length;l++){var o=e.activeView.aggregations[l];o.field&&o.aggregation_type&&(r=!0)}r?"":$(".k-grid-footer").addClass("hide")}},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},rowTemplate:'<tr ng-click="goUrl2(dataItem.id)">'+d.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt" ng-click="goUrl2(dataItem.id)">'+d.rowtempl+"</tr>",scrollable:!1,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:d.columns};else if("grid"===e.activeView.view_type)t.gridGroupAggregationFields(t.viewFields.selectedFields),t.aggregationsOrder(),t.findRequest.aggregations=i("filter")(e.activeView.aggregations,{active:!0}),t.findRequest.type="grid",t.findRequest.groupDate=t.gridGroupBy.length>0?t.gridGroupBy:void 0,t.mainGridOptions={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,serverGrouping:!0,serverAggregates:!0,group:t.gridGroupBy.length>0?t.gridGroupBy:void 0,transport:{read:function(a){$.ajax({url:"/api/record/find_custom?locale="+M,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest,a.data)),success:function(i){i.data&&i.data.length>0&&C(i.data),a.success(i),t.loading=!1,e.isMobile()||$(".k-pager-wrap").removeClass("k-pager-sm"),0===t.gridGroupBy.length?$(".k-grouping-header").hide():$(".k-grouping-header").show()},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"},groups:"groups",parse:function(e){return e.groups=t.parseGridData(e),t.gridData=e,e}}},rowTemplate:'<tr ng-click="goUrl2(dataItem.id)">'+d.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt" ng-click="goUrl2(dataItem.id)">'+d.rowtempl+"</tr>",scrollable:!1,groupable:!0,sortable:t.gridGroupBy.length>0?0:1,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:d.columns};else if("kanban"===e.activeView.view_type&&e.activeView.settings&&e.activeView.settings.kanbanPicklist){t.kanbanBoards();var g=i("filter")(t.picklistFields,{picklist_id:parseInt(e.activeView.settings.kanbanPicklist)},!0)[0];-1===d.requestFields.indexOf(g.name)&&d.requestFields.push(g.name),t.findRequestKanban={module:t.module.name,filter_logic:e.activeView.filter_logic,filters:e.activeView.filters,convert:!0,fields:d.requestFields,picklist_name:g.name},t.getItemCount=t.findRequestKanban.fields.length<=3?15:10,t.boards&&t.boards.length>0&&t.boards.forEach(function(e){t.kanbanListViewAltOptionsSet(e)}),t.kanbanMainOptions={template:t.boardTemplateMain(),dataSource:t.boards},V(function(){var e=$("#modul-area-app").innerHeight(),t=$("#modul-area-app-menu").innerHeight();$("#kanban-view").height(e-t-50)},250),t.sortableKanbanOptions={filter:".card",container:".board",connectWith:".k-listview-content",cursor:"grabbing",placeholder:function(e){return $('<div class="card"></div>').css({background:"#fff",height:e[0].offsetHeight+"px",margin:"10px 20px"})},autoScroll:!0,change:function(a){if("receive"===a.action){var r=parseInt(a.item[0].id.split("-")[2]),l=parseInt(a.sender.element[0].parentElement.id.split("-")[2]),o=i("filter")(t.picklistFields,{picklist_id:e.activeView.settings.kanbanPicklist})[0],n={id:r};n[o.name]=0!==l?l:null,f.updateRecord(t.module.name,n).then(function(){h.success(i("translate")("Module.UpdateRecordBulkSuccess"))})["catch"](function(){h.error(i("translate")("Common.Error"))})}else{var s=parseInt(a.sender.element[0].parentElement.id.split("-")[2]),d=$("#list-kanban-"+s+" .k-listview-content .card");
if(d&&d.length<10&&!t["getItems"+s]){t["getItems"+s]=!0,t["page"+s]++;var c=$("#list-kanban-"+s),u=c.data("kendoListView");t["scrollData"+s].query({page:t["page"+s],pageSize:t.getItemCount}).then(function(){var e=t["scrollData"+s].data();if(e.length>0){for(var a=0;a<e.length;a++)u.dataSource.pushCreate(e[a]);t["scroll"+s]=!0}})}}},end:function(){$(".left-right-to-items").remove(),$(".item-block-same-area").remove()},hint:function(e){var t=$("#board .k-listview-content:first");t.prepend("<div style='height: 100%; width: 12%; position:fixed; z-index: 10000; left:0;' class='list-header left-right-to-items'></div> <div style='height: 100%; width: 12%; position:fixed; z-index: 10000; right:0;' class='list-header left-right-to-items'></div>");var a=parseInt(e[0].parentElement.parentElement.id.split("-")[2]);return $("#list-kanban-"+a).prepend("<div style='height: 100%; width: 100%; position:absolute; z-index: 10000;' class='item-block-same-area'></div>"),e.clone().css({width:"17em",background:"white",boxShadow:"0 0.5rem 0.75rem rgba(0, 0, 0, 0.075)"})}}}},f.getViews(t.module).then(function(a){if(e.processLanguages(a),t.views=a,t.shadowViews=angular.copy(a),t.views.length<1)return void(t.loading=!1);t.views.reverse();var r=!1,l=i("filter")(t.views,{"default":!0},!0)[0]||t.views[0];!e.activeView||e.activeView&&e.activeView.module_id!==t.module.id?e.activeView=l:(e.activeView=i("filter")(t.views,{id:e.activeView.id},!0)[0],r=!0);var o=-1;r?(o=t.views.indexOf(l),t.views[o]=t.views[0],t.views[0]=l):(o=t.views.indexOf(e.activeView),t.views[o]=t.views[0],t.views[0]=e.activeView);for(var s=0;s<t.views.length;s++)if(t.views[s].shares&&t.views[s].shares.length>0){for(var d=[],c=0;c<t.views[s].shares.length;c++)d.push({id:t.views[s].shares[c].user_id,full_name:t.views[s].shares[c].user.full_name});t.views[s].shares=d}if(n.viewid)return t.viewid=n.viewid,e.activeView=i("filter")(t.views,{id:parseInt(t.viewid)},!0)[0],e.activeView.filter_logic_json&&(t.filtera=JSON.parse(e.activeView.filter_logic_json)),t.setView(e.activeView),!0;var g=u.get(t.module.name+"-activeView");return g?(t.setView(g),!0):void t.setView(e.activeView)}),t.parseGridData=function(a){var r=[];if(t.gruopFilters=[],a.data&&a.data.length>0&&1===t.gridGroupBy.length)for(var l=t.gridGroupBy[0].field,o=0;o<a.data.length;o++){var n="";n=null===t.gridGroupBy[0].dateType||"date_time"!==t.gridGroupBy[0].data_type&&"date"!==t.gridGroupBy[0].data_type&&"time"!==t.gridGroupBy[0].data_type?a.data[o][l]:t.groupDateSortName(t.gridGroupBy[0].dateType,a.data[o][l]),n=n.toString();var s=i("filter")(r,{value:n},!0)[0];if(s)s.items.push(a.data[o]);else{var d={field:l,value:n,items:[a.data[o]],hasSubgroups:!1};r.push(d);var c=i("filter")(t.module.fields,{name:l.split(".")[0]},!0)[0],u=l.split(".");u.length>1&&(u=u[0]+"."+u[1]+".id");var g=a.data[o][u].toString();"currency"===c.data_type&&(g=g.slice(1)),t.gruopFilters.push({field:l.split(".")[0],value:g,operator:c.operators[0].name,no:1})}}else if(a.data&&a.data.length>0&&2===t.gridGroupBy.length){for(var p=t.gridGroupBy[0].field,m=0;m<a.data.length;m++){var n="";n=null===t.gridGroupBy[0].dateType||"date_time"!==t.gridGroupBy[0].data_type&&"date"!==t.gridGroupBy[0].data_type&&"time"!==t.gridGroupBy[0].data_type?a.data[m][p]:t.groupDateSortName(t.gridGroupBy[0].dateType,a.data[m][p]),n=n.toString();var f=i("filter")(r,{value:n},!0)[0];if(!f){var v={field:p,value:n,items:[],hasSubgroups:!0};r.push(v);var w=i("filter")(t.module.fields,{name:p.split(".")[0]},!0)[0],u=p.split(".");u.length>1&&(u=u[0]+"."+u[1]+".id");var g=a.data[m][u].toString();"currency"===w.data_type&&(g=g.slice(1)),t.gruopFilters.push({field:p.split(".")[0],value:g,operator:w.operators[0].name,no:1})}}for(var y=t.gridGroupBy[1].field,h=0;h<a.data.length;h++){var _="";_=null===t.gridGroupBy[0].dateType||"date_time"!==t.gridGroupBy[0].data_type&&"date"!==t.gridGroupBy[0].data_type&&"time"!==t.gridGroupBy[0].data_type?a.data[h][p]:t.groupDateSortName(t.gridGroupBy[0].dateType,a.data[h][p]),_=_.toString();var b=i("filter")(r,{value:_},!0)[0];if(b){var S="";S=null===t.gridGroupBy[1].dateType||"date_time"!==t.gridGroupBy[1].data_type&&"date"!==t.gridGroupBy[1].data_type&&"time"!==t.gridGroupBy[1].data_type?a.data[h][y]:t.groupDateSortName(t.gridGroupBy[1].dateType,a.data[h][y]);var k=i("filter")(b.items,{value:S},!0)[0];if(k)k.items.push(a.data[h]);else{var F={field:y,value:S,items:[a.data[h]],hasSubgroups:!1};b.items.push(F)}}}}return e.activeView.aggregations&&t.gruopFilters.length>0&&"grid"===e.activeView.view_type&&a.aggregations&&a.aggregations.length>0&&V(function(){var e=$("tbody tr td:only-child p.k-reset");if(e.length>0&&e.length===a.aggregations.length)for(var r=0;r<a.aggregations.length;r++)for(var l=0;l<a.aggregations[r].fields.length;l++)if(r===a.aggregations[r].group_value){var o=a.aggregations[r].fields[l].split("::")[0],n=o.split("(")[0],s=o.split("(")[1];s=s.slice(0,s.length-1);var d=i("filter")(t.module.fields,{name:s},!0)[0],c=a.aggregations[r].label[l];e[r].innerHTML+=t.aggregationsParseText(n,c,a.aggregations[r].data[o],d,a.data)}},100),r},t.groupDateSortName=function(e,t){var a="",i=new Date(t);if(isNaN(i)||""===t||null===t||void 0===t)return a;for(var r=t.match(/(\d+)/g),l=kendo.cultures.current.calendar.patterns.d.split(/[.\/\s,]+/),o={},n=0;n<l.length;n++)switch(l[n]){case"DD":case"dd":case"D":case"d":o.d=r[n];break;case"MM":case"mm":case"M":case"m":o.m=r[n];break;case"YYYY":case"yyyy":case"YY":case"yy":o.y=r[n]}switch(t=new Date(o.y,o.m-1,o.d,i.getHours()),e){case"year":a=o.y;break;case"ym":var s={year:"numeric",month:"long"};a=new Intl.DateTimeFormat(kendo.cultures.current.name,s).format(t);break;case"ymd":var s={year:"numeric",month:"long",weekday:"long",day:"numeric"};a=new Intl.DateTimeFormat(kendo.cultures.current.name,s).format(t);break;case"all":var s={year:"numeric",month:"long",weekday:"long",day:"numeric"};a=new Intl.DateTimeFormat(kendo.cultures.current.name,s).format(t)+", "+t.getHours()+":00-"+t.getHours()+":59"}return a},t.aggregationsParseText=function(e,t,a,r){if(null===a&&(a=0),Number.isInteger(a)||(a=parseFloat(a).toFixed(2)),r&&r.data_type&&"currency"===r.data_type){var l=r.currency_symbol?r.currency_symbol:null;l||(l="$"),"â‚º"===l?a+=l:a=l+a}var o="";switch(e){case"sum":o="<div class='ml-3 badge standart badge-secondary'>"+t+" ("+i("translate")("Report.sum")+"): <span>"+a+"</span></div>";break;case"avg":o="<div class='ml-3 badge standart badge-secondary'>"+t+" ("+i("translate")("Report.avg")+"): <span>"+a+"</span></div>";break;case"max":o="<div class='ml-3 badge standart badge-secondary'>"+t+" ("+i("translate")("Report.max")+"): <span>"+a+"</span></div>";break;case"min":o="<div class='ml-3 badge standart badge-secondary'>"+t+" ("+i("translate")("Report.min")+"): <span>"+a+"</span></div>";break;case"count":o="<div class='ml-3 badge standart badge-secondary'>"+t+": <span>"+a+"</span></div>"}return o},t.gridGroupFields=function(a){if("grid"===e.activeView.view_type&&t.gridGroupBy.length>0)for(var r=0;r<t.gridGroupBy.length;r++){var l=t.gridGroupBy[r].field;i("filter")(a,{name:l},!0)[0]||(t.gridGroupBy.splice(r,1),0===t.gridGroupBy.length&&(t.gridGroupBy=[]))}},t.aggregationsOrder=function(){var t=Object.assign([],e.activeView.aggregations),a=i("filter")(t,{aggregation_type:"count"},!0)[0],r=t.indexOf(a);t.splice(r,1),t.push(a),e.activeView.aggregations=t},t.gridGroupAggregationFields=function(a){if("grid"===e.activeView.view_type&&t.gridGroupBy.length>0){var r={label:i("translate")("Report.count"),aggregation_type:"count",field:"undefined",active:!1};null===e.activeView.aggregations&&(e.activeView.aggregations=[]);for(var l=0;l<e.activeView.aggregations.length;l++){var o=e.activeView.aggregations[l];if(!o){var n=e.activeView.aggregations.indexOf(o);e.activeView.aggregations.splice(n,1)}}for(var s=0;s<a.length;s++){var d=a[s];if(!("numeric"!==d.data_type&&"number"!==d.data_type&&"number_auto"!==d.data_type&&"currency"!==d.data_type&&"number_decimal"!==d.data_type||d.name.contains(".")||d.deleted)){if(e.activeView.aggregations&&e.activeView.aggregations.length>0)var c=i("filter")(e.activeView.aggregations,{field:d.name},!0)[0];c?c.label=d.label:e.activeView.aggregations.push({field:d.name,aggregation_type:"sum",active:!1,label:d.label})}}var u=i("filter")(e.activeView.aggregations,{aggregation_type:"count"},!0)[0];u?(u.label=i("translate")("Report.count"),u.field="undefined"):e.activeView.aggregations.push(r);for(var g=0;g<e.activeView.aggregations.length;g++){var p=e.activeView.aggregations[g];if(!i("filter")(a,{name:p.field},!0)[0]&&"count"!==p.aggregation_type){var m=e.activeView.aggregations.indexOf(p);e.activeView.aggregations.splice(m,1)}}}},t.switchChange=function(a){if(a){var r=i("filter")(e.activeView.aggregations,{field:a.field},!0)[0];r&&(r.active=a.active,r.aggregation_type=a.aggregation_type)}a.active===!0&&a.aggregation_type?t.changeAggregationType():a.active===!1&&t.changeAggregationType()},t.addGridGroup=function(){var e={};if(0===t.gridGroupBy.length)e.fieldArea=t.viewFields.selectedFields[0].name,e.field=t.viewFields.selectedFields[0].name,e.data_type=t.viewFields.selectedFields[0].data_type,e.dir="asc",("date"===e.data_type||"date_time"===e.data_type||"time"===e.data_type)&&(e.dateType="all",e.dateTypeArea="all");else if(t.viewFields.selectedFields.length>1){var a=1;t.gridGroupBy[0].field===t.viewFields.selectedFields[a].name&&(a=0),e.fieldArea=t.viewFields.selectedFields[a].name,e.field=t.viewFields.selectedFields[a].name,e.data_type=t.viewFields.selectedFields[a].data_type,e.dir="asc",("date"===e.data_type||"date_time"===e.data_type||"time"===e.data_type)&&(e.dateType="all",e.dateTypeArea="all")}Object.keys(e).length>0&&t.gridGroupBy.push(e),t.changeAggregationType()},t.changeGridGroupSort=function(e){e.dir="asc"===e.dir?"desc":"asc",t.changeAggregationType()},t.gridGroupDelete=function(e,a){if(a.splice(e,1),0===a.length){t.gridGroupBy=[];for(var i=0;i<t.activeView.aggregations.length;i++)t.activeView.aggregations[i].active=!1}t.changeAggregationType()},t.changeGridGroupField=function(e){var a=i("filter")(t.viewFields.selectedFields,{name:e.fieldArea},!0)[0];if(i("filter")(t.gridGroupBy,{field:a.name},!0)[0]){if(e.data_type=a.data_type,e.field=a.name,delete e.dateType,"date"===a.data_type||"date_time"===a.data_type||"time"===a.data_type)return e.dateType="all",e.dateTypeArea="all",void(t.loading=!0)}else if(e.data_type=a.data_type,e.field=a.name,delete e.dateType,"date"===a.data_type||"date_time"===a.data_type||"time"===a.data_type)return e.dateType="all",e.dateTypeArea="all",void(t.loading=!0);"date"===a.data_type||"date_time"===a.data_type||"time"===a.data_type?t.loading=!0:(delete e.dateType,t.changeAggregationType())},t.gruopsForDateArea=[{label:i("translate")("View.DateAll"),type:"all"},{label:i("translate")("View.DateYear"),type:"year"},{label:i("translate")("View.DateYM"),type:"ym"},{label:i("translate")("View.DateYMD"),type:"ymd"}],t.groupsForDate=function(e){var a=i("filter")(t.gruopsForDateArea,{type:e.dateTypeArea},!0)[0];e.dateType=a.type},t.kanbanBoards=function(){t.boards=[];var a={id:0,label:i("translate")("View.Uncategorized")};t.picklistsModule&&e.activeView&&e.activeView.settings&&e.activeView.settings.kanbanPicklist&&(t.boards=Object.assign([],t.picklistsModule[e.activeView.settings.kanbanPicklist]),t.boards.unshift(a))},t.setViewKanban=function(){if(f.getPicklists(t.module).then(function(a){e.processPicklistLanguages(a),t.picklistsModule=a}),t.boards=[],e.activeView.settings&&e.activeView.settings.kanbanPicklist){var a="kanban"===e.activeView.view_type?e.activeView:t.newGridData;t.changeView(a,!1),t.boards&&t.boards.length>0&&t.boards.forEach(function(e){t.kanbanListViewAltOptionsSet(e)})}else t.kanbanMainOptions=null,t.loading=!0},t.boardTemplateMain=function(){return"<div class='col'><div class='list-wrapper'>        <div class='list-header'>          <span class='list-title'>#: label #</span>        </div>        <div id='list-kanban-#: id #' kendo-list-view k-rebind='kanbanListViewAltOptions#: id #' k-options='kanbanListViewAltOptions#: id #' class='list'></div>      </div></div>"},t.getKanbanDataLenght=1,t.kanbanListViewAltOptionsSet=function(a){var i="kanbanListViewAltOptions"+a.id,r="kanbanFilter"+a.id,l={};t[r]=angular.copy(t.findRequestKanban),l=0===a.id?{field:t[r].picklist_name,operator:"empty",no:1,value:"-"}:{field:t[r].picklist_name,operator:"is",no:1,value:a.labelStr?a.labelStr:a.value},t[r].filters&&1===t[r].filters.length?(l.no=2,t[r].filters.push(l),t[r].filter_logic="(1 and 2)"):t[r].filters&&t[r].filters.length>1?(l.no=t[r].filters.length+1,t[r].filters.push(l),t[r].filter_logic="("+l.no+" and "+t[r].filter_logic+")"):(t[r].filters=[l],t[r].filter_logic=""),t[i]={theme:"default",template:function(e){var i="";return t.viewFields.selectedFields.forEach(function(t,a){i+=0===a?"<div class='primary md-truncate'> <i class='fas fa-grip-vertical'></i> "+e[t.name]+" </div>":"<div class='others md-truncate'><span>"+t.label+":</span> <span class='label-data' ng-if='"+!!e[t.name]+"'> "+e[t.name]+" </span></div>"}),"<div id='kanban-sortable-"+e.id+"' name='"+a.id+"' class='card kanban-card' ng-click='goUrl2("+e.id+")'>"+i+"</div>"},dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,pageSize:t.getItemCount,transport:{read:function(i){$.ajax({url:"/api/record/find_custom?locale="+M,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t[r],i.data)),success:function(e){e.data?i.success(e.data):$(".k-loading-mask").remove(),$("#list-kanban-"+a.id+" .k-listview-content").kendoSortable(t.sortableKanbanOptions),t.boards&&t.boards.length>0&&t.boards.length===t.getKanbanDataLenght?(t.getKanbanDataLenght=1,t.loading=!1):t.getKanbanDataLenght+=1},beforeSend:e.beforeSend()})}},schema:{total:"total",id:"id"}}},t["scrollData"+a.id]=new kendo.data.DataSource({serverPaging:!0,serverFiltering:!0,serverSorting:!0,pageSize:t.getItemCount,transport:{read:function(a){$.ajax({url:"/api/record/find_custom?locale="+M,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t[r],a.data)),success:function(e){e.data&&a.success(e.data),t.loading=!1},beforeSend:e.beforeSend()})}},schema:{total:"total",id:"id"}}),V(function(){t["page"+a.id]=1,t["scroll"+a.id]=!0,$("#list-kanban-"+a.id+" .k-listview-content").on("scroll",function(){if($(this).scrollTop()+$(this).innerHeight()+25*$(this)[0].scrollHeight/100>=$(this)[0].scrollHeight&&t["scroll"+a.id]||$(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&t["scroll"+a.id]){t["scroll"+a.id]=!1,t["page"+a.id]++;var e=$("#list-kanban-"+a.id),i=e.data("kendoListView");t["scrollData"+a.id].query({page:t["page"+a.id],pageSize:t.getItemCount}).then(function(){var e=t["scrollData"+a.id].data();if(e.length>0){for(var r=0;r<e.length;r++)i.dataSource.pushCreate(e[r]);t["scroll"+a.id]=!0}})}})},800)},t.showModuleFrameModal=function(e){var t,a,i;t="myPop1",a=document.body.offsetWidth-200,i=document.body.offsetHeight-200;var r=screen.width/2-a/2,l=screen.height/2-i/2;window.open(e,t,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+a+", height="+i+", top="+l+", left="+r)},t.trustAsHtml=function(e){return a.trustAsHtml(e)},t.webhookRequest=function(a){if(!t.selectedRows||t.selectedRows.length<1)return void h.warning(i("translate")("Module.NoRecordSelected"));var r=t.actionButtons[a],l=r.parameters.split(","),o=r.headers.split(",");t.webhookRequesting={},t.webhookRequesting[r.id]=!0,f.getRecords(t.module.name,t.selectedRows).then(function(a){if(!a||!a.data||a.data.length<1)return void h.error(i("translate")("Common.NotFoundRecord"));for(var n=0;n<a.data.length;n++){var s={},d={"Content-Type":"application/json"},c=f.processRecordSingle(a.data[n],t.module,t.modulePicklists);if(angular.forEach(l,function(e){var a=e.split("|"),i=a[0],r=a[1],l=a[2];s[i]=r!==t.module.name?c[r]?c[r][l]:null:c[l]?c[l]:null}),angular.forEach(o,function(a){var i=a.split("|"),r=i[0],l=i[1],o=i[2],n=i[3];switch(r){case"module":var s=n;d[o]=l!==t.module.name?c[l]?c[l][s]:null:c[s]?c[s]:null;break;case"static":switch(n){case"{:app:}":d[o]=e.user.app_id;break;case"{:tenant:}":d[o]=e.user.tenant_id;break;case"{:user:}":d[o]=e.user.id;break;default:d[o]=null}break;case"custom":d[o]=n;break;default:d[o]=null}}),"post"===r.method_type)v.post(r.url,s,{headers:d}).then(function(){t.webhookRequesting[r.id]=!1})["catch"](function(){h.warning(i("translate")("Module.ActionButtonWebhookFail")),t.webhookRequesting[r.id]=!1});else if("get"===r.method_type){var u="";for(var g in s)u+=g+"="+s[g]+"&";u.length>0&&(u=u.substring(0,u.length-1)),v.get(r.url+"?"+u).then(function(){t.webhookRequesting[r.id]=!1})["catch"](function(){h.warning(i("translate")("Module.ActionButtonWebhookFail")),t.webhookRequesting[r.id]=!1})}}h.success(i("translate")("Module.ActionButtonWebhookSuccess"))})},t.runMicroflow=function(a,r){var l=t.actionButtons[r];if(0===t.selectedRows.length&&l.record_name)return void h.error(i("translate")("Module.RequiredRecord"));if(t.buttonsParametersData={},t.actionButtonsData={data:{module_id:t.module.id},workflow_id:a,button:l},l.record_name&&(t.actionButtonsData.data.record_name=l.record_name,t.actionButtonsData.data.record_ids=t.selectedRows),l.parameters){t.showMicroflowParameters=!0,t.showScriptParameters=!1,t.buttonParameterNameTitle=e.getLanguageValue(l.languages,"label"),t.buttonsParameters=JSON.parse(l.parameters),t.picklistItems={},angular.forEach(t.buttonsParameters,function(a){(3===a.type||4===a.type)&&v.get(g.apiUrl+"picklist/get/"+a.lowerType).then(function(i){t.picklistItems[a.key]=i.data,e.processLanguage(t.picklistItems)})});var o=angular.element(document.body);_.show({parent:o,templateUrl:"view/app/module/actionButtonsParameterModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})}else f.runMicroflow(a,t.actionButtonsData.data).then(function(t){var a=e.getLanguageValue(l.languages,"message");200===t.status&&"popup"===l.message_type&&a&&h.success(a)})["catch"](function(e){400===e.status&&h.error(i("translate")("Module.RequiredRecord"))})},t.runMicroflowParameters=function(a){a.validate()&&(t.actionButtonsData.data.parameters=t.buttonsParametersData,f.runMicroflow(t.actionButtonsData.workflow_id,t.actionButtonsData.data).then(function(a){var i=e.getLanguageValue(t.actionButtonsData.button.languages,"message");200===a.status&&"popup"===t.actionButtonsData.button.message_type&&i&&h.success(i)})["catch"](function(e){400===e.status&&h.error(i("translate")("Module.RequiredRecord"))}),t.closeLightBox())},t.numberOptionsButtons={format:"{0:n0}",decimals:0},t.recordDelete=function(e,a){var r=_.confirm().title(i("translate")("Common.AreYouSure")).targetEvent(e).ok(i("translate")("Common.Yes")).cancel(i("translate")("Common.No"));_.show(r).then(function(){f.getRecord(t.module.name,a).then(function(e){if(!t.hasPermission(t.type,m.remove,e.data))return void h.error(i("translate")("Common.Forbidden"));var r=f.processRecordSingle(e.data,t.module,t.modulePicklists);t.executeCode=!1,w.run("BeforeDelete","Script",t,r),t.executeCode||f.deleteRecord(t.module.name,a).then(function(){t.refreshGrid(),h.success(i("translate")("Module.DeleteMessage"))})})},function(){t.status="You decided to keep your debt."})},t.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"===e.lookup_type&&!t.record.related_module},t.deleteView=function(a){var r=_.confirm().title(i("translate")("Common.AreYouSure")).targetEvent(a).ok(i("translate")("Common.Yes")).cancel(i("translate")("Common.No"));_.show(r).then(function(){f.deleteView(e.activeView.id).then(function(){h.success({content:i("translate")("View.DeleteSuccess"),timeout:5e3}),t.closeLightBox(),u.remove(t.module.name+"-activeView"),f.getViews(t.module).then(function(a){e.processLanguages(a),t.views=a,t.views.reverse(),e.activeView=i("filter")(t.views,{"default":!0},!0)[0]||t.views[0],e.closeSide("sideModal"),0===t.views.length&&(window.location="#/app/modules/"+t.module.name)})})},function(){t.status="You decided to keep your debt."})},t["export"]=function(){if(!(t.tableParams.total()<1)){var a=!1;try{a=!!new Blob}catch(r){}if(!a)return void h.warning({content:i("translate")("Module.ExportUnsupported"),timeout:8e3});if(t.tableParams.total()>3e3)return void h.warning({content:i("translate")("Module.ExportWarning"),timeout:8e3});var l=e.getLanguageValue(t.module.languages,"label","plural")+"-"+i("date")(new Date,"dd-MM-yyyy")+".xls";t.exporting=!0,f.getCSVData(t,t.type).then(function(e){h.success({content:i("translate")("Module.ExcelExportSuccess"),timeout:5e3}),p.excel(e,l),t.exporting=!1})}},t.showActivityButtons=function(){},t.showDataTransferButtons=function(){},t.openExportDialog=function(){t.pdfCreating=!0,t.loadingModal=!0;var a=function(){var e=angular.element(document.body);_.show({parent:e,templateUrl:"view/app/module/modulePdfModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})};f.getTemplates(t.module.name,"module").then(function(r){if(0===r.data.length)h.warning(e.preview?i("translate")("Setup.Templates.TemplateDefined"):i("translate")("Setup.Templates.TemplateNotFound")),t.pdfCreating=!1;else{var l=r.data;t.quoteTemplates=i("filter")(l,{active:!0},!0),t.isShownWarning=!0;for(var o=0;o<t.quoteTemplates.length;o++){var n=t.quoteTemplates[o];if(n.permissions.length>0){var s=i("filter")(n.permissions,{profile_id:e.user.profile.id},!0)[0];n.isShown="none"===s.type?!1:!0,n.isShown===!0&&(t.isShownWarning=!1)}else n.isShown=!0,t.isShownWarning=!1}t.quoteTemplatesOptions={dataSource:i("filter")(t.quoteTemplates,{isShown:!0},!0),dataTextField:"name",dataValueField:"id"},t.quoteTemplate=t.quoteTemplates[0],t.loadingModal=!1,a()}})["catch"](function(){t.pdfCreating=!1})},t.selectRow=function(e,a){return e.target.checked?(a.selected=!0,t.selectedRows.push(a.id),void t.selectedRecords.push({id:a.id,displayName:a[t.module.primaryField.name]})):(a.selected=!1,t.selectedRows=t.selectedRows.filter(function(e){return e!==a.id}),void(t.isAllSelected=!1))},t.isRowSelected=function(e){return t.selectedRows.filter(function(t){return t===e}).length>0},t.selectGroups=function(e,a,i,r){t.isAllSelected=!1;for(var l=$("#kendo-grid").data("kendoGrid").dataSource.data(),o=0;o<l.length;o++)if(l[o].hasSubgroups){for(var n=0;n<l[o].items.length;n++)for(var s=0;s<l[o].items[n].items.length;s++)if(l[o].items[n].items[s][a]===i)if(e.target.checked)(!l[o].items[n].items[s].freeze||t.user.profile.has_admin_rights)&&(t.selectedRows.includes(l[o].items[n].items[s].id)||(l[o].items[n].items[s].selected=!0,t.selectRow(e,l[o].items[n].items[s])));else{var d=t.selectedRows.indexOf(l[o].items[n].items[s].id);t.selectedRows.splice(d,1),l[o].items[n].items[s].selected=!1}}else for(var n=0;n<l[o].items.length;n++)if(l[o].items[n][a]===i)if(e.target.checked)(!l[o].items[n].freeze||t.user.profile.has_admin_rights)&&(t.selectedRows.includes(l[o].items[n].id)||(l[o].items[n].selected=!0,t.selectRow(e,l[o].items[n])));else{var d=t.selectedRows.indexOf(l[o].items[n].id);t.selectedRows.splice(d,1),l[o].items[n].selected=!1}},t.selectAll=function(e,a){if(t.selectedRows=[],t.isGroupSelected=!1,t.isAllSelected){t.isAllSelected=!1;for(var i=0;i<a.length;i++)if(a[i].items)for(var r=0;r<a[i].items.length;r++)if(a[i].items[r].items)for(var l=0;l<a[i].items[r].items.length;l++)a[i].items[r].items[l].selected&&(a[i].items[r].items[l].selected=!1);else a[i].items[r].selected&&(a[i].items[r].selected=!1);else a[i].selected&&(a[i].selected=!1)}else{t.isAllSelected=!0;for(var i=0;i<a.length;i++)if(a[i].items)for(var r=0;r<a[i].items.length;r++)if(a[i].items[r].items)for(var l=0;l<a[i].items[r].items.length;l++)!a[i].items[r].items[l].freeze||t.user.profile.has_admin_rights?(a[i].items[r].items[l].selected=!0,t.selectRow(e,a[i].items[r].items[l])):a[i].items[r].items[l].selected=!1;else!a[i].items[r].freeze||t.user.profile.has_admin_rights?(a[i].items[r].selected=!0,t.selectRow(e,a[i].items[r])):a[i].items[r].selected=!1;else!a[i].freeze||t.user.profile.has_admin_rights?(a[i].selected=!0,t.selectRow(e,a[i])):a[i].selected=!1}},t.deleteSelecteds=function(e){if(!t.selectedRows||!t.selectedRows.length)return void h.warning(i("translate")("Module.NoRecordSelected"));var a=_.confirm().title(i("translate")("Common.AreYouSure")).textContent(i("translate")("Module.SelectedRecordsCount")+t.selectedRows.length).targetEvent(e).ok(i("translate")("Common.Yes")).cancel(i("translate")("Common.No"));_.show(a).then(function(){f.deleteRecordBulk(t.module.name,t.selectedRows).then(function(){h.success(i("translate")("Module.DeleteMessage")),t.selectedRows=[],t.isAllSelected=!1,t.refreshGrid()})},function(){t.status="You decided to keep your debt."})},t.addCustomField=function(e,t){tinymce.activeEditor.execCommand("mceInsertContent",!1,"{"+t.name+"}")},t.showEMailModal=function(){if(t.executeCode=!1,!e.system.messaging.SystemEMail&&!e.system.messaging.PersonalEMail)return void h.warning(i("translate")("EMail.NoProvider"));if(0==t.selectedRows.length&&!t.isAllSelected)return void h.warning(i("translate")("Module.NoRecordSelected"));w.run("BeforeModalLoad","Script",t);var a=angular.element(document.body);t.executeCode||_.show({parent:a,templateUrl:"view/app/email/bulkEMailModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.showSMSModal=function(){if(!e.system.messaging.SMS)return void h.warning(i("translate")("SMS.NoProvider"));if(0==t.selectedRows.length&&!t.isAllSelected)return void h.warning(i("translate")("Module.NoRecordSelected"));var a=angular.element(document.body);_.show({parent:a,templateUrl:"view/app/sms/bulkSMSModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.collectiveApproval=function(){t.loading=!0;var e=[];angular.forEach(t.selectedRows,function(a){var r=i("filter")(t.grid.dataSource.data(),{id:a},!0)[0];angular.isUndefined(r)||2!==r["process.process_requests.process_status"]&&e.push(r.id)}),e.length>0&&f.approveMultipleProcessRequest(e,t.module.name).then(function(){h.success(e.length+i("translate")("Module.ApprovedRecordCount")),t.loading=!1,t.refresh(!0)})},t.showCollectiveApproval=function(){t.selected=t.selectedRows.length,!t.selectedRows||t.selectedRows.length>0||h.warning(i("translate")("Module.NoRecordSelected"))},t.dropdownHide=function(){var e=angular.element(document.getElementById("dropdownMenu1"));e[0]&&e[0].click(),e[1]&&e[1].click()},t.closeLightBox=function(){_.hide()},t.showLightBox=function(a,r,l,o,n){if(r){t.showImageData={},t.multiSelectAndTagDatas={};var s=n?e.modulus[n.related_module]:t.module,d=o?i("filter")(s.fields,{name:o,deleted:!1})[0]:t.module.primaryField.name;l?t.showImageData={url:a.target.src,title:r[d]||e.getLanguageValue(d.languages,"label"),type:o?"location":"image",map_url:"http://www.google.com/maps/place/"+r[d.name]}:r[o]&&(d=i("filter")(s.fields,{name:o,deleted:!1})[0],t.multiSelectAndTagDatas={array:r[o].split(";"),title:r[d]||e.getLanguageValue(d.languages,"label")}),_.show({contentElement:"#mdLightbox",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!1})}},t.setCurrentLookupField=function(){};var L=function(){if("users"===t.field.lookup_type&&!t.field.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="full_name",t.field.lookupModulePrimaryField=a}if("profiles"===t.field.lookup_type&&!t.field.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="name",t.field.lookupModulePrimaryField=a}if("roles"===t.field.lookup_type&&!t.field.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="label_"+e.user.tenantLanguage,t.field.lookupModulePrimaryField=a}if("relation"===t.field.lookup_type){if(!t.record.related_module)return t.$broadcast("angucomplete-alt:clearInput",t.field.name),s.defer().promise;var r=i("filter")(e.modules,{name:t.record.related_module.value},!0)[0];if(!r)return t.$broadcast("angucomplete-alt:clearInput",t.field.name),s.defer().promise;t.field.lookupModulePrimaryField=i("filter")(r.fields,{primary:!0},!0)[0]}};t.inputReset=function(){if(t.bulkUpdate.value=null,"picklist"===t.field.data_type&&(t.optionId=t.field.picklist_id),"lookup"===t.field.data_type){t.currentLookupField=t.field;var a=new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(a){var i={module:t.currentLookupField.lookup_type,convert:!1};if((!a.data.filter||a.data.filter&&0===a.data.filter.filters.length)&&(a.data.filter={},a.data.filter.filters=[],a.data.filter.logic="and",L()),a.data.filter.filters.length>0){var r=a.data.filter.filters[0].operator;r.contains("_")&&(a.data.filter.filters[0].operator=""!==r?r.replace("_",""):"startswith"),t.lookupSearchValue=a.data.filter.filters[0].value}$.ajax({url:"/api/record/find_custom",contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(i,a.data)),success:function(e){a.success(e)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}});t["lookupOptions"+t.field.id]={dataSource:a,optionLabel:i("translate")("Common.Select"),dataTextField:t.field.lookupModulePrimaryField.name,dataValueField:"id"};var r=angular.element(document.getElementById(t.field.name)).data("kendoDropDownList");r&&(r.setOptions({dataTextField:t.field.lookupModulePrimaryField.name}),r.setDataSource(a))}},t.updateSelected=function(e){if(t.selectedRows&&t.selectedRows.length&&e.validate()){t.submittingModal=!0;var a={},r=t.field.name;a.ids=t.selectedRows;var l={};if(a.records=[],"picklist"!==t.field.data_type&&"multiselect"!==t.field.data_type&&"date"!==t.field.data_type&&"tag"!==t.field.data_type)l[r]=t.bulkUpdate.value;else switch(t.field.data_type){case"picklist":l[r]=t.bulkUpdate.value.id;break;case"multiselect":for(var o=[],n=0;n<t.bulkUpdate.value.length;n++)o.push(t.bulkUpdate.value[n].id);l[r]=o;break;case"tag":for(var s=[],d=0;d<t.bulkUpdate.value.length;d++){var c=i("filter")(t.field.tag.dataSource._view,{id:parseInt(t.bulkUpdate.value[d])},!0)[0];c&&s.push(c.text)}l[r]=s.toString();break;case"date":var u=moment(t.bulkUpdate.value).format().split("+");l[r]=u[0]}a.records.push(l),f.updateRecordBulk(t.module.name,a).then(function(){t.closeLightBox(),h.success(i("translate")("Module.UpdateRecordBulkSuccess")),t.refreshGrid(),t.isAllSelected=!1,t.selectedRows=[],t.selectedRecords=[],t.bulkUpdate.value=null,t.field=null})}},t.openCalendar=function(e){f.openCalendar(e)},t.openExcelTemplate=function(){t.excelCreating=!0,t.hasQuoteTemplateDisplayPermission=f.hasQuoteTemplateDisplayPermission;var a=function(){var e=angular.element(document.body);_.show({parent:e,templateUrl:"view/app/module/moduleExcelModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})};t.quoteTemplates&&(a(),t.quoteTemplate=t.quoteTemplates[0]),f.getTemplates(t.module.name,"excel").then(function(r){if(0===r.data.length)h.warning(e.preview?i("translate")("Setup.Templates.TemplateDefined"):i("translate")("Setup.Templates.TemplateNotFound")),t.excelCreating=!1;else{var l=r.data;t.quoteTemplates=i("filter")(l,{active:!0},!0),t.isShownWarning=!0;for(var o=0;o<t.quoteTemplates.length;o++){var n=t.quoteTemplates[o];"everybody"===n.sharing_type?n.isShown=!0:"me"===n.sharing_type?n.isShown=n.created_by_id===e.user.id:"profile"===n.sharing_type&&(n.isShown=n.profile_list[e.user.profile.id]),n.isShown===!0&&(t.isShownWarning=!1)}t.quoteTemplate=t.quoteTemplates[0],a()}})["catch"](function(){t.excelCreating=!1})},t.UpdateMultiselect=function(a,i){var r=[];return angular.forEach(t.modulePicklists[i.picklist_id],function(t){if(!t.inactive){var i=e.getLanguageValue(t.languages,"label");i&&i.toLowerCase().indexOf(a)>-1&&r.push(t)}}),r},f.getPicklists(t.module,!0).then(function(a){var r=angular.copy(t.sharesOptions);r.dataSource.push({full_name:i("translate")("Common.LoggedInUser"),id:"[me]"}),e.processPicklistLanguages(a),t.modulePicklists=a,t.picklistOptions=[];for(var l=0;l<t.module.fields.length;l++){var o=t.module.fields[l];switch(o.data_type){case"picklist":"picklist"!==o.data_type||o.deleted||(o.picklist=t.modulePicklists[o.picklist_id]);
break;case"multiselect":o.options={dataSource:t.modulePicklists[o.picklist_id],filter:"contains",dataTextField:"languages."+e.globalization.Label+".label",dataValueField:"id",optionLabel:i("translate")("Common.Select")};break;case"tag":var n=new kendo.data.DataSource({transport:{read:{url:"/api/tag/get_tag/"+o.id,type:"GET",dataType:"json",beforeSend:e.beforeSend()}}});n.read(),o.tag={dataSource:n,dataTextField:"text",dataValueField:"id",valuePrimitive:!0,filter:"contains",tagMode:"multiple",change:function(){var e=this.value(),t=this.options.tagMode,a=t;a=e.length<=5?"multiple":"single",a!==t&&(this.value([]),this.setOptions({tagMode:a}),this.value(e))}};break;case"lookup":"users"===o.lookup_type&&(o.dataOptions=r);break;case"date":case"date_time":case"time":}}}),t.showUpdateModal=function(a){if(!t.selectedRows||!t.selectedRows.length)return void h.warning(i("translate")("Module.NoRecordSelected"));if(t.selectedRows.length>100)return void h.warning(i("translate")("Module.RecordLimit"));var r=[],l=function(){if(r=angular.copy(t.module.fields),!t.isAdmin&&!t.hasBulkUpdatePermission){for(var e=0;e<t.module.sections.length;e++){var a=t.module.sections[e];f.hasSectionFullPermission(a)&&f.hasSectionDisplayPermission(a)&&!f.hasSectionReadOnlyPermission(a)||(r=i("filter")(r,function(e){return e.section!==a.name},!0))}for(var e=0;e<r.length;e++)if(!f.hasFieldFullPermission(r[e])||!f.hasFieldDisplayPermission(r[e])||f.hasFieldReadOnlyPermission(r[e])){var l=r.indexOf(r[e]);r.splice(l,1)}}};l(),t.fieldOptions={dataSource:i("filter")(r,function(e){return"number"!==e.data_type||e.deleted?"number_decimal"!==e.data_type||e.deleted?"currency"!==e.data_type||e.deleted||(e=f.setMinMaxValueForField(e),t["currencyOptions"+e.id]={culture:kendo.cultures.current.name,format:"c",decimals:kendo.cultures.current.numberFormat.currency.decimals}):e=f.setMinMaxValueForField(e):(e=f.setMinMaxValueForField(e),t["numberOptions"+e.id]={format:"{0:n0}",decimals:0}),!("checkbox"===e.data_type&&!preview&&"is_sample"===e.name||"image"===e.data_type||"location"===e.data_type||"document"===e.data_type||"number_auto"===e.data_type||"updated_at"===e.name||"updated_by"===e.name||"created_at"===e.name||"created_by"===e.name||!e.validation||e.validation.readonly||e.custom_label)},!0),dataTextField:"languages."+e.globalization.Label+".label",dataValueField:"id",autoBind:!1,filter:"contains",optionLabel:i("translate")("Common.Select")},t.picklistsModule&&f.getPicklists(t.module).then(function(a){e.processPicklistLanguages(a),t.picklistsModule=a}),t.selected=t.selectedRows.length;var o=angular.element(document.body);_.show({parent:o,templateUrl:"view/app/module/bulkUpdateModal.html",clickOutsideToClose:!0,targetEvent:a,scope:t,preserveScope:!0}),angular.element(document).ready(function(){t.bulkUpdateModalForm.options.rules.range=f.rangeRuleForForms()})},t.showDeleteModal=function(){t.selected=t.selectedRows.length},t.showExportDataModal=function(e){t["export"].moduleAllColumn=null;var a=angular.element(document.body);_.show({parent:a,templateUrl:"view/app/module/exportData.html",clickOutsideToClose:!1,targetEvent:e,scope:t,preserveScope:!0})},t.recordProcessDetail=function(a){t.previousApprovers&&delete t.previousApprovers,t.processOrderParam&&delete t.processOrderParam,t.currentApprover&&delete t.currentApprover,t.updateTime&&delete t.updateTime,t.rejectApprover&&delete t.rejectApprover;var r;"dynamicApprover"===r.approver_type&&(t.loadingProcessPopup=!0,t.processStatusParam=a["process.process_requests.process_status"],f.getRecord(t.module.name,a.id).then(function(a){var r,l,o,n,s=a.data,d=[];if(1===s.process_status){if(r=s.process_status_order,1===s.process_status_order)l=i("filter")(e.users,{email:s.custom_approver},!0)[0].full_name;else{l=i("filter")(e.users,{email:s["custom_approver_"+s.process_status_order]},!0)[0].full_name;var c=i("filter")(e.users,{email:s.custom_approver},!0)[0].full_name;d.push(c);for(var u=2;u<s.process_status_order;u++)d.push(i("filter")(e.users,{email:s["custom_approver_"+u]},!0)[0].full_name);t.previousApprovers=d}t.processOrderParam=r,t.currentApprover=l}else if(2===s.process_status){o=s.process_request_updated_at;var c=i("filter")(e.users,{email:s.custom_approver},!0)[0].full_name;d.push(c);for(var u=2;u<s.process_status_order+1;u++)d.push(i("filter")(e.users,{email:s["custom_approver_"+u]},!0)[0].full_name);t.previousApprovers=d,t.updateTime=moment(o).utc().format("DD-MM-YYYY HH:mm")}else 3===s.process_status&&(o=s.process_request_updated_at,n=i("filter")(e.users,{id:s.process_request_updated_by},!0)[0].full_name,t.rejectApprover=n,t.updateTime=moment(o).utc().format("DD-MM-YYYY HH:mm"));t.loadingProcessPopup=!1}))},t.filterModalOpen=function(){e.buildToggler("sideModal","view/app/module/filter-view.html"),setTimeout(function(){var e=$("#available-fields").data("kendoListBox");if(e)for(B=0;e.options.dataSource.length>B;B++)e.options.dataSource[B].name.includes("seperator-")&&e.enable($(".k-item").eq(B),!1)},200)},t.refreshGrid=function(){$("#kendo-grid").data("kendoGrid").dataSource.read()},t.goToRecord=function(e,t,a,i,r){f.goToRecord(e,t,a,i,r)},t.getTagAndMultiDatas=function(e,t){if(e[t]){var a=e[t].split(";");return f.getTagAndMultiDatas(e,a)}},t.getImageStyle=function(e){return e?f.getImageStyle(e,t.module.name):void 0},t.getRatingCount=function(e){return e?f.getRatingCount(e,t.module.name):void 0},t.getLocationUrl=function(e){return e?f.getLocationUrl(e):void 0},t.newGridData={module_id:t.module.id,languages:{},active:!0,sharing_type:"everybody",isNew:!0,filter_logic_json:'{"group":{"logic":"and","filters":[],"level":1}}',"default":!0,view_type:"grid",report_feed:"module",report_type:"",sort_direction:"",filters:[],fields:[{field:t.module.primaryField.name,order:1}]},t.newGridData.languages[e.globalization.Label]={label:"All"+e.getLanguageValue(t.module.languages,"label","plural")},t.openNewDashlet=function(){t.views=[],t.activeView=angular.copy(t.newGridData),t.views.push(t.activeView),t.changeView(t.activeView),t.filterModalOpen()},t.changeTotalCount=function(a){t.totalCount=a,a&&(e.activeView.aggregation={aggregation_type:"count",field:"created_by"},e.activeView.aggregations[0]=e.activeView.aggregation,"summary"===e.activeView.report_type?t.chartFilter():t.widgetFilter())},t.setViewAggregationsFields=function(t){if("report"!==e.activeView.view_type)return!1;var a=[];if("tabular"===e.activeView.report_type){for(var r=0;r<t.length;r++){var l=t[r];if(("numeric"===l.data_type||"number"===l.data_type||"number_auto"===l.data_type||"currency"===l.data_type||"number_decimal"===l.data_type)&&!l.deleted){if(e.activeView.aggregations&&e.activeView.aggregations.length>0)var o=i("filter")(e.activeView.aggregations,{field:l.name})[0];a.push(o?o:{field:l.name,aggregation_type:""})}}e.activeView.aggregations=a}},t.controlRemove=function(e,a){return e.showRemove=t.hasPermission(a?a:t.module.name,m.remove)},t.controlCopy=function(e,a){return e.showCopy=t.hasPermission(a?a:t.module.name,m.write)},t.controlEdit=function(e,a){return e.showEdit=t.hasPermission(a?a:t.module.name,m.modify)},t.validSelectedFields=function(){return"view"===t.activeView.view_type||"tabular"===t.activeView.report_type?t.viewFields.selectedFields.length>=1:!0},t.runScript=function(a){var i=t.actionButtons[a];if(i.parameters){t.showMicroflowParameters=!1,t.showScriptParameters=!0,t.buttonParameterNameTitle=e.getLanguageValue(i.languages,"label"),t.buttonsParameters=JSON.parse(i.parameters),t.picklistItems={},angular.forEach(t.buttonsParameters,function(a){(3===a.type||4===a.type)&&v.get(g.apiUrl+"picklist/get/"+a.lowerType).then(function(i){t.picklistItems[a.key]=i.data,e.processLanguage(t.picklistItems)})});var r=angular.element(document.body);_.show({parent:r,templateUrl:"view/app/module/actionButtonsParameterModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})}else{b.run(t,i.template);var l=e.getLanguageValue(i.languages,"message");"popup"===i.message_type&&l&&h.success(l)}},t.runScriptParameters=function(a){if(a.validate()){t.actionButtonsData.data.parameters=t.buttonsParametersData,b.run(t,t.actionButtonsData.button.template);var i=e.getLanguageValue(t.actionButtonsData.button.languages,"message");"popup"===t.actionButtonsData.button.message_type&&i&&h.success(i),t.closeLightBox()}},t.shortChange=function(e,a){t.reportSummary.fieldName=e,t.reportSummary.reverse=a,t.reportSummary.data=i("orderBy")(t.reportSummary.data,t.reportSummary.fieldName,t.reportSummary.reverse)},t.downloadImg=function(e){if(e){var t=e.split("/"),a=t[t.length-1];v({method:"GET",url:e,responseType:"arraybuffer"}).then(function(e){if(e.data){var t=new Uint8Array(e.data),i=new Blob([t],{type:"application/octet-stream"});saveAs(i,a)}},function(){})}},t.revertFilter=function(){var a=i("filter")(t.shadowViews,{id:e.activeView.id},!0)[0];t.setView(Object.assign({},a))},t.setViewCalendar=function(){return e.activeView.settings&&e.activeView.settings.startdatefield?(t.findRequest={module:t.module.name,take:5e3,filter_logic:e.activeView.filter_logic,filters:e.activeView.filters,convert:!0,fields:[t.primaryField,e.activeView.settings.startdatefield]},t.enddateisAvailable=!1,e.activeView.settings.enddatefield&&"end"!==e.activeView.settings.enddatefield?(t.findRequest.fields.push(e.activeView.settings.enddatefield),t.enddateisAvailable=!0):e.activeView.settings.enddatefield="end",t.calenderDefaultDate=new Date,void(t.calendarOptions={add:function(e){e.preventDefault()},edit:function(e){window.location="#/app/record/"+t.module.name+"?id="+e.event.id,e.preventDefault()},resize:function(t){return"end"===e.activeView.settings.enddatefield&&t.preventDefault(),!1},resizeEnd:function(e){return t.enddateisAvailable||e.preventDefault(),!1},navigate:function(e){return e.date.getMonth()===t.calenderDefaultDate.getMonth()&&t.calenderDefaultDate.getFullYear()===e.date.getFullYear()?!1:void 0},"delete":function(e){e.preventDefault(),t.recordDelete(e,5)},editable:{destroy:!1},views:["day",{type:"month",selected:!0},"week","agenda","timeline"],allDaySlot:!1,dataSource:{transport:{read:function(a){$.ajax({url:"/api/record/find_custom?locale="+M,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest,a.data)),success:function(i){if(t.loading=!1,i.total_count<1)return a.success([]),!1;var r=f.kendoCaleanderDataProcces(i.data,e.activeView.settings,t.primaryField,t.enddateisAvailable);return a.success(r),!0},beforeSend:e.beforeSend()})},update:function(a){var i=a.data,r={id:i.id};r[e.activeView.settings.startdatefield]=i[e.activeView.settings.startdatefield],t.enddateisAvailable&&(r[e.activeView.settings.enddatefield]=i[e.activeView.settings.enddatefield]),f.updateRecord(t.module.name,r).then(function(){a.success(a.data)})}},schema:{model:{id:"id",fields:{id:{type:"number"},start:{type:"date",from:e.activeView.settings.startdatefield},end:{type:"date",from:e.activeView.settings.enddatefield},isAllDay:{type:"boolean"}}}}}})):!1},t.refreshViewCalendar=function(){t.findRequest={module:t.module.name,take:5e3,filter_logic:e.activeView.filter_logic,filters:e.activeView.filters,convert:!0,fields:[t.primaryField,e.activeView.settings.startdatefield]};$("#viewCalendar").data("kendoScheduler").dataSource.read()},t.languageOptions=f.getLanguageOptions(),t.getPicklistValue=function(e,a){if(e&&a){var r=i("filter")(t.module.fields,{name:e},!0)[0];if(r)for(var l=t.modulePicklists[r.picklist_id],o=0;o<l.length;o++){var n=f.getPicklistValue(l[o],a);if(n&&n!==!0)return n}}}}]);