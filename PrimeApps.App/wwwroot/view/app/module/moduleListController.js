"use strict";angular.module("primeapps").controller("ModuleListController",["$rootScope","$scope","$sce","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","exportFile","operations","ModuleService","$http","components","HelpService","mdToast","$mdDialog","ReportsService",function($rootScope,$scope,$sce,$filter,helper,$location,$state,$stateParams,$q,$window,$localStorage,$cache,config,exportFile,operations,ModuleService,$http,components,HelpService,mdToast,$mdDialog,ReportsService){function getFreezeFields(e,o,t){for(var a=$scope.freezeFields||[],i=0;i<e.length;i++){var r=e[i],s=$filter("filter")($scope.module.fields,{name:r.parent_field,deleted:!1},!0)[0];s&&t?a.push(s):s&&getRecordsForFreeze(o,r,s)}return t?a:void 0}function getRecordsForFreeze(e,o,t){for(var a=0;a<e.length;a++)if(!e[a].freeze){var i=ModuleService.processRecordSingle(angular.copy(e[a]),$scope.module,$scope.modulePicklists),r=!1;if(1===i.process_status)return;if(o.values_array&&o.values_array.length>0)for(var s=0;s<o.values_array.length;s++){var c=parseInt(o.values_array[s]);!i[t.name]||c!==i[t.name]&&c!==i[t.name].id||(r=!0)}else"Yes"===i[t.name]&&(r=!0);e[a].freeze=r}}function getFreezeDependencies(){return $filter("filter")($scope.module.dependencies,{dependency_type:"freeze",deleted:!1},!0)}function convertHelper(e){if(null!=e.group&&null!=e.group.filters&&e.group.filters.length>0){$scope.logic="";for(var o=0;o<e.group.filters.length;o++){var t=e.group.filters[o];if(null!=t.group)$scope.logic+=1!==t.group.level&&0!==o?" "+e.group.logic+" ":"",$scope.logic+=convertHelper(t);else if(null!=t.operator&&""!=t.operator){filterIndex++;var t=$scope.processViewFilter(t,filterIndex);newfilters.push(t),$scope.logic+=(0===o?"":" "+e.group.logic+" ")+filterIndex}}}return $scope.logic="("+$scope.logic+")",$scope.logic}$scope.type=$stateParams.type,$scope.operations=operations,$scope.hasPermission=helper.hasPermission,$scope.loading=!0,$scope.module=$scope.modulus[$scope.type],$scope.lookupUser=helper.lookupUser,$scope.lookupProfile=helper.lookupProfile,$scope.lookupRole=helper.lookupRole,$scope.searchingDocuments=!1,$scope.isAdmin=$rootScope.user.profile.has_admin_rights,$scope.hasActionButtonDisplayPermission=ModuleService.hasActionButtonDisplayPermission,$scope.hideDeleteAll=$filter("filter")($rootScope.deleteAllHiddenModules,$scope.type+"|"+$scope.type,!0)[0],$scope.actionButtonDisabled=!1,$scope.showExportButton=!0,$scope.hasViewPermission=!1,$scope.views=[],$scope.chartTypes=ModuleService.getChartsTypes(),$scope.showHelp=!1,$scope.primaryField=$scope.module.primaryField.name,$scope.hasBulkUpdatePermission=!1;var help=$filter("filter")($scope.module.helps,{modal_type:"side_modal",module_type:"module_list"},!0)[0];help&&($scope.showHelp=!0),$scope.goUrl=function(e){window.location=e},$scope.goUrl2=function(e){var o=window.getSelection();0===o.toString().length&&(window.location="#/app/record/"+$scope.module.name+"?id="+e)};var locale=$scope.locale||$scope.language;if($scope.isAdmin||(helper.hasCustomProfilePermission("view")&&($scope.hasViewPermission=!0),helper.hasCustomProfilePermission("record_bulk_update")&&($scope.hasBulkUpdatePermission=!0)),$scope.reportTypeOptions={dataSource:[{value:"summary",title:$filter("translate")("Report.SummaryReport")},{value:"tabular",title:$filter("translate")("Report.ListViewReport")},{value:"single",title:$filter("translate")("Report.Single")}],dataTextField:"title",dataValueField:"value",change:function(){}},!$scope.module)return mdToast.warning($filter("translate")("Common.NotFound")),void $state.go("app.dashboard");if($rootScope.breadcrumblist=[{title:$filter("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:$scope.module["label_"+$scope.language+"_plural"]}],$scope.bulkUpdate={},$scope.filter={},!$scope.hasPermission($scope.type,$scope.operations.read))return mdToast.error($filter("translate")("Common.Forbidden")),void $state.go("app.dashboard");$scope.changeAggregationType=function(){$scope.changeView(!1,!0)},ModuleService.getActionButtons($scope.module.id).then(function(e){$scope.actionButtons=e,$scope.toolbarOptions={resizable:!0,items:[]};for(var o=0;e.length>o;o++)if("Detail"!==e[o].trigger&&"Form"!==e[o].trigger&&"Relation"!==e[o].trigger){if("Scripting"===e[o].action_type&&$scope.hasActionButtonDisplayPermission(e[o])){var t={template:'<md-button class="btn btn-secondary" ng-click="customScripting('+[o]+')" aria-label="'+e[o].name+'" > <i class="'+e[o].icon+'"></i> <span>'+e[o].name+"</span></md-button>",overflowTemplate:'<md-button ng-click="customScripting('+[o]+')"  class="action-dropdown-item"><i class="'+e[o].icon+'"></i><span> '+e[o].name+"</span></md-button>",overflow:"auto"};$scope.toolbarOptions.items.push(t)}if("Webhook"===e[o].action_type&&$scope.hasActionButtonDisplayPermission(e[o])){var t={template:'<md-button class="btn btn-secondary '+e[o].css_class+'"  ng-click="webhookRequest('+o+')"   aria-label="'+e[o].name+'" > <i class="'+e[o].icon+'"></i> <span>'+e[o].name+"</span></md-button>",overflowTemplate:'<md-button ng-click="webhookRequest('+o+')"  class="action-dropdown-item "><i class="'+e[o].icon+'"></i><span> '+e[o].name+" </span></md-button>",overflow:"auto"};$scope.toolbarOptions.items.push(t)}if("ModalFrame"===e[o].action_type&&$scope.hasActionButtonDisplayPermission(e[o])){var t={template:'<md-button class="btn btn-secondary '+e[o].css_class+'"  ng-click="showModuleFrameModal(\''+e[o].url+'\')"   aria-label="'+e[o].name+'" > <i class="'+e[o].icon+'"></i> <span>'+e[o].name+"</span></md-button>",overflowTemplate:"<md-button  ng-click=\"showModuleFrameModal('"+e[o].url+'\')"   class="action-dropdown-item '+e[o].css_class+'"><i class="'+e[o].icon+'"></i><span> '+e[o].name+" </span></md-button>",overflow:"auto"};$scope.toolbarOptions.items.push(t)}}}),$scope.fields=[],$scope.fieldskey=[],$scope.selectedRows=[],$scope.selectedRecords=[],$scope.isAllSelected=!1,$scope.currentUser=ModuleService.processUser($rootScope.user),$scope.currentDayMin=helper.getCurrentDateMin().toISOString(),$scope.currentDayMax=helper.getCurrentDateMax().toISOString(),$scope.currentHour=helper.floorMinutes(new Date),$scope.allFields=[],$scope.numberFields=[],$scope.calculationFields=[],$scope.aggregationTypes=[{label:$filter("translate")("Report.sum"),value:"sum"},{label:$filter("translate")("Report.avg"),value:"avg"},{label:$filter("translate")("Report.min"),value:"min"},{label:$filter("translate")("Report.max"),value:"max"}];for(var i=0;i<$scope.module.fields.length;i++){var field=$scope.module.fields[i];ModuleService.hasFieldDisplayPermission(field)&&($scope.allFields.push(angular.copy(field)),$scope.fieldskey[field.name]=field,("numeric"===field.data_type||"number"===field.data_type||"number_auto"===field.data_type||"currency"===field.data_type||"number_decimal"===field.data_type)&&$scope.numberFields.push(field))}$scope.parseInt=function(e){return parseInt(e)},$scope.colorPaletOptions={columns:6,palette:["#D24D57","#BE90D4","#5AABE3","#87D37C","#F4D03E","#B8BEC2","#DC3023","#8e44ad","#19B5FE","#25A65B","#FFB61E","#959EA4","#C3272B","#763668","#1F4688","#006442","#CA6924","#4D5C66"]},$scope.getUser=function(e){var o=$filter("filter")($rootScope.users,{id:e},!0)[0];return o.full_name?o.full_name:e};var isFreeze=function(e){var o=$scope.freezeDependencies||getFreezeDependencies($scope.module.dependencies);o&&o.length>0&&(getFreezeFields(o,e,!1),$scope.isAllSelected&&($scope.isAllSelected=!1,$scope.selectAll(void 0,e)))};$scope.chartFilter=function(){$rootScope.activeView.aggregation.aggregation_type&&$rootScope.activeView.aggregation.field||($rootScope.activeView.aggregation={aggregation_type:"count",field:"created_by"},$scope.totalCount=!0);var e=$scope.fieldskey[$rootScope.activeView.group_field];if("lookup"===e.data_type)var o=e.name+"."+e.lookup_type+"."+e.lookupModulePrimaryField.name;var t={module_name:$scope.module.name,aggregation_field:$rootScope.activeView.aggregation.aggregation_type+"("+$rootScope.activeView.aggregation.field+")",chart_type:$scope.reportSummary.chart.chart_type,aggregation_type:$rootScope.activeView.aggregation.aggregation_type,group_by:o||$rootScope.activeView.group_field,filters:$rootScope.activeView.filters,filter_logic:$rootScope.activeView.filter_logic};ModuleService.chartFilter(t).then(function(e){$scope.reportSummary.data=e.data,$scope.reportSummary.isNew||$scope.initilazSummaryReport()})},$scope.widgetFilter=function(){$rootScope.activeView.aggregation.aggregation_type&&$rootScope.activeView.aggregation.field||($rootScope.activeView.aggregation={aggregation_type:"count",field:"created_by"},$scope.totalCount=!0);var e=$rootScope.activeView.aggregation.aggregation_type+"("+$rootScope.activeView.aggregation.field+")",o={fields:[e],limit:1,offset:0,filters:$rootScope.activeView.filters};ModuleService.findRecords($scope.module.name,o).then(function(e){$rootScope.activeView.value=e.data[0][$rootScope.activeView.aggregation.aggregation_type]})},$scope.filtera={group:{logic:"and",filters:[],level:1}};var filterIndex=0,newfilters=[];$scope.count=0,$scope.processViewFilter=function(e,o){var t=$scope.fieldskey[e.field],a={field:e.field,operator:e.operator,no:o};switch(t.data_type){case"date_time":case"date":if(e.value&&e.value.name)switch(e.costumeDate){case"costumeN":a.value="today("+e.valueX+e.nextprevdatetype+")";break;case"costumeM":a.value="this_month("+e.valueX+e.nextprevdatetype+")";break;case"costumeW":a.value="this_week("+e.valueX+e.nextprevdatetype+")";break;case"costumeY":a.value="this_year("+e.valueX+e.nextprevdatetype+")";break;default:a.value="costume"===e.value.name?e.costumeDate:e.value.value}break;case"multiselect":for(var i="",r=0;r<e.value.length;r++){var s=e.value[r];i+=s.label[$rootScope.user.tenant_language]+"|"}a.value=i.slice(0,-1);break;case"tag":for(var i="",r=0;r<e.value.length;r++)i+=e.value[r].text+"|";a.value=i.slice(0,-1);break;case"lookup":a.value="users"===t.lookup_type?"[me]"===e.value.id?$rootScope.user.id:e.value.id:e.value;break;case"picklist":a.value=e.value.label[$rootScope.user.tenant_language];break;default:a.value=e.value}return a},$scope.setListGrid=function(e){var o="tabular"===o.report_type?$rootScope.activeView:$scope.newGridData;"report"===e?(o.report_type="tabular",o.view_type="report"):(o.report_type="",o.view_type="grid"),o.aggregations=null,o.aggregation=null,$scope.changeView(o,!1)},$scope.reportTypeChange=function(){switch($rootScope.activeView.report_type){case"tabular":$scope.setListGrid("report");break;case"summary":$scope.reportSummary={config:{dataEmptyMessage:$filter("translate")("Dashboard.ChartEmptyMessage")}},$scope.totalCount=!0,$rootScope.activeView.aggregation={field:"",aggregation_type:""},$scope.reportSummary.config={dataEmptyMessage:$filter("translate")("Dashboard.ChartEmptyMessage")},$scope.reportSummary.isNew=!0,$scope.reportSummary.chart={},$scope.reportSummary.chart.chart_type="column3d",$scope.reportSummary.chart.report_aggregation_field=$rootScope.activeView.aggregation.field,$scope.reportSummary.chart.showPercentValues="1",$scope.reportSummary.chart.showPercentInTooltip="0",$scope.reportSummary.chart.animateClockwise="1",$scope.reportSummary.chart.enableMultiSlicing="0",$scope.reportSummary.chart.isHollow="0",$scope.reportSummary.chart.is2D="0",$scope.reportSummary.chart.formatNumberScale="0",$scope.reportSummary.chart.exportEnabled="1",$scope.reportSummary.chart.exportTargetWindow="_self",$scope.reportSummary.chart.exportFileName=$scope.reportSummary.chart["caption_"+$rootScope.user.language],$scope.reportSummary.chart.exportFormats="PNG="+$filter("translate")("Report.ExportImage")+"|PDF="+$filter("translate")("Report.ExportPdf")+"|XLS=Export Chart Data",$scope.reportSummary.chart.xaxisname="",$scope.reportSummary.chart.yaxisname="";break;case"single":$scope.totalCount=!0,$rootScope.activeView.aggregation={field:"",aggregation_type:""}}},$scope.changeViewType=function(e){"grid"===e?$scope.setListGrid("grid"):"report"===e&&($rootScope.activeView.view_type="report",$rootScope.activeView.report_type="tabular")},$scope.viewFilter=function(){filterIndex=0,newfilters=[];convertHelper($scope.filtera);return $rootScope.activeView.filters=newfilters,$rootScope.activeView.filter_logic=newfilters.length>1?$scope.logic:"","single"===$rootScope.activeView.report_type?($scope.widgetFilter(),!0):"tabular"===$rootScope.activeView.report_type?($scope.widgetFilter(),!0):"summary"===$rootScope.activeView.report_type?($scope.chartFilter(),!0):void $scope.changeView(!1,!0)},$scope.initilazSummaryReport=function(){if($scope.module){if($rootScope.activeView.group_field.indexOf(".")<0){var e=$scope.fieldskey[$rootScope.activeView.group_field];$scope.reportSummary.groupField=e["label_"+$rootScope.language]}else{var o=$rootScope.activeView.group_field.split("."),t=$filter("filter")($rootScope.modules,{name:o[1]},!0)[0],a=$filter("filter")($scope.module.fields,{name:o[0]},!0)[0],i=$filter("filter")(t.fields,{name:o[2]},!0)[0];$scope.reportSummary.groupField=i["label_"+$rootScope.language]+" ("+a["label_"+$rootScope.language]+")"}$rootScope.activeView.aggregations&&angular.isArray($rootScope.activeView.aggregations)&&($rootScope.activeView.aggregation=$rootScope.activeView.aggregations[0]);var r;if($rootScope.activeView.aggregation.field.indexOf(".")<0)r=$scope.fieldskey[$rootScope.activeView.aggregation.field];else{var s=$rootScope.activeView.aggregation.field.split("."),c=$scope.module[s[1]];r=$filter("filter")(c.fields,{name:s[2]},!0)[0]}if(r&&"currency"===r.data_type&&($scope.reportSummary.chart.numberPrefix=$rootScope.currencySymbol),!r||"currency"!==r.data_type&&"number_decimal"!==r.data_type||($scope.reportSummary.chart.forceDecimals="1"),"users"===e.lookup_type)for(var l=0;l<$scope.reportSummary.data.length;l++)$scope.reportSummary.data[l].label=$scope.getUser(parseInt($scope.reportSummary.data[l].label))}$scope.loading=!1},$scope.setSummary=function(e){$scope.reportSummary={config:{dataEmptyMessage:$filter("translate")("Dashboard.ChartEmptyMessage")}},$scope.current={field:"",direction:""},ModuleService.getChart(e.id).then(function(e){$scope.reportSummary=e.data,$scope.reportSummary.config={dataEmptyMessage:$filter("translate")("Dashboard.ChartEmptyMessage")},$scope.reportSummary.chart.showPercentValues="1",$scope.reportSummary.chart.showPercentInTooltip="0",$scope.reportSummary.chart.animateClockwise="1",$scope.reportSummary.chart.enableMultiSlicing="0",$scope.reportSummary.chart.isHollow="0",$scope.reportSummary.chart.is2D="0",$scope.reportSummary.chart.formatNumberScale="0",$scope.reportSummary.chart.exportEnabled="1",$scope.reportSummary.chart.exportTargetWindow="_self",$scope.reportSummary.chart.exportFileName=$scope.reportSummary.chart["caption_"+$rootScope.user.language],$scope.reportSummary.chart.exportFormats="PNG="+$filter("translate")("Report.ExportImage")+"|PDF="+$filter("translate")("Report.ExportPdf")+"|XLS=Export Chart Data",$scope.reportSummary.chart.xaxisname=$scope.reportSummary.chart["xaxisname_"+$rootScope.user.language],$scope.reportSummary.chart.yaxisname=$scope.reportSummary.chart["yaxisname_"+$rootScope.user.language],"tr"===$scope.locale&&($scope.reportSummary.chart.decimalSeparator=",",$scope.reportSummary.chart.thousandSeparator="."),$scope.initilazSummaryReport()})},$scope.setSingleReport=function(e){ModuleService.getWidget(e.id).then(function(e){var o=e.data[0];$rootScope.activeView.color=o.color,$rootScope.activeView.field=o.field,$rootScope.activeView.icon=o.icon,$rootScope.activeView.type=o.type,$rootScope.activeView.value=o.value,$rootScope.activeView.aggregation={field:o.field,aggregation_type:o.type},$scope.loading=!1})},$scope.setView=function(e){if(e){if($state.go("app.moduleList",{type:$scope.module.name,viewid:e.id},{notify:!1}),$rootScope.activeView=e,"report"===e.view_type)switch(("summary"===e.report_type||"single"===e.report_type)&&($scope.totalCount="count"===e.aggregations[0].aggregation_type?!0:!1),e.report_type){case"summary":$scope.setSummary(e);break;case"tabular":if($rootScope.activeView=e,e.aggregations)for(var o=0;o<e.fields.length;o++)if($scope.fieldskey[e.fields[o].field]&&("numeric"===$scope.fieldskey[e.fields[o].field].data_type||"number"===$scope.fieldskey[e.fields[o].field].data_type||"number_auto"===$scope.fieldskey[e.fields[o].field].data_type||"currency"===$scope.fieldskey[e.fields[o].field].data_type||"number_decimal"===$scope.fieldskey[e.fields[o].field].data_type)){var t=$filter("filter")(e.aggregations,{field:e.fields[o].field})[0];t||e.aggregations.push({field:e.fields[o].field})}$scope.changeView($rootScope.activeView);break;case"single":$scope.setSingleReport(e)}else"grid"===e.view_type&&$scope.changeView($rootScope.activeView);"report"===$rootScope.activeView.view_type&&"tabular"===$rootScope.activeView.report_type&&$rootScope.activeView.aggregations&&$rootScope.activeView.aggregations.length>0&&$rootScope.activeView.aggregations[0].aggregation_type&&($rootScope.activeView.aggregation=$rootScope.activeView.aggregations[0]),$rootScope.activeView.filter_logic_json&&($scope.filtera=JSON.parse($rootScope.activeView.filter_logic_json))}},$scope.getProfilisByIds=function(e){for(var o=[],t=0;t<e.length;t++){var a=$filter("filter")($rootScope.profiles,{id:parseInt(e[t])},!0);a&&o.push(a[0])}return o},$scope.saveModal=function(){"profile"===$rootScope.activeView.sharing_type&&($rootScope.activeView.profile=$scope.getProfilisByIds($rootScope.activeView.profile_list));var e=angular.element(document.body);$mdDialog.show({parent:e,templateUrl:"view/app/module/common/viewSaveModal.html",clickOutsideToClose:!1,scope:$scope,preserveScope:!0})},$scope.SaveView=function(e){if($scope.viewFields&&$scope.viewFields.selectedFields){$rootScope.activeView.fields=[];for(var o=0;o<$scope.viewFields.selectedFields.length;o++){var t=$scope.viewFields.selectedFields[o].name;"lookup"!==$scope.viewFields.selectedFields[o].data_type||$scope.viewFields.selectedFields[o].labelExt?$rootScope.activeView.fields.push({field:$scope.viewFields.selectedFields[o].name,order:o}):(t=t.split(".")[0],$rootScope.activeView.fields.push({field:t,order:o}),$rootScope.activeView.fields.push({field:$scope.viewFields.selectedFields[o].name+".primary",order:o}))}}$rootScope.activeView.filter_logic_json=JSON.stringify($scope.filtera);var a={filters:$rootScope.activeView.filters,module_id:$rootScope.activeView.module_id,sharing_type:$rootScope.activeView.sharing_type,label_tr:$scope.viewName||$rootScope.activeView["label_"+$rootScope.language],label_en:$scope.viewName||$rootScope.activeView["label_"+$rootScope.language],filter_logic_json:$rootScope.activeView.filter_logic_json,view_type:$rootScope.activeView.view_type};if("report"===$rootScope.activeView.view_type&&(a.report_type=$rootScope.activeView.report_type),"grid"===$rootScope.activeView.view_type&&(a.fields=$rootScope.activeView.fields,a.report_type=""),"edit"===e&&(a.id=$rootScope.activeView.id),"custom"===$rootScope.activeView.sharing_type){a.shares=[];for(var i=0;i<$rootScope.activeView.shares.length;i++)a.shares.push($rootScope.activeView.shares[i])}if("profile"===$rootScope.activeView.sharing_type){a.profiles=[];for(var o=0;o<$rootScope.activeView.profile.length;o++)a.profiles.push($rootScope.activeView.profile[o].id)}switch($rootScope.activeView.report_type){case"summary":a.group_field=$rootScope.activeView.group_field,a.sort_field=$rootScope.activeView.sort_field,a.sort_direction="asc",a.aggregations=[{field:$rootScope.activeView.aggregation.field,aggregation_type:$rootScope.activeView.aggregation.aggregation_type}],a.chart={type:$scope.reportSummary.chart.chart_type,caption_en:a.label_en,caption_tr:a.label_tr},a.chart["xaxis_name_"+$rootScope.language]=$scope.reportSummary.chart.xaxisname,a.chart["yaxis_name_"+$rootScope.language]=$scope.reportSummary.chart.yaxisname;break;case"tabular":a.fields=$rootScope.activeView.fields,a.aggregations=$rootScope.activeView.aggregations;break;case"single":a.aggregations=[{field:$rootScope.activeView.aggregation.field,aggregation_type:$rootScope.activeView.aggregation.aggregation_type}],a.widget={name_en:$scope.viewName||$rootScope.activeView["label_"+$rootScope.language],name_tr:$scope.viewName||$rootScope.activeView["label_"+$rootScope.language],color:$rootScope.activeView.color,icon:$rootScope.activeView.icon}}ModuleService.saveView(e,a).then(function(){mdToast.success($filter("translate")("View.ViewUpdateSucces")),ModuleService.getViews($scope.module).then(function(e){$scope.views=e,$scope.views.reverse(),$rootScope.activeView=$scope.views[0];var o=$filter("filter")($scope.views,{"default":!0},!0)[0];if(o){var t=$scope.views.indexOf(o);$scope.views[t]=$rootScope.activeView,$scope.views[0]=o}$scope.setView($rootScope.activeView)}),$scope.closeLightBox(),$rootScope.closeSide("sideModal")})},$scope.sharesOptions={dataSource:$scope.users,filter:"contains",dataTextField:"full_name",dataValueField:"id",optionLabel:$filter("translate")("Common.Select")},$scope.profilesOptions={dataSource:$rootScope.profiles,filter:"contains",dataTextField:"name_"+$rootScope.language,dataValueField:"id",optionLabel:$filter("translate")("Common.Select")},$scope.reloadFieldSelection=function(){var e=$("#available-fields").data("kendoListBox"),o=$("#selected-fields").data("kendoListBox");if(e)for($scope.selectedFieldsOptions.dataSource=new kendo.data.DataSource({data:$scope.viewFields.selectedFields}),$scope.availableFieldsOptions.dataSource=new kendo.data.DataSource({data:$scope.preview?$scope.viewFields.availableFields:$filter("filter")($scope.viewFields.availableFields,{name:"!is_sample"},!0)}),e.setDataSource($scope.availableFieldsOptions.dataSource),o.setDataSource($scope.selectedFieldsOptions.dataSource),i=0;e.options.dataSource._data.length>i;i++)e.options.dataSource._data[i].name.includes("seperator-")&&e.enable($(".k-item").eq(i),!1)},$scope.refreshColumn=function(e){setTimeout(function(){var o=$("#selected-fields").data("kendoListBox"),t=$("#available-fields").data("kendoListBox"),a=o.wrapper.find(".k-item"),i=t.wrapper.find(".k-item"),r=[],s=[];$.each(a,function(e,t){r.push(o.dataItem(t))}),$.each(i,function(e,o){s.push(t.dataItem(o))}),$scope.viewFields.selectedFields=r,$scope.viewFields.availableFields=$filter("orderBy")(s,"order"),e||$scope.reloadFieldSelection(),"tabular"===$rootScope.activeView.report_type&&$scope.setViewAggregationsFields($scope.viewFields.selectedFields),$scope.changeView(!1,!0)},200)},$scope.changeView=function(e,o){$scope.selectedRows.length>0&&($scope.isAllSelected=!1,$scope.selectedRows=[]),o||($rootScope.activeView=e,e.filter_logic_json&&($scope.filtera=JSON.parse(e.filter_logic_json)),$scope.viewFields=ModuleService.getViewFields($scope.module,$rootScope.activeView),$scope.availableFieldsOptions={disabled:!0,draggable:!0,dataTextField:"label",dataValueField:"name",connectWith:"selected-fields",dataSource:$scope.preview?$scope.viewFields.availableFields:$filter("filter")($scope.viewFields.availableFields,{name:"!is_sample"},!0),dropSources:["selected-fields"],template:"<div class='list-title'>#:label#</div>",enable:function(){},reorder:function(e){e.preventDefault()},add:function(e){var o=e.dataItems[0];if(o.labelExt){var t=o.name.substring(0,o.name.lastIndexOf(".")),a=$filter("filter")($scope.viewFields.availableFields,function(e){return e.name.indexOf(t)>-1&&e.labelExt===o.labelExt});a&&a.length>0&&(o.parent_id=a[0].parent_id,o.order+=o.parent_id)}else o.parent_id=0;$scope.refreshColumn()}},$scope.selectedFieldsOptions={draggable:!0,dataTextField:"label",dataValueField:"name",template:"<div class='list-title'>#:label# #:labelExt ?? ''#</div>",connectWith:"available-fields",dataSource:$scope.viewFields.selectedFields,dropSources:["available-fields"],reorder:function(){$scope.refreshColumn(!0)},add:function(){$scope.refreshColumn()}},$scope.reloadFieldSelection());var t={moduleName:$scope.module.name};if("report"===$rootScope.activeView.view_type&&$rootScope.activeView.report_type&&(t.report=$rootScope.activeView),$rootScope.isMobile()){for(var a=[],i=$scope.viewFields.selectedFields.length>5?5:$scope.viewFields.selectedFields.length,r=0;i>r;r++)a.push($scope.viewFields.selectedFields[r]);$scope.viewFields.selectedFields=a}var s=ModuleService.generatRowtmpl($scope.viewFields.selectedFields,!1,t);if("report"===$rootScope.activeView.view_type&&"tabular"===$rootScope.activeView.report_type&&$rootScope.activeView.aggregations&&s.columns.map(function(e){for(var o=0;o<$rootScope.activeView.aggregations.length;o++)if(e.field===$rootScope.activeView.aggregations[o].field&&$rootScope.activeView.aggregations[o].aggregation_type){var t=$rootScope.activeView.aggregations[o].aggregation_type+"("+$rootScope.activeView.aggregations[o].field+")";e.footerTemplate="<div> {{ 'Report."+$rootScope.activeView.aggregations[o].aggregation_type+"' | translate  }} : {{ "+t.replace("(","_").replace(")","")+"}} </div>";var a={fields:[t],limit:1,offset:0,filters:$rootScope.activeView.filters};ModuleService.findRecords($scope.module.name,a).then(function(e){$scope[e.config.data.fields[0].replace("(","_").replace(")","")]=e.data[0][[e.config.data.fields[0].split("(")[0]]]})}}),$scope.findRequest={module:$scope.module.name,filter_logic:$rootScope.activeView.filter_logic,filters:$rootScope.activeView.filters,convert:!0,fields:s.requestFields},$scope.freezeDependencies=getFreezeDependencies($scope.module.dependencies),$scope.freezeDependencies&&($scope.freezeFields=getFreezeFields($scope.freezeDependencies,void 0,!0),$scope.freezeFields))for(var c=0;c<$scope.freezeFields.length;c++)$scope.findRequest.fields.indexOf($scope.freezeFields[c].name)<0&&$scope.findRequest.fields.push($scope.freezeFields[c].name);$cache.put($scope.module.name+"-activeView",$rootScope.activeView),$cache.put($scope.module.name+"-activeViewFields",$scope.viewFields.selectedFields),$scope.mainGridOptions={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:function(e){$.ajax({url:"/api/record/find_custom?locale="+locale,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign($scope.findRequest,e.data)),success:function(o){o.data&&o.data.length>0&&isFreeze(o.data),e.success(o),$scope.loading=!1,"report"===$rootScope.activeView.view_type&&o.total_count<1?$(".k-grid-footer").addClass("hide"):$(".k-grid-footer").removeClass("hide")},beforeSend:$rootScope.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},rowTemplate:'<tr ng-click="goUrl2(dataItem.id)">'+s.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt" ng-click="goUrl2(dataItem.id)">'+s.rowtempl+"</tr>",scrollable:!1,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:s.columns}},ModuleService.getViews($scope.module).then(function(e){if($scope.views=e,$scope.views.length<1)return void($scope.loading=!1);$scope.views.reverse();var o=!1,t=$filter("filter")($scope.views,{"default":!0},!0)[0]||$scope.views[0];!$rootScope.activeView||$rootScope.activeView&&$rootScope.activeView.module_id!==$scope.module.id?$rootScope.activeView=t:($rootScope.activeView=$filter("filter")($scope.views,{id:$rootScope.activeView.id},!0)[0],o=!0);var a=-1;if(o?(a=$scope.views.indexOf(t),$scope.views[a]=$scope.views[0],$scope.views[0]=t):(a=$scope.views.indexOf($rootScope.activeView),$scope.views[a]=$scope.views[0],$scope.views[0]=$rootScope.activeView),$stateParams.viewid){$scope.viewid=$stateParams.viewid;for(var i=0;i<$scope.views.length;i++)if($scope.views[i].id===parseInt($scope.viewid))return $rootScope.activeView=$scope.views[i],$rootScope.activeView.filter_logic_json&&($scope.filtera=JSON.parse($rootScope.activeView.filter_logic_json)),$scope.setView($rootScope.activeView),!0}var r=$cache.get($scope.module+"-activeView");return r?($scope.setView(r),!0):void $scope.setView($rootScope.activeView)}),$scope.showModuleFrameModal=function(e){var o,t,a;o="myPop1",t=document.body.offsetWidth-200,a=document.body.offsetHeight-200;var i=screen.width/2-t/2,r=screen.height/2-a/2;window.open(e,o,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+t+", height="+a+", top="+r+", left="+i)},$scope.customScripting=function(index){var action=$scope.actionButtons[index],scope=$scope;eval(action.template)},$scope.trustAsHtml=function(e){return $sce.trustAsHtml(e)},$scope.webhookRequest=function(e){if(!$scope.selectedRows||$scope.selectedRows.length<1)return void mdToast.warning($filter("translate")("Module.NoRecordSelected"));var o=$scope.actionButtons[e],t=o.parameters.split(","),a=o.headers.split(",");$scope.webhookRequesting={},$scope.webhookRequesting[o.id]=!0,ModuleService.getRecords($scope.module.name,$scope.selectedRows).then(function(e){if(!e||!e.data||e.data.length<1)return void mdToast.error($filter("translate")("Common.NotFoundRecord"));for(var i=0;i<e.data.length;i++){var r={},s={"Content-Type":"application/json"},c=ModuleService.processRecordSingle(e.data[i],$scope.module,$scope.modulePicklists);if(angular.forEach(t,function(e){var o=e.split("|"),t=o[0],a=o[1],i=o[2];r[t]=a!==$scope.module.name?c[a]?c[a][i]:null:c[i]?c[i]:null}),angular.forEach(a,function(e){var o=e.split("|"),t=o[0],a=o[1],i=o[2],r=o[3];switch(t){case"module":var l=r;s[i]=a!==$scope.module.name?c[a]?c[a][l]:null:c[l]?c[l]:null;break;case"static":switch(r){case"{:app:}":s[i]=$rootScope.user.app_id;break;case"{:tenant:}":s[i]=$rootScope.user.tenant_id;break;case"{:user:}":s[i]=$rootScope.user.id;break;default:s[i]=null}break;case"custom":s[i]=r;break;default:s[i]=null}}),"post"===o.method_type)$http.post(o.url,r,{headers:s}).then(function(){$scope.webhookRequesting[o.id]=!1})["catch"](function(){mdToast.warning($filter("translate")("Module.ActionButtonWebhookFail")),$scope.webhookRequesting[o.id]=!1});else if("get"===o.method_type){var l="";for(var p in r)l+=p+"="+r[p]+"&";l.length>0&&(l=l.substring(0,l.length-1)),$http.get(o.url+"?"+l).then(function(){$scope.webhookRequesting[o.id]=!1})["catch"](function(){mdToast.warning($filter("translate")("Module.ActionButtonWebhookFail")),$scope.webhookRequesting[o.id]=!1})}}mdToast.success($filter("translate")("Module.ActionButtonWebhookSuccess"))})},$scope.recordDelete=function(e,o){var t=$mdDialog.confirm().title($filter("translate")("Common.AreYouSure")).targetEvent(e).ok($filter("translate")("Common.Yes")).cancel($filter("translate")("Common.No"));$mdDialog.show(t).then(function(){ModuleService.getRecord($scope.module.name,o).then(function(e){if(!$scope.hasPermission($scope.type,operations.modify,e.data))return void mdToast.error($filter("translate")("Common.Forbidden"));var t=ModuleService.processRecordSingle(e.data,$scope.module,$scope.modulePicklists);$scope.executeCode=!1,components.run("BeforeDelete","Script",$scope,t),$scope.executeCode||ModuleService.deleteRecord($scope.module.name,o).then(function(){$scope.refreshGrid(),mdToast.success($filter("translate")("Module.DeleteMessage"))})})},function(){$scope.status="You decided to keep your debt."})},$scope.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"!==e.lookup_type||$scope.record.related_module?!1:!0},$scope.deleteView=function(e){var o=$mdDialog.confirm().title($filter("translate")("Common.AreYouSure")).targetEvent(e).ok($filter("translate")("Common.Yes")).cancel($filter("translate")("Common.No"));$mdDialog.show(o).then(function(){ModuleService.deleteView($rootScope.activeView.id).then(function(){mdToast.success({content:$filter("translate")("View has been deleted successfully"),timeout:5e3}),$scope.closeLightBox(),ModuleService.getViews($scope.module).then(function(e){$scope.views=e,$scope.views.reverse(),$rootScope.closeSide("sideModal")})})},function(){$scope.status="You decided to keep your debt."})},$scope["export"]=function(){if(!($scope.tableParams.total()<1)){var e=!1;try{e=!!new Blob}catch(o){}if(!e)return void mdToast.warning({content:$filter("translate")("Module.ExportUnsupported"),timeout:8e3});
if($scope.tableParams.total()>3e3)return void mdToast.warning({content:$filter("translate")("Module.ExportWarning"),timeout:8e3});var t=$scope.module["label_"+$rootScope.language+"_plural"]+"-"+$filter("date")(new Date,"dd-MM-yyyy")+".xls";$scope.exporting=!0,ModuleService.getCSVData($scope,$scope.type).then(function(e){mdToast.success({content:$filter("translate")("Module.ExcelExportSuccess"),timeout:5e3}),exportFile.excel(e,t),$scope.exporting=!1})}},$scope.showActivityButtons=function(){},$scope.showDataTransferButtons=function(){},$scope.openExportDialog=function(){$scope.pdfCreating=!0,$scope.loadingModal=!0;var e=function(){var e=angular.element(document.body);$mdDialog.show({parent:e,templateUrl:"view/app/module/modulePdfModal.html",clickOutsideToClose:!1,scope:$scope,preserveScope:!0})};ModuleService.getTemplates($scope.module.name,"module").then(function(o){if(0===o.data.length)mdToast.warning($rootScope.preview?$filter("translate")("Setup.Templates.TemplateDefined"):$filter("translate")("Setup.Templates.TemplateNotFound")),$scope.pdfCreating=!1;else{var t=o.data;$scope.quoteTemplates=$filter("filter")(t,{active:!0},!0),$scope.isShownWarning=!0;for(var a=0;a<$scope.quoteTemplates.length;a++){var i=$scope.quoteTemplates[a];if(i.permissions.length>0){var r=$filter("filter")(i.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];i.isShown="none"===r.type?!1:!0,i.isShown===!0&&($scope.isShownWarning=!1)}else i.isShown=!0,$scope.isShownWarning=!1}$scope.quoteTemplatesOptions={dataSource:$filter("filter")($scope.quoteTemplates,{isShown:!0},!0),dataTextField:"name",dataValueField:"id"},$scope.quoteTemplate=$scope.quoteTemplates[0],$scope.loadingModal=!1,e()}})["catch"](function(){$scope.pdfCreating=!1})},$scope.selectRow=function(e,o){return e.target.checked?(o.selected=!0,$scope.selectedRows.push(o.id),void $scope.selectedRecords.push({id:o.id,displayName:o[$scope.module.primaryField.name]})):(o.selected=!1,$scope.selectedRows=$scope.selectedRows.filter(function(e){return e!==o.id}),void($scope.isAllSelected=!1))},$scope.isRowSelected=function(e){return $scope.selectedRows.filter(function(o){return o===e}).length>0},$scope.selectAll=function(e,o){if($scope.selectedRows=[],$scope.isAllSelected){$scope.isAllSelected=!1;for(var t=0;t<o.length;t++)o[t].selected&&(o[t].selected=!1)}else{$scope.isAllSelected=!0;for(var t=0;t<o.length;t++)!o[t].freeze||$scope.user.profile.has_admin_rights?(o[t].selected=!0,$scope.selectedRows.push(o[t].id)):o[t].selected=!1}},$scope.deleteSelecteds=function(e){if(!$scope.selectedRows||!$scope.selectedRows.length)return void mdToast.warning($filter("translate")("Module.NoRecordSelected"));var o=$mdDialog.confirm().title($filter("translate")("Common.AreYouSure")).textContent($filter("translate")("Module.SelectedRecordsCount")+$scope.selectedRows.length).targetEvent(e).ok($filter("translate")("Common.Yes")).cancel($filter("translate")("Common.No"));$mdDialog.show(o).then(function(){ModuleService.deleteRecordBulk($scope.module.name,$scope.selectedRows).then(function(){mdToast.success($filter("translate")("Module.DeleteMessage")),$scope.selectedRows=[],$scope.isAllSelected=!1,$scope.refreshGrid()})},function(){$scope.status="You decided to keep your debt."})},$scope.addCustomField=function(e,o){tinymce.activeEditor.execCommand("mceInsertContent",!1,"{"+o.name+"}")},$scope.showEMailModal=function(){if(!$rootScope.system.messaging.SystemEMail&&!$rootScope.system.messaging.PersonalEMail)return void mdToast.warning($filter("translate")("EMail.NoProvider"));if(0==$scope.selectedRows.length&&!$scope.isAllSelected)return void mdToast.warning($filter("translate")("Module.NoRecordSelected"));var e=angular.element(document.body);$mdDialog.show({parent:e,templateUrl:"view/app/email/bulkEMailModal.html",clickOutsideToClose:!1,scope:$scope,preserveScope:!0})},$scope.showSMSModal=function(){if(!$rootScope.system.messaging.SMS)return void mdToast.warning($filter("translate")("SMS.NoProvider"));if(0==$scope.selectedRows.length&&!$scope.isAllSelected)return void mdToast.warning($filter("translate")("Module.NoRecordSelected"));var e=angular.element(document.body);$mdDialog.show({parent:e,templateUrl:"view/app/sms/bulkSMSModal.html",clickOutsideToClose:!1,scope:$scope,preserveScope:!0})},$scope.collectiveApproval=function(){$scope.loading=!0;var e=[];angular.forEach($scope.selectedRows,function(o){var t=$filter("filter")($scope.tableParams.data,{id:o},!0)[0];angular.isUndefined(t)||2!==t["process.process_requests.process_status"]&&e.push(t.id)}),e.length>0&&ModuleService.approveMultipleProcessRequest(e,$scope.module.name).then(function(){mdToast.success(e.length+$filter("translate")("Module.ApprovedRecordCount")),$scope.loading=!1,$scope.refresh(!0)})},$scope.showCollectiveApproval=function(){$scope.selected=$scope.selectedRows.length,!$scope.selectedRows||$scope.selectedRows.length>0||mdToast.warning($filter("translate")("Module.NoRecordSelected"))},$scope.dropdownHide=function(){var e=angular.element(document.getElementById("dropdownMenu1"));e[0]&&e[0].click(),e[1]&&e[1].click()},$scope.closeLightBox=function(){$mdDialog.hide()},$scope.showLightBox=function(e,o,t,a,i){if(o){$scope.showImageData={},$scope.multiSelectAndTagDatas={};var r=i?$rootScope.modulus[i.related_module]:$scope.module,s=a?$filter("filter")(r.fields,{name:a,deleted:!1})[0]:$scope.module.primaryField.name;t?$scope.showImageData={url:e.target.src,title:o[s]||s["label_"+$scope.language],type:a?"location":"image",map_url:"http://www.google.com/maps/place/"+o[s.name]}:o[a]&&(s=$filter("filter")(r.fields,{name:a,deleted:!1})[0],$scope.multiSelectAndTagDatas={array:o[a].split(";"),title:o[s]||s["label_"+$scope.language]}),$mdDialog.show({contentElement:"#mdLightbox",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!1})}},$scope.setCurrentLookupField=function(){};var prepareLookupSearchField=function(){if("users"===$scope.field.lookup_type&&!$scope.field.lookupModulePrimaryField){var e={};e.data_type="text_single",e.name="full_name",$scope.field.lookupModulePrimaryField=e}if("profiles"===$scope.field.lookup_type&&!$scope.field.lookupModulePrimaryField){var e={};e.data_type="text_single",e.name="name",$scope.field.lookupModulePrimaryField=e}if("roles"===$scope.field.lookup_type&&!$scope.field.lookupModulePrimaryField){var e={};e.data_type="text_single",e.name="label_"+$rootScope.user.tenantLanguage,$scope.field.lookupModulePrimaryField=e}if("relation"===$scope.field.lookup_type){if(!$scope.record.related_module)return $scope.$broadcast("angucomplete-alt:clearInput",$scope.field.name),$q.defer().promise;var o=$filter("filter")($rootScope.modules,{name:$scope.record.related_module.value},!0)[0];if(!o)return $scope.$broadcast("angucomplete-alt:clearInput",$scope.field.name),$q.defer().promise;$scope.field.lookupModulePrimaryField=$filter("filter")(o.fields,{primary:!0},!0)[0]}};$scope.inputReset=function(){if($scope.bulkUpdate.value=null,"picklist"===$scope.field.data_type&&($scope.optionId=$scope.field.picklist_id),"lookup"===$scope.field.data_type){$scope.currentLookupField=$scope.field;var e=new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(e){var o={module:$scope.currentLookupField.lookup_type,convert:!1};if((!e.data.filter||e.data.filter&&0===e.data.filter.filters.length)&&(e.data.filter={},e.data.filter.filters=[],e.data.filter.logic="and",prepareLookupSearchField()),e.data.filter.filters.length>0){var t=e.data.filter.filters[0].operator;t.contains("_")&&(e.data.filter.filters[0].operator=""!==t?t.replace("_",""):"startswith"),$scope.lookupSearchValue=e.data.filter.filters[0].value}$.ajax({url:"/api/record/find_custom",contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(o,e.data)),success:function(o){e.success(o)},beforeSend:$rootScope.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}});$scope["lookupOptions"+$scope.field.id]={dataSource:e,optionLabel:$filter("translate")("Common.Select"),dataTextField:$scope.field.lookupModulePrimaryField.name,dataValueField:"id"};var o=angular.element(document.getElementById($scope.field.name)).data("kendoDropDownList");o&&(o.setOptions({dataTextField:$scope.field.lookupModulePrimaryField.name}),o.setDataSource(e))}},$scope.updateSelected=function(e){if($scope.selectedRows&&$scope.selectedRows.length&&e.validate()){$scope.submittingModal=!0;var o={},t=$scope.field.name;o.ids=$scope.selectedRows;var a={};if(o.records=[],"picklist"!==$scope.field.data_type&&"multiselect"!==$scope.field.data_type&&"date"!==$scope.field.data_type&&"tag"!==$scope.field.data_type)a[t]=$scope.bulkUpdate.value;else switch($scope.field.data_type){case"picklist":a[t]=$scope.bulkUpdate.value.id;break;case"multiselect":for(var i=[],r=0;r<$scope.bulkUpdate.value.length;r++)i.push($scope.bulkUpdate.value[r].id);a[t]=i;break;case"tag":for(var s=[],c=0;c<$scope.bulkUpdate.value.length;c++){var l=$filter("filter")($scope.field.tag.dataSource._view,{id:parseInt($scope.bulkUpdate.value[c])},!0)[0];l&&s.push(l.text)}a[t]=s.toString();break;case"date":var p=moment($scope.bulkUpdate.value).format().split("+");a[t]=p[0]}o.records.push(a),ModuleService.updateRecordBulk($scope.module.name,o).then(function(){$scope.closeLightBox(),mdToast.success($filter("translate")("Module.UpdateRecordBulkSuccess")),$scope.refreshGrid(),$scope.isAllSelected=!1,$scope.selectedRows=[],$scope.selectedRecords=[],$scope.bulkUpdate.value=null})}},$scope.openCalendar=function(e){var o=void 0;switch(e.data_type){case"date":o="kendoDatePicker";break;case"date_time":o="kendoDateTimePicker";break;case"time":o="kendoTimePicker"}if(o){var t=angular.element(document.getElementById(e.name)).data(o);t&&t.open()}},$scope.openExcelTemplate=function(){$scope.excelCreating=!0,$scope.hasQuoteTemplateDisplayPermission=ModuleService.hasQuoteTemplateDisplayPermission;var e=function(){var e=angular.element(document.body);$mdDialog.show({parent:e,templateUrl:"view/app/module/moduleExcelModal.html",clickOutsideToClose:!1,scope:$scope,preserveScope:!0})};$scope.quoteTemplates&&(e(),$scope.quoteTemplate=$scope.quoteTemplates[0]),ModuleService.getTemplates($scope.module.name,"excel").then(function(o){if(0===o.data.length)mdToast.warning($rootScope.preview?$filter("translate")("Setup.Templates.TemplateDefined"):$filter("translate")("Setup.Templates.TemplateNotFound")),$scope.excelCreating=!1;else{var t=o.data;$scope.quoteTemplates=$filter("filter")(t,{active:!0},!0),$scope.isShownWarning=!0;for(var a=0;a<$scope.quoteTemplates.length;a++){var i=$scope.quoteTemplates[a],r=$filter("filter")(i.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];i.isShown="none"===r.type?!1:!0,i.isShown===!0&&($scope.isShownWarning=!1)}$scope.quoteTemplate=$scope.quoteTemplates[0],e()}})["catch"](function(){$scope.excelCreating=!1})},$scope.UpdateMultiselect=function(e,o){var t=[];return angular.forEach($scope.modulePicklists[o.picklist_id],function(o){o.inactive||o.labelStr.toLowerCase().indexOf(e)>-1&&t.push(o)}),t},ModuleService.getPicklists($scope.module,!0).then(function(e){var o=ModuleService.getUsersLookupData($scope.sharesOptions);$scope.modulePicklists=e,$scope.picklistOptions=[];for(var t=0;t<$scope.module.fields.length;t++){var a=$scope.module.fields[t];switch(a.data_type){case"picklist":"picklist"!==a.data_type||a.deleted||(a.picklist=$scope.modulePicklists[a.picklist_id]);break;case"multiselect":a.options={dataSource:$scope.modulePicklists[a.picklist_id],filter:"contains",dataTextField:"label_"+$rootScope.language,dataValueField:"id",optionLabel:$filter("translate")("Common.Select")};break;case"tag":var i=new kendo.data.DataSource({transport:{read:{url:"/api/tag/get_tag/"+a.id,type:"GET",dataType:"json",beforeSend:$rootScope.beforeSend()}}});i.read(),a.tag={dataSource:i,dataTextField:"text",dataValueField:"id",valuePrimitive:!0,filter:"contains",tagMode:"multiple",change:function(){var e=this.value(),o=this.options.tagMode,t=o;t=e.length<=5?"multiple":"single",t!==o&&(this.value([]),this.setOptions({tagMode:t}),this.value(e))}};break;case"lookup":"users"===a.lookup_type&&(a.dataOptions=o);break;case"date":case"date_time":case"time":}}}),$scope.showUpdateModal=function(e){if(!$scope.selectedRows||!$scope.selectedRows.length)return void mdToast.warning($filter("translate")("Module.NoRecordSelected"));if($scope.selectedRows.length>100)return void mdToast.warning($filter("translate")("Module.RecordLimit"));var o=[],t=function(){if(o=angular.copy($scope.module.fields),!$scope.isAdmin&&!$scope.hasBulkUpdatePermission){for(var e=0;e<$scope.module.sections.length;e++){var t=$scope.module.sections[e];ModuleService.hasSectionFullPermission(t)&&ModuleService.hasSectionDisplayPermission(t)&&!ModuleService.hasSectionReadOnlyPermission(t)||(o=$filter("filter")(o,function(e){return e.section!==t.name},!0))}for(var e=0;e<o.length;e++)if(!ModuleService.hasFieldFullPermission(o[e])||!ModuleService.hasFieldDisplayPermission(o[e])||ModuleService.hasFieldReadOnlyPermission(o[e])){var a=o.indexOf(o[e]);o.splice(a,1)}}};t(),$scope.fieldOptions={dataSource:$filter("filter")(o,function(e){return!("checkbox"===e.data_type&&!preview&&"is_sample"===e.name||"image"===e.data_type||"location"===e.data_type||"document"===e.data_type||"number_auto"===e.data_type||"updated_at"===e.name||"updated_by"===e.name||"created_at"===e.name||"created_by"===e.name||!e.validation||e.validation.readonly||e.custom_label)},!0),dataTextField:"label_"+$scope.language,dataValueField:"id",autoBind:!1,filter:"startswith",optionLabel:$filter("translate")("Common.Select")},$scope.selected=$scope.selectedRows.length;var a=angular.element(document.body);$mdDialog.show({parent:a,templateUrl:"view/app/module/bulkUpdateModal.html",clickOutsideToClose:!0,targetEvent:e,scope:$scope,preserveScope:!0})},$scope.showDeleteModal=function(){$scope.selected=$scope.selectedRows.length},$scope.showExportDataModal=function(e){$scope["export"].moduleAllColumn=null;var o=angular.element(document.body);$mdDialog.show({parent:o,templateUrl:"view/app/module/exportData.html",clickOutsideToClose:!1,targetEvent:e,scope:$scope,preserveScope:!0})},$scope.recordProcessDetail=function(e){$scope.previousApprovers&&delete $scope.previousApprovers,$scope.processOrderParam&&delete $scope.processOrderParam,$scope.currentApprover&&delete $scope.currentApprover,$scope.updateTime&&delete $scope.updateTime,$scope.rejectApprover&&delete $scope.rejectApprover;for(var o,t=0;t<$rootScope.approvalProcesses.length;t++){var a=$rootScope.approvalProcesses[t];a.module_id===$scope.module.id&&(o=a)}"dynamicApprover"===o.approver_type&&($scope.loadingProcessPopup=!0,$scope.processStatusParam=e["process.process_requests.process_status"],ModuleService.getRecord($scope.module.name,e.id).then(function(e){var o,t,a,i,r=e.data,s=[];if(1===r.process_status){if(o=r.process_status_order,1===r.process_status_order)t=$filter("filter")($rootScope.users,{email:r.custom_approver},!0)[0].full_name;else{t=$filter("filter")($rootScope.users,{email:r["custom_approver_"+r.process_status_order]},!0)[0].full_name;var c=$filter("filter")($rootScope.users,{email:r.custom_approver},!0)[0].full_name;s.push(c);for(var l=2;l<r.process_status_order;l++)s.push($filter("filter")($rootScope.users,{email:r["custom_approver_"+l]},!0)[0].full_name);$scope.previousApprovers=s}$scope.processOrderParam=o,$scope.currentApprover=t}else if(2===r.process_status){a=r.process_request_updated_at;var c=$filter("filter")($rootScope.users,{email:r.custom_approver},!0)[0].full_name;s.push(c);for(var l=2;l<r.process_status_order+1;l++)s.push($filter("filter")($rootScope.users,{email:r["custom_approver_"+l]},!0)[0].full_name);$scope.previousApprovers=s,$scope.updateTime=moment(a).utc().format("DD-MM-YYYY HH:mm")}else 3===r.process_status&&(a=r.process_request_updated_at,i=$filter("filter")($rootScope.users,{id:r.process_request_updated_by},!0)[0].full_name,$scope.rejectApprover=i,$scope.updateTime=moment(a).utc().format("DD-MM-YYYY HH:mm"));$scope.loadingProcessPopup=!1}))},$scope.filterModalOpen=function(){$rootScope.buildToggler("sideModal","view/app/module/filter-view.html"),setTimeout(function(){var e=$("#available-fields").data("kendoListBox");if(e)for(i=0;e.options.dataSource.length>i;i++)e.options.dataSource[i].name.includes("seperator-")&&e.enable($(".k-item").eq(i),!1)},200)},$scope.refreshGrid=function(){$("#kendo-grid").data("kendoGrid").dataSource.read()},$scope.goToRecord=function(e,o,t,a){ModuleService.goToRecord(e,o,t,a)},$scope.getTagAndMultiDatas=function(e,o){return o?ModuleService.getTagAndMultiDatas(e,o):void 0},$scope.getImageStyle=function(e){return e?ModuleService.getImageStyle(e,$scope.module.name):void 0},$scope.getRatingCount=function(e){return e?ModuleService.getRatingCount(e,$scope.module.name):void 0},$scope.getLocationUrl=function(e){return e?ModuleService.getLocationUrl(e):void 0},$scope.newGridData={module_id:$scope.module.id,label_en:"All "+$scope.module.label_en_plural,label_tr:"TÃ¼m "+$scope.module.label_tr_plural,active:!0,sharing_type:"everybody",isNew:!0,filter_logic_json:'{"group":{"logic":"and","filters":[],"level":1}}',"default":!0,view_type:"grid",report_feed:"module",report_type:"",sort_direction:"",filters:[],fields:[{field:$scope.module.primaryField.name,order:1}]},$scope.openNewDashlet=function(){$scope.views=[],$scope.activeView=angular.copy($scope.newGridData),$scope.views.push($scope.activeView),$scope.changeView($scope.activeView),$scope.filterModalOpen()},$scope.changeTotalCount=function(e){$scope.totalCount=e,e&&($rootScope.activeView.aggregation={aggregation_type:"count",field:"created_by"},$rootScope.activeView.aggregations[0]=$rootScope.activeView.aggregation,"summary"===$rootScope.activeView.report_type?$scope.chartFilter():$scope.widgetFilter())},$scope.setViewAggregationsFields=function(e){if("report"!==$rootScope.activeView.view_type)return!1;var o=[];if("tabular"===$rootScope.activeView.report_type){for(var t=0;t<e.length;t++){var a=e[t];if(("numeric"===a.data_type||"number"===a.data_type||"number_auto"===a.data_type||"currency"===a.data_type||"number_decimal"===a.data_type)&&!a.deleted){var i=$filter("filter")($rootScope.activeView.aggregations,{field:a.name})[0];o.push(i?i:{field:a.name,aggregation_type:""})}}$rootScope.activeView.aggregations=o}},$scope.controlRemove=function(e,o){return e.showRemove=$scope.hasPermission(o?o:$scope.module.name,operations.remove)},$scope.controlCopy=function(e,o){return e.showCopy=$scope.hasPermission(o?o:$scope.module.name,operations.write)},$scope.controlEdit=function(e,o){return e.showEdit=$scope.hasPermission(o?o:$scope.module.name,operations.modify)}}]);