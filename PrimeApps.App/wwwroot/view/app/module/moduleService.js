angular.module("primeapps").factory("ModuleService",["$rootScope","$http","config","$q","$filter","$cache","$window","helper","operations","icons2","dataTypes","operators","yesNo","components",function($rootScope,$http,config,$q,$filter,$cache,$window,helper,operations,icons2,dataTypes,operators,yesNo,components){return{myAccount:function(){return $http.post(config.apiUrl+"User/MyAccount",{})},getAllUser:function(){return $http.get(config.apiUrl+"User/get_all")},getUserLicenseStatus:function(){return $http.post(config.apiUrl+"License/GetUserLicenseStatus",{})},addUser:function(e){return $http.post(config.apiUrl+"User/add_user",e)},deleteUser:function(e,t){return $http.post(config.apiUrl+"Instance/Dismiss",{UserID:e.ID,EMail:e.email,HasAccount:e.hasAccount,InstanceID:t})},getUserEmailControl:function(e){return $http.get(config.apiUrl+"User/get_user_email_control?Email="+e)},get:function(e){return $http.get(config.apiUrl+"template/get/"+e)},create:function(e){return $http.post(config.apiUrl+"module/create",e)},update:function(e,t){return $http.put(config.apiUrl+"module/update/"+t,e)},"delete":function(e){return $http["delete"](config.apiUrl+"module/delete/"+e)},getRecord:function(e,t,a){return $http.get(config.apiUrl+"record/get/"+e+"/"+t,{ignoreNotFound:a})},getRecords:function(e,t){return $http.post(config.apiUrl+"record/get_all_by_id/"+e,t)},findCustom:function(e,t){return $http.post(config.apiUrl+"record/find_custom?locale="+e,t)},findRecords:function(e,t,a){const l=a?"?locale="+a:"";return $http.post(config.apiUrl+"record/find/"+e+l,t)},insertRecord:function(e,t){return $http.post(config.apiUrl+"record/create/"+e+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),t)},runMicroflow:function(e,t){return $http.post(config.apiUrl+"bpm/start_workflow/"+e,t)},updateRecord:function(e,t){return delete t.process_id,delete t.process_status,delete t.process_status_order,delete t.operation_type,delete t.process_request_updated_by,delete t.process_request_updated_at,delete t.freeze,$http.put(config.apiUrl+"record/update/"+e+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),t)},deleteRecord:function(e,t){return $http["delete"](config.apiUrl+"record/delete/"+e+"/"+t)},addRelations:function(e,t,a){return $http.post(config.apiUrl+"record/add_relations/"+e+"/"+t,a)},deleteRelation:function(e,t,a){return $http({method:"DELETE",url:config.apiUrl+"record/delete_relation/"+e+"/"+t,data:a,headers:{"Content-type":"application/json;charset=utf-8"}})},insertRecordBulk:function(e,t){for(var a=0;a<t.length;a++){t[a]}return $http.post(config.apiUrl+"record/create_bulk/"+e,t)},deleteRecordBulk:function(e,t){return $http({method:"DELETE",url:config.apiUrl+"record/delete_bulk/"+e,data:t,headers:{"Content-type":"application/json;charset=utf-8"}})},updateRecordBulk:function(e,t){return delete t.records.shared_users_edit,delete t.records.shared_users,delete t.records.shared_user_groups_edit,delete t.records.shared_user_groups,delete t.records.shared_read,$http({method:"Put",url:config.apiUrl+"record/update_bulk/"+e,data:t,headers:{"Content-type":"application/json;charset=utf-8"}})},findPicklist:function(e){return $http.post(config.apiUrl+"picklist/find",e)},deleteView:function(e){return $http["delete"](config.apiUrl+"view/delete/"+e)},approveMultipleProcessRequest:function(e,t){return $http.put(config.apiUrl+"process_request/approve_multiple_request",{record_ids:e,module_name:t})},sendSMS:function(e,t,a,l,r,i,n){return $http.post(config.apiUrl+"messaging/send_sms",{module_id:e,ids:t,query:a,is_all_selected:l,message:r,phone_field:i,template_id:n.id})},sendEMail:function(e,t,a,l,r,i,n,o,s,d,u,p,c,f,m){return $http.post(config.apiUrl+"messaging/send_email_job",{module_id:e,Ids:t,Query:a,is_all_selected:l,template_id:r.id,e_mail_field:i,Cc:n,Bcc:o,sender_alias:s,provider_type:u,sender_e_mail:d,attachment_container:p,subject:c,attachment_link:f,attachment_name:m})},getTemplates:function(e,t){return $http.get(config.apiUrl+"template/get_all?moduleName="+e+"&type="+t)},processRecordSingle:function(e,t,a){for(var l=0;l<t.fields.length;l++){var r=t.fields[l];this.processRecordField(e,r,a)}return e},formatRecordFieldValues:function(e,t,a){for(var l=0;l<t.fields.length;l++){var r=t.fields[l];this.formatFieldValue(r,e[r.name],a,e,t)}},processRecordMulti:function(e,t,a,l,r,i,n,o,s,d,u,p){for(var c=[],f=function(e,t,a,l,r,i,n,o,s,d,u,p){var c="#/app/record/";if(u.external_link)return void(e.link=p?u.external_link+"?id="+e.value_id+"&back="+a:u.external_link+"?id="+t.id+"&back="+a);var f;if(d&&(f=d.$parent.record),d&&!f&&(f=d.$parent.$parent.record),d&&!f&&(f=d.$parent.$parent.$parent.record),e.primary||"email"===e.data_type||"url"===e.data_type||"lookup"===e.data_type||"location"===e.data_type){if(e.primary&&!e.isJoin)return void(e.link=c+a+"?id="+t.id+(r?"&ptype="+l+"&pid="+r+"&rtab="+i+(f&&f.freeze?"&freeze=true":"")+(o?"&pptype="+n+"&ppid="+o+"&prtab="+s:""):""));if(e.primary&&e.isJoin&&"users"!==e.value_type&&"profiles"!==e.value_type&&"roles"!==e.value_type)return void(e.link=c+e.value_type+"?id="+e.value_id+(r?"&ptype="+l+"&pid="+r+(f&&f.freeze?"&freeze=true":""):"&back="+a));if("lookup"===e.data_type&&"users"!==e.lookup_type&&"profiles"!==e.lookup_type&&"roles"!==e.lookup_type){var m=e.lookup_type;"object"==typeof e.lookup_type&&(m=e.lookup_type.id);var g=t[e.name+"."+m+".id"];return void(e.link=c+m+"?id="+g+(r?"&ptype="+l+"&pid="+r+"&rtab="+i+(f&&f.freeze?"&freeze=true":"")+(o?"&pptype="+n+"&ppid="+o+"&prtab="+s:""):"&back="+a))}"email"===e.data_type&&(e.link="mailto:"+e.value),"url"===e.data_type&&(e.link=e.value),"location"===e.data_type&&(e.link="http://www.google.com/maps/place/"+e.value)}},m=function(e,t,a,l,r){switch(e.data_type){case"text_single":e.mask&&r?t.valueFormatted=$filter("mask")(r,e.mask):(t.value=r,t.valueFormatted=e.valueFormatted);break;case"lookup":if(!a[l])return;t.value=a[l],t.lookup_type="relation"!==e.lookup_type?e.lookup_type:a[e.lookup_relation],t.valueFormatted=t.value;break;case"picklist":case"multiselect":case"tag":case"checkbox":t.value=e.valueFormatted,t.valueFormatted=e.valueFormatted;break;default:t.value=r,t.valueFormatted=e.valueFormatted}},g=0;g<e.length;g++){var v=e[g],_=v;_.id=v.id||v[t.name+"_id"],v["process.process_requests.process_id"]?(_.isProcessItem=!0,_["process.process_requests.process_status"]=v["process.process_requests.process_status"]):_.isProcessItem=!1,_.shared_users_edit=v.shared_users_edit,_.shared_users=v.shared_users,_.shared_user_groups_edit=v.shared_user_groups_edit,_.shared_user_groups=v.shared_user_groups,_.shared_read=v.shared_read,_.fields=[];for(var h=0;h<l.length;h++){var b=l[h],k=angular.copy(t),y=b.field,$=!1;if(b.field.indexOf(".")>-1){var w=b.field.split(".");if(null!=w[3]&&"primary"===w[3])continue;k=$filter("filter")($rootScope.modules,{name:w[1]},!0)[0],y=w[2],$=!0}for(var S=0;S<k.fields.length;S++){var x=k.fields[S];if(y===x.name&&this.hasFieldDisplayPermission(x)){if(null==a){var F=this.getPicklists(t);a=F.$$state.value}this.processRecordsField(v,x,!0),this.formatFieldValue(x,v[b.field],a,v,t);var R={data_type:x.data_type,name:x.name,primary:x.primary,value:"",isJoin:$,isHtml:x.multiline_type_use_html,image_size_list:x.image_size_list};"rating"===x.data_type&&(R.max=x.validation.min_length);for(var I in v)if(v.hasOwnProperty(I)){var L=v[I],M=!1;if(I.indexOf(".")>-1){var C=I.split(".");$&&x.primary&&(R.value_id=v[C[0]+"."+C[1]+".id"],R.value_type=C[1],M=!0),I=C[2]}if(I!==x.name)continue;m(x,R,v,I,L),f(R,v,r,n,i,o,s,d,u,p,x,M)}R.order=b.order||x.order,_[x.name+"_data"]=R}}}c.push(_)}return c},processRecordField:function(e,t,a){var l=this,r=t.name;switch(t.data_type){case"lookup":case"multiselect_lookup":var i={},n=null===e[r+".id"];void 0===e[r+".id"]&&(t.inline_edit=!1,n=!0);for(var o in e)if(e.hasOwnProperty(o)){var s=e[o];if(o.startsWith(r+".")){if(!n){var d=o.split(".");if(d[0]!==t.name)continue;i[d[1]]="languages"===d[1]?JSON.parse(s):s}delete e[o]}}if(n)return;if("users"===t.lookup_type)i.primary_value=i.full_name;else if("profiles"===t.lookup_type)i.primary_value=$rootScope.getLanguageValue(i.languages,"name");else if("roles"===t.lookup_type)i.primary_value=$rootScope.getLanguageValue(i.languages,"label");else if("relation"===t.lookup_type)i=e[t.lookup_relation]&&e.related_to?e.related_to:null;else{var u=$filter("filter")($rootScope.modules,{name:t.lookup_type},!0)[0],p=$filter("filter")(u.fields,{primary:!0,deleted:!1},!0)[0];i.primary_value=i[p.name]}e[r]=i;break;case"picklist":e[r]=$filter("filter")(a[t.picklist_id],function(t){return!t.inactive&&l.getPicklistValue(t,e[r])},!0)[0];break;case"multiselect":var c=[];if(e[r]){angular.isArray(e[r])||(e[r]=e[r].split(";"));for(var f=0;f<e[r].length;f++){const m=e[r][f],g=$filter("filter")(a[t.picklist_id],function(e){return!e.inactive&&l.getPicklistValue(e,m)},!0)[0];g&&c.push(g.id)}}e[r]=c;break;case"date":case"date_time":case"time":if(void 0===e[r]||null===e[r]||!e[r].length)return;e[r]=new Date("date"===t.data_type?new Date(e[r]).toUTCString().substr(0,25):e[r]),e[r+"str"]="time"===t.data_type?kendo.toString(new Date(e[r]),"t"):kendo.toString(new Date(e[r]),"g");break;case"tag":void 0!==e[r]&&null!==e[r]&&e[r].length||(e[r]=[])}},processRecordsField:function(e,t){var a=t.name;switch(t.data_type){case"lookup":case"multiselect_lookup":var l=$filter("filter")($rootScope.modules,{name:t.lookup_type},!0)[0];if(null===l||void 0===l)return;var r=$filter("filter")(l.fields,{primary:!0},!0)[0];e[a]=e[t.name+"."+t.lookup_type+"."+r.name+".primary"];break;case"date":case"date_time":case"time":if(void 0===e[a]||null===e[a]||!e[a].length)return;e[a]=new Date(e[a])}},processUser:function(e){var t={};return t.id=e.id,t.primary_value=e.first_name+" "+e.last_name,t.email=e.email,t},processRecords:function(e,t,a){for(var l=[],r=angular.copy(e),i=0;i<r.length;i++){for(var n=r[i],o=0;o<t.fields.length;o++){var s=t.fields[o];this.processRecordsField(n,s,a),this.formatFieldValue(s,n[s.name],a,n,t)}l.push(n)}return l},formatFieldValue:function(e,t,a,l,r){if(e.valueFormatted="",void 0!==t&&null!==t)switch(e.data_type){case"number_decimal":e.valueFormatted=$filter("number")(t,e.decimal_places);break;case"number_auto":var i=t.toString();e.auto_number_prefix&&(i=e.auto_number_prefix+i),e.auto_number_suffix&&(i+=e.auto_number_suffix),e.valueFormatted=i;break;case"currency":var n;if(l&&l.currency)if(angular.isObject(l.currency))n=l.currency.value;else{var o=$filter("filter")(r.fields,{name:"currency"},!0)[0],s=$filter("filter")(a[o.picklist_id],{labelStr:l.currency})[0];s&&s.value&&(n=s.value)}e.valueFormatted=$filter("currency")(t,n||e.currency_symbol||$rootScope.currencySymbol,e.decimal_places);break;case"date":e.valueFormatted=$filter("date")(t,"shortDate");break;case"date_time":e.valueFormatted=$filter("date")(t,"short");break;case"time":e.valueFormatted=$filter("date")(t,"shortTime");break;case"picklist":if(angular.isObject(t))e.valueFormatted=$rootScope.getLanguageValue(t.languages,"label");else{var d=$filter("filter")(a[e.picklist_id],{labelStr:t},!0)[0];e.valueFormatted=d?$rootScope.getLanguageValue(d.languages,"label"):t}break;case"multiselect":for(var u=0;u<t.length;u++){var p=t[u];if(angular.isObject(p))e.valueFormatted+=(p.label?p.label[$rootScope.language]:"")+"; ";else{var d=$filter("filter")(a[e.picklist_id],{labelStr:p},!0)[0];e.valueFormatted+=(d?d.label[$rootScope.language]:p)+"; "}}e.valueFormatted=e.valueFormatted.slice(0,-2);break;case"tag":for(var u=0;u<t.length;u++){var p=t[u];e.valueFormatted+=angular.isObject(p)?" "+p:" "+p+";"}break;case"checkbox":const c=$filter("filter")(a.yes_no,{system_code:t.toString()})[0];c&&(e.valueFormatted=$rootScope.getLanguageValue(c.languages,"label"));break;case"lookup":e.valueFormatted=angular.isObject(t)?t[e.lookupModulePrimaryField.name]:t;break;default:e.valueFormatted=t}},getPicklists:function(e,t){var a=$q.defer(),l=angular.copy(e.fields),r={},i=[];if(t)for(var n=0;n<e.fields.length;n++){var o=e.fields[n];if(("lookup"===o.data_type||"multiselect_lookup"===o.data_type)&&"users"!==o.lookup_type&&"profiles"!==o.lookup_type&&"roles"!==o.lookup_type&&"relation"!==o.lookup_type){var s=$filter("filter")($rootScope.modules,{name:o.lookup_type},!0)[0];if(!s)continue;for(var d=0;d<s.fields.length;d++){var u=s.fields[d];("picklist"===u.data_type||"multiselect"===u.data_type)&&l.push(u)}}}for(var p=function(t,a){if(e.dependencies&&e.dependencies.length>0){var l=$filter("filter")(e.dependencies,{child_field:a.name},!0)[0];if(l&&l.deleted!==!0&&"list_field"===l.dependency_type)for(var r=0;r<t.length;r++){var i=t[r];i.hidden=!0}}},c=0;c<l.length;c++){var f=l[c];if(f.picklist_id){var m=$cache.get("picklist_"+f.picklist_id);if(9e5===f.picklist_id){if(m){r[f.picklist_id]=m;continue}for(var g=[],v=0;v<$rootScope.modules.length;v++){var _=$rootScope.modules[v];if(_.display&&helper.hasPermission(_.name,operations.read)){var h={};h.id=parseInt(_.id)+9e5,h.type=9e5,h.system_code=_.name,h.order=_.order,h.label=$rootScope.getLanguageValue(_.languages,"label","singular"),h.labelStr=$rootScope.getLanguageValue(_.languages,"label","singular"),h.value=_.name,h.languages={},h.languages[$rootScope.globalization.Label]={label:$rootScope.getLanguageValue(_.languages,"label")},g.push(h)}}g=$filter("orderBy")(g,"order"),r[9e5]=g,$cache.put("picklist_"+9e5,g);continue}m?(m=$filter("orderBy")(m,"label"),f.picklist_sortorder&&!f.deleted&&(m=$filter("orderBy")(m,f.picklist_sortorder)),p(m,f),r[f.picklist_id]=m):i.push(f.picklist_id)}}var b=$cache.get("picklist_activity_type");b&&(r.activity_type=b);var k=$cache.get("picklist_yes_no");return r.yes_no=k?k:$rootScope.yesNo,i.length<=0?(a.resolve(r),a.promise):(i=i.getUnique(),this.findPicklist(i).then(function(t){if(!t.data)return a.resolve(r),a.promise;for(var n=0;n<l.length;n++){var o=l[n];if(o.picklist_id&&!(i.indexOf(o.picklist_id)<0)){$rootScope.processLanguages(t.data);var s=helper.mergePicklists(t.data);if(r[o.picklist_id]=$filter("filter")(s,{type:o.picklist_id},!0),r[o.picklist_id]=$filter("orderBy")(r[o.picklist_id],"label"),o.picklist_sortorder&&!o.deleted&&(r[o.picklist_id]=$filter("orderBy")(r[o.picklist_id],o.picklist_sortorder)),e.dependencies&&e.dependencies.length>0){var d=$filter("filter")(e.dependencies,{child_field:o.name},!0)[0];if(d&&1!=d.deleted&&"list_field"===d.dependency_type)for(var u=0;u<r[o.picklist_id].length;u++){var c=r[o.picklist_id][u];c.hidden=!0}}p(r[o.picklist_id],o),$cache.put("picklist_"+o.picklist_id,r[o.picklist_id])}}a.resolve(r)})["catch"](function(e){a.reject(e.data)}),a.promise)},moduleFieldsConvertByKey:function(e){for(var t=[],a=0;a<e.length;a++)t[e[a].name]=e[a];return t},lookup:function(e,t,a,l,r,i){var n=$q.defer(),o=t.lookup_type,s=this,d="lookup"===t.data_type&&t.show_as_dropdown;if("text_single"!==t.lookupModulePrimaryField.data_type&&"picklist"!==t.lookupModulePrimaryField.data_type&&"email"!=t.lookupModulePrimaryField.data_type&&"number"!==t.lookupModulePrimaryField.data_type&&"number_auto"!==t.lookupModulePrimaryField.data_type)return n.resolve([]),n.promise;if("relation"===o&&(o=void 0!==a[t.lookup_relation]?a[t.lookup_relation].value:null),!o)return n.resolve([]),n.promise;if(!e&&!d)return n.resolve([]),n.promise;var u=$filter("filter")($rootScope.modules,{name:o},!0)[0],p=[];if(p.push(t.lookupModulePrimaryField.name),l)for(var c=0;c<l.length;c++){var f=l[c];f!==t.lookupModulePrimaryField.name&&"id"!==f&&p.push(f)}var m=[];if("number"!==t.lookupModulePrimaryField.data_type&&"number_auto"!==t.lookupModulePrimaryField.data_type)if(r)m.push({field:t.lookupModulePrimaryField.name,operator:"is",value:e,no:1});else switch(t.lookup_search_type){case"contains":m.push({field:t.lookupModulePrimaryField.name,operator:"contains",value:e,no:1});break;case"starts_with":m.push({field:t.lookupModulePrimaryField.name,operator:"starts_with",value:e,no:1});break;default:m.push({field:t.lookupModulePrimaryField.name,operator:"starts_with",value:e,no:1})}else m.push({field:t.lookupModulePrimaryField.name,operator:"equals",value:parseInt(e),no:1});var g={fields:p,filters:m,sort_field:t.lookupModulePrimaryField.name,sort_direction:"asc",limit:1e3,offset:0};d&&(g.filters=[],g.limit=1e5);var v=g.filters.length;("users"===u.name||$rootScope.branchAvailable&&"branches"===o)&&g.filters.push({field:"is_active",operator:"equals",value:!0,no:v+1}),"users"===u.name&&g.filters.push({field:"email",operator:"not_contain",value:"integration_",no:v+1});var _=s.moduleFieldsConvertByKey(u.fields);if(t.filters)for(var h=g.filters.length,b=0;b<t.filters.length;b++){var k=t.filters[b];h++;var y=null,$=k.value.match(/^\W+(.+)]/i);if(null!==$&&"users"!==t.lookup_type&&"profiles"!==t.lookup_type&&"roles"!==t.lookup_type){var w=$[1].split(".");1===w.length&&a[w[0]]&&(y=a[w[0]]),2===w.length&&a[w[0]]&&(y=a[w[0]][w[1]]),3===w.length&&a[w[0]]&&(y=a[w[0]][w[1]][w[2]]),null!=y&&(g.filters.push({field:k.filter_field,operator:k.operator,value:y,no:h}),g.fields.push(k.filter_field))}else{var S=_[k.filter_field];switch(S.data_type){case"multiselect":case"tag":y=k.value.split("|");break;default:y=k.value}g.filters.push({field:k.filter_field,operator:k.operator,value:y,no:h}),g.fields.push(k.filter_field)}}if(i)for(var x=0;x<i.length;x++){var F=i[x];F.no=g.filters.length+1,g.filters.push(F)}return this.findRecords(o,g).then(function(e){if(!e.data||!e.data.length)return n.resolve([]),n.promise;var a=[];if(l)s.getPicklists(u).then(function(l){for(var r=0;r<e.data.length;r++){var i=e.data[r],o=angular.copy(i);o=s.processRecordSingle(o,u,l),o.primary_value=i[t.lookupModulePrimaryField.name],a.push(o),n.resolve(a)}});else for(var r=0;r<e.data.length;r++){var i=e.data[r];"profiles"===o&&1===i.id&&(i.name="tr"===$rootScope.user.tenant_language?"Sistem YÃ¶neticisi":"Administrator");var d=angular.copy(i);d.primary_value=i[t.lookupModulePrimaryField.name],a.push(d),n.resolve(a)}})["catch"](function(e){n.reject(e.data)}),n.promise},fieldLookupFilters:function(e,t,a,l){var r={};r={is:"is",is_not:"is_not",equals:"eq",not_equal:"neq",contains:"contains",not_contain:"doesnotcontain",starts_with:"startswith",ends_with:"endswith",empty:"isempty",not_empty:"isnotempty",greater:"gt",greater_equal:"gte",less:"lt",less_equal:"lte",not_in:"not_in"};var i=[],n=e.lookup_type,o=$rootScope.modulus[n],s=this.moduleFieldsConvertByKey(o.fields);if(l.fields||(l.fields=[]),a&&e.filters&&e.filters.length>0){for(var d=0,u=0;u<e.filters.length;u++){var p=e.filters[u],c=$filter("filter")(a,{field:p.filter_field,operator:p.operator,value:p.value},!0)[0];if(c){var f=a.indexOf(c);a.splice(f,1)}d++;var m=p.value,g=p.value.match(/^\W+(.+)]/i);if(null!==g&&"users"!==e.lookup_type&&"profiles"!==e.lookup_type&&"roles"!==e.lookup_type){var v=g[1].split(".");1===v.length&&t[v[0]]?m=this.processFilterField(p.filter_field,t[v[0]]):2===v.length&&t[v[0]]?m=this.processFilterField(p.filter_field,t[v[0]][v[1]]):3===v.length&&t[v[0]]?m=this.processFilterField(p.filter_field,t[v[0]][v[1]][v[2]]):m.startsWith("[")&&m.endsWith("]")&&(m=null),null!=m&&(i.push({field:p.filter_field,operator:r[p.operator]||p.operator,value:m,no:d}),l.fields.push(p.filter_field))}else{var _=s[p.filter_field];if(_)switch(_.data_type){case"multiselect":case"tag":m=p.value.split("|");break;default:m=p.value}i.push({field:p.filter_field,operator:r[p.operator]||p.operator,value:m,no:d}),l.fields.push(p.filter_field)}}return a.length>0&&(angular.forEach(a,function(e){e.operator=r[e.operator]}),i=i.concat(a)),i}return a},prepareRecord:function(e,t,a){function l(e){var t=document.createElement("div");return t.innerHTML=e,t.innerHTML.toString()}var r=angular.copy(e),i=angular.copy(a);if(a)for(var n=0;n<t.dependencies.length;n++){var o=t.dependencies[n];if("display"===o.dependency_type&&!o.deleted){const s=$filter("filter")(t.fields,{name:o.parent_field,deleted:!1},!0)[0];if(!angular.equals(e[o.parent_field],a[o.parent_field]))if(o.values_array&&o.values_array.length>0){for(var d=!0,u=0;u<o.values_array.length;u++){var p=o.values_array[u];if(Array.isArray(e[o.parent_field]))for(var c=0;c<e[o.parent_field].length;c++){var f=e[o.parent_field][c];f.toString()===p&&(d=!1)}else e[o.parent_field]&&(angular.isObject(e[o.parent_field])&&e[o.parent_field].id.toString()===p||s&&"checkbox"===s.data_type)&&(d=!1)}d&&o.child_field&&(r[o.child_field]=null)}else!e[o.parent_field]&&o.child_field&&(r[o.child_field]=null)}}for(var n=0;n<t.fields.length;n++){var s=t.fields[n];if("string"==typeof r[s.name]&&""===r[s.name].trim()&&(r[s.name]=void 0),a||!angular.isUndefined(r[s.name]))if(a&&angular.isUndefined(a[s.name])&&angular.isUndefined(r[s.name]))delete r[s.name];else if("checkbox"===s.data_type&&null===r[s.name]&&a[s.name]&&(r[s.name]=!1),s.deleted)delete r[s.name];else if("tag"===s.data_type&&(angular.isArray(r[s.name])&&r[s.name].length<1||null===r[s.name])&&(a?angular.isArray(a[s.name])&&a[s.name].length<1||null===a[s.name]:!1))delete r[s.name];else if(void 0!==r[s.name]&&null!==r[s.name]){switch(i||(i={}),s.data_type){case"number":r[s.name]=parseInt(r[s.name]),i[s.name]=i[s.name]?parseInt(i[s.name]):null;break;case"number_decimal":break;case"checkbox":(null===r[s.name]||void 0===r[s.name])&&(r[s.name]=!1);break;case"currency":r[s.name]=parseFloat(r[s.name]),i[s.name]=i[s.name]?parseFloat(i[s.name]):null;break;case"date":var m=moment(r[s.name]).format().split("+"),g=moment(i[s.name]).format().split("+");r[s.name]=m[0],i[s.name]=i[s.name]?g[0]:null;break;case"picklist":case"lookup":r[s.name]=r[s.name].id,i[s.name]=i[s.name]?i[s.name].id:null;break;case"multiselect_lookup":for(var v=[],_=0;_<r[s.name].length;_++)r[s.name][_]&&v.push(r[s.name][_].id);if(r[s.name]=angular.copy(v),i[s.name]){v=[];for(var _=0;_<i[s.name].length;_++)i[s.name][_]&&v.push(i[s.name][_].id);i[s.name]=angular.copy(v)}break;case"text_multi":var h=r[s.name];if(s.multiline_type_use_html===!0){var b=l(h);r[s.name]=b}break;case"multiselect":for(var k=[],y=[],u=0;u<r[s.name].length;u++){var $=r[s.name][u];k.push($)}if(i[s.name])for(var c=0;c<i[s.name].length;c++){var w=i[s.name][c];y.push(w)}r[s.name]=k&&k.length?k:null,i[s.name]=y&&y.length?y:null;break;case"tag":r[s.name]=r[s.name].toString()}a&&angular.equals(i[s.name],r[s.name])&&delete r[s.name]}else r[s.name]=null}if(r.shared_read&&r.shared_read.length){r.shared_users=[],r.shared_user_groups=[];for(var S=0;S<r.shared_read.length;S++){var x=r.shared_read[S];"user"===x.type&&r.shared_users.push(x.id),"group"===x.type&&r.shared_user_groups.push(x.id)}r.shared_users.length||(r.shared_users=null),r.shared_user_groups.length||(r.shared_user_groups=null),delete r.shared_read}else r.shared_users=null,r.shared_user_groups=null,delete r.shared_read;if(r.shared_edit&&r.shared_edit.length){r.shared_users_edit=[],r.shared_user_groups_edit=[];for(var F=0;F<r.shared_edit.length;F++){var R=r.shared_edit[F];"user"===R.type&&r.shared_users_edit.push(R.id),"group"===R.type&&r.shared_user_groups_edit.push(R.id)}r.shared_users_edit.length||(r.shared_users_edit=null),r.shared_user_groups_edit.length||(r.shared_user_groups_edit=null),delete r.shared_edit}else r.shared_users_edit=null,r.shared_user_groups_edit=null,delete r.shared_edit;return r},prepareRecordBulk:function(e,t){for(var a=this,l=[],r=0;r<e.length;r++){var i=e[r],n=a.prepareRecord(i,t);l.push(n)}return l},calculate:function(field,module,record){if(module.calculations){var calculation=$filter("filter")(module.calculations,{field_1:field.name},!0)[0];if(calculation||(calculation=$filter("filter")(module.calculations,{field_2:field.name},!0)[0]),calculation){var calculations=$filter("filter")(module.calculations,{result_field:calculation.result_field},!0);calculations=$filter("orderBy")(calculations,"order");for(var result=0,resultField="",i=0;i<calculations.length;i++){var calculation=calculations[i];result=eval((result||record[calculation.field_1]||0)+calculation.operator+(record[calculation.field_2]||calculation.custom_value||0)),resultField=calculation.result_field}record[resultField]=result||0}}},setExpressionValueElementType:function(e,t,a){switch(t.data_type){case"picklist":if(!e)break;e=e.labelStr;break;case"multiselect":if(!e)break;for(var l=$filter("filter")($rootScope.moduleRecordData.module.fields,{name:t.name},!0)[0],r=$rootScope.moduleRecordData.picklist[l.picklist_id],i="",n=e.length,o=0;n>o;o++){var s=$filter("filter")(r,{id:e[o]},!0)[0];i+=$rootScope.getLanguageValue(s.languages,"label"),o+1!==n&&(i+=", ")}e=i;break;case"date":case"date_time":case"time":e=a[t.name+"str"]}return e},expressionGetValue:function(e,t,a,l){var r="";switch(a.type){case"field":if(a.is_main===!0&&a.isLookup===!0){var i=a.name.split(".");if(!i)return;var n=i[0],o=i[1],s=i[i.length-1];if("created_by"===n){var d=e.created_by?e.created_by.full_name:e.owner.full_name;r+='"'+d+'"'}else if("updated_by"===n){var d=e.updated_by?e.updated_by.full_name:e.owner.full_name;r+='"'+d+'"'}else if("owner"===n)r+='"'+e.owner.full_name+'"';else if(e[n]&&e[n].id){var u="";"users"!==o&&"roles"!==o&&"profiles"!==o?u=e[n][s]:"users"===o?u=e[n].full_name:e[n].languages&&(u=$rootScope.getLanguageValue(e[a.name].languages,"label")||$rootScope.getLanguageValue(e[a.name].languages,"name")),r+="number"==typeof u?u:'"'+u+'"'}else e[a.name]&&e[a.name].id?("users"!==o&&"roles"!==o&&"profiles"!==o?u=e[a.name].name:"users"===o?u=e[a.name].full_name:e[a.name].languages&&(u=$rootScope.getLanguageValue(e[a.name].languages,"label")||$rootScope.getLanguageValue(e[a.name].languages,"name")),r+="number"==typeof u?u:'"'+u+'"'):r+='" "'}else if(a.is_main===!0&&a.isLookup===!1){var d=e[a.name];switch(t.data_type){case"text_single":case"text_multi":d=this.setExpressionValueElementType(d,a,e),(void 0===d||null===d||""===d.toString().trim())&&(d=""),r+='"'+d+'"';break;case"number":switch(d=this.setExpressionValueElementType(d,a,e),l){case!0:null===d||isNaN(d)?d=null:(d=Math.round(d),0>d&&(d="("+d+")")),r+=d;break;default:""===d||null===d||void 0===d||isNaN(d)?d=null:(d=Math.round(d),0>d&&(d="("+d+")")),r+=d}break;case"number_decimal":case"currency":switch(d=this.setExpressionValueElementType(d,a,e),l){case!0:null===d||isNaN(d)?d=null:0>d&&(d="("+d+")"),r+=d;break;default:""===d||null===d||void 0===d||isNaN(d)?d=null:0>d&&(d="("+d+")"),r+=d}}}else if(a.is_main===!1&&a.isLookup===!0){var p=a.name.split("."),d="";switch(e[p[0]]?e[p[0]][p[1]]?d=e[p[0]][p[1]]:e[p[0]][p[2]]&&(d=e[p[0]][p[2]]):$rootScope.user[p[2]]&&(d=$rootScope.user[p[2]]),t.data_type){case"text_single":case"text_multi":(void 0===d||null===d||""===d.trim())&&(d=""),r+='"'+d+'"';break;case"number":switch(l){case!0:null===d||isNaN(d)?d=null:(d=Math.round(d),0>d&&(d="("+d+")")),r+=d;break;default:""===d||null===d||void 0===d||isNaN(d)?d=null:(d=Math.round(d),0>d&&(d="("+d+")")),r+=d}break;case"number_decimal":case"currency":switch(l){case!0:null===d||isNaN(d)?d=null:0>d&&(d="("+d+")"),r+=d;break;default:""===d||null===d||void 0===d||isNaN(d)?d=null:0>d&&(d="("+d+")"),r+=d}}}break;case"operator":r+="length"===a.forTypeName?").length":a.value;break;case"function":r+="and"===a.name||"or"===a.name?a.value:"(";break;case"input":if("number"===t.data_type||"number_decimal"===t.data_type||"currency"===t.data_type||"number_auto"===t.data_type){var c=parseInt(a.dataValue);r+=isNaN(c)?null:a.dataValue}else{var c=parseInt(a.dataValue);r+=isNaN(c)?'"'+a.dataValue+'"':a.dataValue}}return r},expressionRunOrder:function(e,t,a){for(var l=[],r=0;r<e.length;r++){var i=null;if(a)i=e[r].validation&&e[r].validation.custom?JSON.parse(e[r].validation.custom):null;else try{if(!isNaN(e[r].default_value)||!e[r].default_value){t[e[r].name]=t[e[r].name]?t[e[r].name]:e[r].default_value;continue}i=e[r].default_value?JSON.parse(e[r].default_value):null}catch(n){t[e[r].name]=t[e[r].name]?t[e[r].name]:e[r].default_value;continue}var o={label:e[r].name,fields:[],formulaJson:i,data_type:e[r].data_type,isRun:!1,isConstant:!1,treeIndex:[]};if(null!==i&&0!==i.length){if(a){for(var s=0;s<i.length;s++)for(var d=0;d<i[s].elements.length;d++)if(o.validationMsg=$rootScope.getLanguageValue(i[s].languages,"label"),"field"===i[s].elements[d].type){var u={label:i[s].elements[d].label,name:i[s].elements[d].name,isLookup:i[s].elements[d].isLookup};o.fields.push(u)}}else for(var n=0;n<i.elements.length;n++)if("field"===i.elements[n].type){var p={label:i.elements[n].label,name:i.elements[n].name,isLookup:i.elements[n].isLookup};o.fields.push(p)}0===o.fields.length&&(o.isConstant=!0),l.push(o)}}var c=[],f=[];l.forEach(function(e){0===e.fields.length?c.push(e):f.push(e)});var m=c.length;m>0&&(m-=1);for(var g=0;g<f.length;g++)for(var v=f[g],_=0;_<f.length;_++)if(g!==_){var h=f[_],b=$filter("filter")(f[g].fields,{name:f[_].label},!0);if(b.length>0){var k=f.indexOf(v),y=f.indexOf(h);y>k?(h.treeIndex.includes(v.label)||h.treeIndex.push(v.label),f[y]=v,f[k]=h):h.treeIndex.includes(v.label)||h.treeIndex.push(v.label)}}var $=c.concat(f);return $},exprressionDependencyControl:function(e,t){var a=$filter("filter")(e.fields,{name:t.label,deleted:!1},!0)[0];return!a||void 0!==a.hidden&&a.hidden===!0||void 0!==a.sectionObj.hidden&&a.sectionObj.hidden===!0?!0:!1},expressionRunValue:function(resultArr,record,currentField,module){var dependenciesFields=[];if(currentField&&(dependenciesFields=$filter("filter")(module.dependencies,{parent_field:currentField.name,deleted:!1},!0)),currentField)if(currentField&&"lookup"===currentField.data_type){var runLookup=$filter("filter")(resultArr,{fields:{name:currentField.lookup_type,isLookup:!0}}),addRunLookup=[];runLookup&&runLookup.length>0&&runLookup.forEach(function(e){if(e.treeIndex.length>0){var t=$filter("filter")(resultArr,{label:e.treeIndex[0]},!0)[0];addRunLookup.push(t)}});for(var lastRunLookup=addRunLookup.length>0?runLookup.concat(addRunLookup):runLookup,j=0;j<lastRunLookup.length;j++){for(var expressionResultLookup="",r=0;r<lastRunLookup[j].formulaJson.elements.length;r++)expressionResultLookup+=this.expressionGetValue(record,lastRunLookup[j],lastRunLookup[j].formulaJson.elements[r],!1);try{record[lastRunLookup[j].label]||this.setHideFieldValue(lastRunLookup[j].label,expressionResultLookup),record[lastRunLookup[j].label]=eval(expressionResultLookup)}catch(e){record[lastRunLookup[j].label]=""}}}else if(currentField&&dependenciesFields.length>0){var then=this;dependenciesFields.forEach(function(item){for(var runDep1=$filter("filter")(resultArr,{label:item.child_field},!0),runDep2=$filter("filter")(resultArr,{fields:{name:item.child_field}},!0),allRunDep=runDep1.concat(runDep2),that=this,j=0;j<allRunDep.length;j++){for(var expressionResult="",r=0;r<allRunDep[j].formulaJson.elements.length;r++)expressionResult+=then.expressionGetValue(record,allRunDep[j],allRunDep[j].formulaJson.elements[r],!1);try{record[allRunDep[j].label]||that.setHideFieldValue(allRunDep[j].label,expressionResult),record[allRunDep[j].label]=eval(expressionResult)}catch(e){record[allRunDep[j].label]=""}}})}else{var resultLastArr=$filter("filter")(resultArr,{fields:{name:currentField.name}},!0),addRunAnyExp=[];resultLastArr&&resultLastArr.length>0&&resultLastArr.forEach(function(e){if(e.treeIndex.length>0){var t=$filter("filter")(resultArr,{label:e.treeIndex[0]},!0)[0];addRunAnyExp.push(t)}});var resultLastArrRun=addRunAnyExp.length>0?resultLastArr.concat(addRunAnyExp):resultLastArr;this.expressionRecursiveRunValue(resultLastArrRun,resultArr,record,currentField,module.fields,!1)}else for(var j=0;j<resultArr.length;j++){var expressionResult="";resultArr[j].isRun=!0;for(var r=0;r<resultArr[j].formulaJson.elements.length;r++)expressionResult+=this.expressionGetValue(record,resultArr[j],resultArr[j].formulaJson.elements[r],!1);try{record[resultArr[j].label]||this.setHideFieldValue(resultArr[j].label,expressionResult),record[resultArr[j].label]=eval(expressionResult)}catch(e){record[resultArr[j].label]=""}}},expressionRecursiveRunValue:function(resultLastArr,resultArr,record,currentField,moduleFields,validate){for(var j=0;j<resultLastArr.length;j++){var expressionResult="";resultLastArr[j].isRun=!0;for(var r=0;r<resultLastArr[j].formulaJson.elements.length;r++)expressionResult+=this.expressionGetValue(record,resultLastArr[j],resultLastArr[j].formulaJson.elements[r]);
try{record[resultLastArr[j].label]||this.setHideFieldValue(resultLastArr[j].label,expressionResult),record[resultLastArr[j].label]=eval(expressionResult)}catch(e){record[resultLastArr[j].label]=""}var resultTreeExp=$filter("filter")(resultArr,{label:resultLastArr[j].treeIndex[0]},!0)[0];resultLastArr[j].treeIndex.length>0&&this.expressionRecursiveRunValue(resultTreeExp,resultArr,record,currentField,moduleFields,validate)}},setHideFieldValue:function(e,t){$rootScope.hideFieldValue[e]=t},expressionRunValidation:function(resultArr,record,currentField,isSave,module,isValidate){if(!currentField&&isSave){for(var j=0;j<resultArr.length;j++)if(!this.exprressionDependencyControl(module,resultArr[j])){var expressionResult="";resultArr[j].isRun=!0;for(var h=0;h<resultArr[j].formulaJson.length;h++)for(var k=0;k<resultArr[j].formulaJson[h].elements.length;k++)expressionResult+=this.expressionGetValue(record,resultArr[j],resultArr[j].formulaJson[h].elements[k],isValidate);try{var resultExp=eval(expressionResult);if(resultExp===!1)return resultArr[j].validationMsg}catch(e){return resultArr[j].validationMsg}}}else if(currentField&&!isSave)for(var resultLastArr=$filter("filter")(resultArr,{label:currentField.name},!0),j=0;j<resultLastArr.length;j++)if(!this.exprressionDependencyControl(module,resultLastArr[j])){var expressionResult2="";resultLastArr[j].isRun=!0;for(var h=0;h<resultLastArr[j].formulaJson.length;h++)for(var k=0;k<resultLastArr[j].formulaJson[h].elements.length;k++)expressionResult2+=this.expressionGetValue(record,resultLastArr[j],resultLastArr[j].formulaJson[h].elements[k],isValidate);try{var resultExp2=eval(expressionResult2);if(resultExp2===!1)return resultLastArr[j].validationMsg}catch(e){return resultLastArr[j].validationMsg}}},setExpression:function(e,t,a,l,r,i){var n=[],o=[];$rootScope.moduleRecordData={picklist:a,module:e};var s=$filter("filter")($rootScope.expressionRunOrderData.Value,{moduleName:e.name},!0)[0],d=$filter("filter")($rootScope.expressionRunOrderData.Validation,{moduleName:e.name},!0)[0];if(s&&d)n=s.value,o=d.validation;else{var u=$filter("filter")(e.fields,function(e){return("text_single"===e.data_type||"text_multi"===e.data_type||"number"===e.data_type||"number_decimal"===e.data_type||"currency"===e.data_type)&&e.deleted===!1},!0);n=this.expressionRunOrder(u,t,!1),o=this.expressionRunOrder(u,t,!0);var p={moduleName:e.name,value:n},c={moduleName:e.name,validation:o};$rootScope.expressionRunOrderData.Value.push(p),$rootScope.expressionRunOrderData.Validation.push(c)}return i||this.expressionRunValue(n,t,l,e),this.expressionRunValidation(o,t,l,i,e,!0)},setDefaultValues:function(e,t,a){for(var l=0;l<e.fields.length;l++){var r=e.fields[l];if(!r.deleted){var i=r.name;if(void 0!==r.default_value&&null!==r.default_value&&!t[i]){switch(r.data_type){case"url":case"email":case"image":t[i]=r.default_value;break;case"date":case"time":case"date_time":"[now]"===r.default_value?(t[i]=new Date,t[i+"str"]="time"===r.data_type?kendo.toString(new Date,"t"):kendo.toString(new Date,"g")):(t[i]=new Date(r.default_value),t[i+"str"]="time"===r.data_type?kendo.toString(new Date(r.default_value),"t"):kendo.toString(new Date(r.default_value),"g"));break;case"picklist":var n=$filter("filter")(a[r.picklist_id],{id:parseInt(r.default_value)},!0)[0];n||(n={},n.id=t[i],n.type=r.picklist_id,n.label={},n.label.tr=t[i],n.label.en=t[i],n.labelStr=t[i],n.required=!1,n.order=9999,helper.getPicklists([r.picklist_id],!0)),t[r.name]=n;break;case"lookup":var o="[me]"!==r.default_value?parseInt(r.default_value):$rootScope.user.id,s=angular.copy(r);this.getRecord(r.lookup_type,o,!0).then(function(e){var a={};a.id=e.data.id,a.primary_value=e.data[s.lookupModulePrimaryField.name],t[s.name]=a});break;case"multiselect":var d=r.default_value.split(";");t[i]=[];for(var u=0;u<d.length;u++){var p=parseInt(d[u]);isNaN(p)||t[i].push(p)}break;case"checkbox":t[r.name]="true"===r.default_value;break;case"tag":t[i]=[];for(var c=r.default_value.split(","),u=0;u<c.length;u++){if(r.tag&&r.tag.dataSource&&r.tag.dataSource._data.length>0)var f=$filter("filter")(r.tag.dataSource._data,{text:c[u]},!0)[0];f&&t[i].push(f.id)}}this.setDisplayDependency(e,t)}}}this.setExpression(e,t,a,null,!1,!1)},setDependency:function(e,t,a,l){var r=this;if(!a.id&&a.event_start_date&&"event_start_date"===e.name){var i=new Date(a.event_start_date);0===i.getHours()&&0===i.getSeconds()&&0===i.getMilliseconds()&&(i.setHours(8),a.event_start_date=i),a.event_end_date=new Date(i.getTime()+36e5)}if(a.event_start_date&&a.event_end_date&&"event_end_date"===e.name){var n=new Date(a.event_start_date),o=new Date(a.event_end_date);n>o&&(a.event_start_date=new Date(o.getTime()-36e5))}if(!a.id&&"start_date"===e.calendar_date_type&&a[e.name]){var s=new Date(a[e.name]);0===s.getHours()&&0===s.getSeconds()&&0===s.getMilliseconds()&&(s.setHours(8),a[e.name]=s);var d=$filter("filter")(t.fields,{calendar_date_type:"end_date"},!0)[0];d&&(a[d.name]=new Date(s.getTime()+36e5))}if("end_date"===e.calendar_date_type&&a[e.name]){var u=$filter("filter")(t.fields,{calendar_date_type:"start_date"},!0)[0];if(u&&a[u.name]){var s=new Date(a[u.name]),p=new Date(a[e.name]);s>p&&(a[u.name]=new Date(p.getTime()-36e5))}}if("task_due_date"===e.name&&$rootScope.taskReminderAuto){var c=new Date(a.task_due_date);c.setTime(c.getTime()+288e5),a.task_reminder=c}if(t.dependencies){var f=$filter("filter")(t.dependencies,{parent_field:e.name},!0);if(f&&f.length)for(var m=0;m<f.length;m++){var g=f[m];if(!g.deleted){var v=$filter("filter")(t.fields,{name:g.child_field},!0)[0];if(g.clear)g.child_field&&(a[g.child_field]=void 0);else{if(!v)continue;switch(g.dependency_type){case"list_value":case"list_field":a.id||(a[g.child_field]=null);for(var _=l[v.picklist_id],h=0;h<_.length;h++){var b=_[h];delete b.hidden}if("list_value"===g.dependency_type){if(!a[g.parent_field])continue;var k=[];for(var y in g.value_maps)if(g.value_maps.hasOwnProperty(y)){var $=g.value_maps[y];y===a[g.parent_field].id.toString()&&(k=$)}if(!k.length)continue;for(var w=0;w<_.length;w++){var S=_[w];k.indexOf(S.id)<0&&(S.hidden=!0)}}else if("list_field"===g.dependency_type){if(!a[g.parent_field]){for(var x=0;x<_.length;x++){var F=_[x];F.hidden=!0}continue}for(var R=a[g.parent_field][g.field_map_parent],I=0;I<_.length;I++){var L=_[I];L[g.field_map_child]!==R&&(L.hidden=!0)}}break;case"list_text":a[g.child_field]=a[g.parent_field]?a[g.parent_field].value||a[g.parent_field].label[$rootScope.language]:null;break;case"lookup_text":a[g.child_field]=a[g.parent_field]?a[g.parent_field][g.field_map_parent]:null;break;case"lookup_list":case"lookup_field":if(!a[g.parent_field])continue;var M=a[g.parent_field][g.field_map_parent],C=l[v.picklist_id],j=null;if("lookup_list"===g.dependency_type){for(var A=0;A<C.length;A++){var D=C[A];D[g.field_map_child]===M&&(j=D)}!j||a.id&&a[g.child_field]||(a[g.child_field]=j)}else if("lookup_field"===g.dependency_type&&M){var V=$filter("filter")($rootScope.modules,{name:v.lookup_type},!0)[0],P=angular.copy(v);P.lookupModulePrimaryField=$filter("filter")(V.fields,{name:g.field_map_child},!0)[0];var U=[v.lookupModulePrimaryField.name];r.lookup(M,P,a,U,!0).then(function(e){if(e[0]){var t=e[0];t.primary_value=t[v.lookupModulePrimaryField.name],a[g.child_field]=t,v.valueChangeDontRun=!0}})}break;case"display":if(!a.id&&g.child_field)switch(v.data_type){case"checkbox":var N="true"===v.default_value;a[g.child_field]=v.default_value?N:null;break;default:a[g.child_field]=v.default_value?v.default_value:null}}}this.calculate(v,t,a)}}}},setDependencyFilter:function(e,t,a,l){var r=angular.copy(a),i=angular.copy(e);if(e.indexOf(".")>-1){var n=e.split(".");r=$filter("filter")($rootScope.modules,{name:n[1]},!0)[0],i=n[2]}if(r.dependencies&&r.dependencies.length){var o=$filter("filter")(r.dependencies,{parent_field:i},!0);if(o&&o.length)for(var s=angular.copy(r.fields),d=0;d<o.length;d++){var u=o[d];if(!u.deleted){var p=$filter("filter")(s,{name:u.child_field},!0)[0];if(p&&t&&"list_field"===u.dependency_type){for(var c=l[p.picklist_id],f=0;f<c.length;f++){var m=c[f];delete m.hidden}for(var g=t[u.field_map_parent],v=0;v<c.length;v++){var _=c[v];_[u.field_map_child]!==g&&(_.hidden=!0)}}}}}},setDisplayDependency:function(e,t){if(e.display_dependencies)for(var a=0;a<e.display_dependencies.length;a++){var l=e.display_dependencies[a];if(!l.deleted){var r=null;if(r=l.dependent_section?$filter("filter")(e.sections,{name:l.dependent_section},!0)[0]:$filter("filter")(e.fields,{name:l.dependent_field},!0)[0])if(void 0!==t[l.field]){var i=null,n=angular.copy(t[l.field]);if(angular.isArray(n)){if(!t[l.field].length){r.hidden=!0,delete t[l.dependent_field];continue}for(var o=0;o<n.length;o++){var s=n[o],d=$filter("filter")(l.values,s,!0)[0];!i&&d&&(i=d)}}else l.values?n&&(i="boolean"==typeof n?n:n.id?$filter("filter")(l.values,n.id,!0)[0]:$filter("filter")(l.values,n,!0)[0]):i=n;if(l.otherwise||i)if(l.otherwise&&i){if(r.hidden=!0,"p_employees"===e.name&&("profile"===l.dependent_field||"email"===l.dependent_field||"username"===l.dependent_field))continue;delete t[l.dependent_field]}else{if(!l.dependent_section){var u=$filter("filter")(e.fields,{name:l.field},!0)[0];if(u.hidden){r.hidden=!0,delete t[l.dependent_field];continue}}r.hidden=!1}else{if(r.hidden=!0,"p_employees"===e.name&&("profile"===l.dependent_field||"email"===l.dependent_field||"username"===l.dependent_field))continue;delete t[l.dependent_field]}}else r.hidden=!0,delete t[l.dependent_field]}}},generatTd:function(e){var t={mobileContent:"",normalContent:""};switch(e.data_type){case"rating":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><input class="rating-stars" kendo-rating k-precision="\'half\'" k-label="false" k-max="getRatingCount(\''+e.name+"')\"  ng-init=\"rating = dataItem['"+e.name+'\']"  ng-model="rating" ng-disabled="true" /></div>',t.normalContent='<td class="hide-on-m2"><input class="rating-stars" kendo-rating k-precision="\'half\'" k-label="false" k-max="getRatingCount(\''+e.name+"', relatedModule)\"  ng-init=\"rating = dataItem['"+e.name+'\']"  ng-model="rating" ng-disabled="true"/></td>';break;case"image":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true)\" ng-src=\"{{dataItem['"+e.name+"'] ? (config.imageUrl+dataItem['"+e.name+"']): 'images/no-image.png'}}\"/></div></div></div>",t.normalContent='<td class="hide-on-m2"><div ng-style="getImageStyle(\''+e.name+'\')" class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, undefined, relatedModule)\" ng-src=\"{{dataItem['"+e.name+"'] ? (config.imageUrl+dataItem['"+e.name+"']): 'images/no-image.png'}}\"/>\n</div></div></td>";break;case"text_multi":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+'\']"><span class="grid-multiselect-text" ng-repeat="data in getMultiTextData(dataItem[\''+e.name+'\'], dataItem)">{{data}}</span > <button ng-show="dataItem.show" aria-label="{{\'Common.ShowMore\' | translate}}" ng-click="$event.stopPropagation(); showLightBox($event, dataItem, false, \''+e.name+'\')"> <i class="fas fa-ellipsis-v"></i><md-tooltip md-autohide="true" md-direction="bottom">{{\'Common.ShowMore\' | translate}}</md-tooltip></button></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+'\']"><span class="grid-multiselect-text" ng-repeat="data in getMultiTextData(dataItem[\''+e.name+'\'], dataItem)">{{data}}</span > <button ng-show="dataItem.show" aria-label="{{\'Common.ShowMore\' | translate}}" ng-click="$event.stopPropagation(); showLightBox($event, dataItem, false, \''+e.name+'\', relatedModule)"> <i class="fas fa-ellipsis-v"></i><md-tooltip md-autohide="true" md-direction="bottom">{{\'Common.ShowMore\' | translate}}</md-tooltip></button></div></td>';break;case"lookup":var a=!0;("users"===e.lookup_type||"roles"===e.lookup_type||"profiles"===e.lookup_type)&&(a=!1),t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+": </span><div ng-show=\"dataItem['"+e.name+'\']" class="grid-list-button"><span>{{dataItem[\''+e.name+"']}}</span><a ng-if=\""+a+'"  ng-click="$event.stopPropagation(); goToRecord(\''+e.name+"','"+e.lookup_type+"',"+a+", dataItem, '"+e.external_link+'\')"><i class= "fas fa-external-link-alt"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div ng-if="'+a+'" ng-show="dataItem[\''+e.name+'\']" class="grid-list-button"><span>{{dataItem[\''+e.name+"']}}</span><a ng-click=\"$event.stopPropagation(); goToRecord('"+e.name+"','"+e.lookup_type+"',"+a+", dataItem,'"+e.external_link+'\')"><i class= "fas fa-external-link-alt"></i></a></div><span class="text-nowrap" ng-if="!'+a+"\">{{dataItem['"+e.name+"']}}</span></span></td>";break;case"multiselect_lookup":var a=!0;("users"===e.lookup_type||"roles"===e.lookup_type||"profiles"===e.lookup_type)&&(a=!1),t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+": </span><div ng-show=\"dataItem['"+e.name+'\']" class="grid-list-button" ng-repeat="data in dataItem[\''+e.name+"']\"><span>{{data['"+e.lookupModulePrimaryField+"']}}</span><a ng-if=\""+a+'" ng-click="$event.stopPropagation(); goToMultiselectLookupRecord(dataItem[\''+e.name+"'][$index].id, '"+e.lookup_type+"',"+a+', dataItem)""><i class= "fas fa-external-link-alt"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div ng-if="'+a+'" ng-show="dataItem[\''+e.name+"']\"><div ng-repeat=\"data in dataItem['"+e.name+'\']" class="grid-list-button"><span class="grid-multiselect-text">{{data[\''+e.lookupModulePrimaryField+"']}}</span><a ng-click=\"$event.stopPropagation(); goToMultiselectLookupRecord(dataItem['"+e.name+"'][$index].id, '"+e.lookup_type+"',"+a+', dataItem)"><i class= "fas fa-external-link-alt"></i></a></div></div><span class="text-nowrap" ng-if="!'+a+"\">{{dataItem['"+e.name+"']}}</span></span></td>";break;case"url":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"> <span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="{{dataItem[\''+e.name+'\']}}" target="_blank"><i class= "fas fa-external-link-alt"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"> <span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="{{dataItem[\''+e.name+'\']}}" target="_blank"><i class= "fas fa-external-link-alt"></i></a></div></td>';break;case"email":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\" ><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="mailto:{{dataItem[\''+e.name+'\']}}" ><i class= "fas fa-paper-plane"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\" ><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="mailto:{{dataItem[\''+e.name+'\']}}"><i class= "fas fa-paper-plane"></i></a></div></td>';break;case"document":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="storage/record_file_download?fileName={{dataItem[\''+e.name+'\']}}"><i class= "fas fa-download"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="storage/record_file_download?fileName={{dataItem[\''+e.name+'\']}}"><i class= "fas fa-download"></i></a></div></td>';break;case"tag":case"multiselect":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+'\']"><span class="grid-multiselect-text" ng-repeat="data in getTagAndMultiDatas(dataItem, dataItem[\''+e.name+'\'])">{{data}}</span > <button ng-show="dataItem.show" aria-label="{{\'Common.ShowMore\' | translate}}" ng-click="$event.stopPropagation(); showLightBox($event, dataItem, false, \''+e.name+'\')"> <i class="fas fa-ellipsis-v"></i><md-tooltip md-autohide="true" md-direction="bottom">{{\'Common.ShowMore\' | translate}}</md-tooltip></button></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+'\']"><span class="grid-multiselect-text" ng-repeat="data in getTagAndMultiDatas(dataItem, \''+e.name+'\')">{{data}}</span > <button ng-show="dataItem.show" aria-label="{{\'Common.ShowMore\' | translate}}" ng-click="$event.stopPropagation(); showLightBox($event, dataItem, false, \''+e.name+'\', relatedModule)"> <i class="fas fa-ellipsis-v"></i><md-tooltip md-autohide="true" md-direction="bottom">{{\'Common.ShowMore\' | translate}}</md-tooltip></button></div></td>';break;case"location":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, '"+e.name+"')\" ng-src=\"{{dataItem['"+e.name+"'] ? getLocationUrl(dataItem['"+e.name+"']) : 'images/no-location.png'}}\"/></div></div></div>",t.normalContent='<td class="hide-on-m2"> <div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, '"+e.name+"', relatedModule)\" ng-src=\"{{dataItem['"+e.name+"'] ? getLocationUrl(dataItem['"+e.name+"']) : 'images/no-location.png'}}\"/></div></td>";break;default:t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button"><span>{{ dataItem[\''+e.name+"'] }}</span></div></div>",t.normalContent='<td class="hide-on-m2"><span class="text-nowrap">{{ dataItem[\''+e.name+"'] }}</span></td>"}return t},generatoptionsItem:function(e,t,a){var l="'"+e+"'";switch(t){case"remove":return' <md-menu-item ng-if="controlRemove(dataItem)">\n <md-button id="deleteButton-{{dataItem.id}}" ng-click="recordDelete($event,'+a+","+l+')">\n <i class="fas fa-trash"></i> <span> '+$filter("translate")("Common.Delete")+"</span>\n </md-button>\n </md-menu-item>\n";case"copy":return' <md-menu-item ng-if="controlCopy(dataItem, relatedModule)">\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,clone:true,id:'+a+'})">\n <i class="fas fa-copy"></i> '+$filter("translate")("Common.Copy")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"edit":return' <md-menu-item ng-if="controlEdit(dataItem, relatedModule)">\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,id:'+a+'})">\n <i class="fas fa-edit"></i> '+$filter("translate")("Common.Edit")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"send-sms":return' <md-menu-item ng-if="user.profile.send_sms">\n <md-button  ng-click="selectRowSingle($event,dataItem); showSMSModal()" >\n <i class="fas fa-sms"></i> '+$filter("translate")("Module.SendSMS")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"send-email":return' <md-menu-item>\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,clone:true,id:dataItem.id})">\n <i class="fas fa-envelope"></i> '+$filter("translate")("Module.SendEMail")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"download":return' <md-menu-item>\n <md-button ng-click="selectRowSingle($event,dataItem); showSMSModal()">\n <i class="fas fa-file-download"></i> '+$filter("translate")("Common.Download")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"remove_relation":return' <md-menu-item ng-if="controlRemove(dataItem, relatedModule)">\n <md-button id="deleteButton-{{dataItemId}}" ng-click="deleteRelation($event, relatedModule, true, '+a+')">\n <i class="fas fa-minus-circle"></i> <span> '+$filter("translate")("Module.RemoveRelation")+"</span>\n </md-button>\n </md-menu-item>\n"}},generatRowtmpl:function(e,t,a,l){var r=this,i={columns:[],rowtempl:"",requestFields:[]},n="",o=!1,s="dataItem.id",d="";if(a.relatedModule&&"many_to_many"===a.relatedModule.relation_type){o=!0;var u=a.module.name!==a.relatedModule.related_module?a.relatedModule.related_module+"_id":a.relatedModule.related_module+"1_id",p=u+"."+a.relatedModule.related_module+".";s="dataItem['"+u+"']"}var c=["edit","copy","remove"],f={},m="";if(t){o&&c.indexOf("remove_relation")<0&&c.push("remove_relation");for(var g=0;g<c.length;g++)d+=r.generatoptionsItem(a.relatedModule.related_module,c[g],s);f={width:"40px",headerTemplate:'<input type="checkbox"  ng-model="isAllSelected[\''+a.relatedModule.related_module+"']\"  ng-click=\"selectAll($event,'"+a.relatedModule.related_module+'\')" id="header-chb-'+a.relatedModule.related_module+'" class="k-checkbox header-checkbox"><label class="k-checkbox-label" for="header-chb-'+a.relatedModule.related_module+'"></label>'},m='<td ng-click="$event.stopPropagation();" class="position-relative">  <input ng-model="dataItem.isChecked"  type="checkbox" id="{{'+s+'}}" ng-click="selectRow($event,dataItem,\''+a.relatedModule.related_module+'\')" class="k-checkbox row-checkbox"><label class="k-checkbox-label" for="{{'+s+'}}"></label></td>'}else{for(var g=0;g<c.length;g++)d+=r.generatoptionsItem(a.moduleName,c[g],s);f={width:"40px",headerTemplate:"<input type='checkbox' ng-if=' grid.dataSource.data().length>0' ng-checked='isAllSelected'  ng-click='selectAll($event, grid.dataSource.data())' id='header-chb' class='k-checkbox header-checkbox'><label class='k-checkbox-label' for='header-chb'></label>"},m='<td ng-click="$event.stopPropagation();" class="position-relative"><input ng-click="selectRow($event,dataItem);$event.stopPropagation();" ng-disabled="dataItem.freeze && !user.profile.has_admin_rights" ng-checked="isRowSelected(dataItem.id) || dataItem.selected"  type="checkbox" id="{{dataItem.id}}" class="k-checkbox row-checkbox"><label class="k-checkbox-label" for="{{dataItem.id}}"></label></td>'}i.rowtempl=i.rowtempl+m,i.columns.push(f),e.map(function(e){if(e&&e.name){if(p&&(e.name=p+e.name),e.name.contains(".languages.")&&(e.name=e.name.substring(0,e.name.indexOf(".label"))),i.requestFields.push(e.name),i.columns.push({title:e.labelExt?e.label+" "+e.labelExt:e.label,field:e.name,media:"(min-width: 575px)",groupable:!1,groupHeaderTemplate:"#= aggregates.groupSelect #"+(e.labelExt?e.label+" "+e.labelExt:e.label)+": #= value #  #= aggregates.template #"}),"multiselect_lookup"===e.data_type){var t=$filter("filter")(l.fields,{name:e.name},!0)[0];t&&(e.lookupModulePrimaryField=t.lookupModulePrimaryField.name)}var a=r.generatTd(e,n);i.rowtempl=i.rowtempl+a.normalContent,n+=a.mobileContent}});var v={field:"",width:"50px"},_="";_=o?'<td ng-click="$event.stopPropagation();" class="padding0"> <button class="md-icon-button md-button md-blue-theme md-ink-ripple" id="deleteButton-{{dataItemId}}" ng-click="deleteRelation($event, relatedModule, true, dataItem[\''+a.relatedModule.related_module+'_id\'])">\n <i class="fas fa-minus-circle"></i>\n </button></td>':'<td ng-click="$event.stopPropagation();" class="padding0"><md-menu md-position-mode="target-right target">\n<md-button ng-show="dataItem.showRemove || dataItem.showCopy || dataItem.showEdit" ng-disabled="dataItem.freeze && !user.profile.has_admin_rights" class="md-icon-button" aria-label=" " ng-click="$mdMenu.open()"> <i class="fas fa-ellipsis-v"></i></md-button>\n <md-menu-content width="2" class="md-dense">\n'+d+"\n </md-menu-content>\n </md-menu></td>",i.rowtempl=i.rowtempl+'<td class="show-on-m2">'+n+"</td>";var h={title:"Items",media:"(max-width: 575px)"};if(a.activeView&&"report"===a.activeView.view_type&&a.activeView.aggregations){h.footerTemplate="";for(var b=0;b<a.activeView.aggregations.length;b++){var k=a.activeView.aggregations[b].aggregation_type+"("+a.activeView.aggregations[b].field+")";h.footerTemplate=h.footerTemplate+"  <div> {{ fieldskey['"+a.activeView.aggregations[b].field+"']['label_'+language] }} {{ 'Report."+a.activeView.aggregations[b].aggregation_type+"' | translate  }} : {{ "+k.replace("(","_").replace(")","")+"}} </div>"}}if(i.columns.push(h),""==d||a.tableOptinosMenuHide||(i.rowtempl=i.rowtempl+_,i.columns.push(v)),a.activeView&&"grid"===a.activeView.view_type)for(var y="<td class='k-group-cell'>&nbsp;</td>",g=0;g<a.gridGroupBy.length;g++)i.rowtempl=y+i.rowtempl;return i},deleteView:function(e){return $http["delete"](config.apiUrl+"view/delete/"+e)},getViews:function(e,t,a){var l=this,r=$q.defer();if(t){var i=[],n={};n.active=!0;for(var o=[],s=1,d=0;d<t.length;d++){var u,p=t[d];if(p.indexOf(".")>-1){var c=p.split("."),f=$filter("filter")($rootScope.modules,{name:c[1]},!0)[0];u=$filter("filter")(f.fields,{name:c[2]},!0)[0]}else u=$filter("filter")(e.fields,{name:p},!0)[0];if(u&&l.hasFieldDisplayPermission(u)){var m={};m.field=p,m.order=s,o.push(m),s++}}return n.fields=o,i.push(n),r.resolve(i),r.promise}return a&&a.views?(r.resolve(a.views),r.promise):($http.get(config.apiUrl+"view/get_all/"+e.id).then(function(t){if(!t.data)return r.resolve([]),r.promise;for(var a=[],i=0;i<t.data.length;i++){for(var n=t.data[i],o=[],s=0;s<n.fields.length;s++){var d,u=n.fields[s];if(u.field.indexOf(".")>-1){var p=u.field.split("."),c=$filter("filter")($rootScope.modules,{name:p[1]},!0)[0];if(!c)continue;d=$filter("filter")(c.fields,{name:p[2]},!0)[0]}else d=$filter("filter")(e.fields,{name:u.field},!0)[0];d&&l.hasFieldDisplayPermission(d)&&o.push(u)}n.fields=o,n.label=n["label_"+$rootScope.language],a.push(n)}r.resolve(t.data)})["catch"](function(e){r.reject(e.data)}),r.promise)},getViewState:function(e,t){var a=$q.defer();return t&&t.viewState?(a.resolve(t.viewState),a.promise):($http.get(config.apiUrl+"view/get_view_state/"+e).then(function(e){a.resolve(e.data)})["catch"](function(e){a.reject(e.data)}),a.promise)},getViewFields:function(e,t){var a=this,l=Object.assign({},e),r=l.fields,i={};i.selectedFields=[],i.availableFields=[],i.primaryField="",r=$filter("filter")(r,{display_list:!0,lookup_type:"!relation"},!0),r=$filter("orderByLabel")(r,"languages."+$rootScope.globalization.Label+".label");var n={name:"seperator-main",label:$rootScope.getLanguageValue(e.languages,"label","singular"),order:0,seperator:!0};r.unshift(n);var o=0;return angular.forEach(r,function(e){if("lookup"===e.data_type&&"relation"!==e.lookup_type){var t=$filter("filter")($rootScope.modules,{name:e.lookup_type},!0)[0];if(o+=1e3,null===t||void 0===t)return;var a={name:"seperator-"+t.name,order:o,seperator:!0};a.label=$rootScope.getLanguageValue(t.languages,"label","singular")+" ("+$rootScope.getLanguageValue(e.languages,"label")+")",r.push(a);var l=t.fields;l=$filter("filter")(l,{display_list:!0},!0),l=$filter("orderByLabel")(l,"languages."+$rootScope.globalization.Label+".label"),angular.forEach(l,function(a){return"lookup"===a.data_type?void(a.field=Object.assign({},a)):(a=Object.assign({},a),a.label=$rootScope.getLanguageValue(a.languages,"label"),a.labelExt="("+e.label+")",a.name=e.name+"."+t.name+"."+a.name,a.order=parseInt(a.order)+o,a.id=a.order,a.parent_id=o,void r.push(a))})}}),angular.forEach(r,function(e,l){if(!e.deleted&&(a.hasFieldDisplayPermission(e)||"large"===e.multiline_type)){var r=null;t.fields&&(r=$filter("filter")(t.fields,{field:e.name},!0)[0]);var n={};n.name=e.name,n.label=e.label,n.labelExt=e.labelExt,n.order=l,n.id=e.id,e.name.indexOf("seperator-")<0&&(n.parent_id=e.parent_id?e.parent_id:0),n.lookup_type=e.lookup_type,n.seperator=e.seperator,n.multiline_type=e.multiline_type,n.data_type=e.data_type,"lookup"===e.data_type&&(n.external_link=e.external_link?escape(e.external_link):"",n.name=e.name+"."+e.lookup_type+"."+e.lookupModulePrimaryField.name),r?(n.order=l,n.orderSelected=r.order,n.id=r.id?r.id:r.order,n.parent_id=r.parent_id,i.selectedFields.push(n)):i.availableFields.push(n)}}),i.selectedFields=$filter("orderBy")(i.selectedFields,"orderSelected"),i},getCSVData:function(e,t){var a=this,l=$q.defer(),r=angular.copy(e.findRequest[t.id]);return r.take=3e3,a.findCustom(e.locale||e.language,r).then(function(e){for(var a=e.data.data,r=[],i=[],n=$rootScope.modulus[t.related_module].fields,o=$filter("filter")(t.display_fields,function(e){return e.contains(".")},!0),s=0;s<t.display_fields.length;s++){var d=$filter("filter")(n,{name:t.display_fields[s]},!0)[0];if(d)i.push($rootScope.getLanguageValue(d.languages,"label")+(d.parentField?" ("+$rootScope.getLanguageValue(d.parentField.languages,"label")+")":""));else if(o)for(var u=0;u<o.length;u++){var p=o[u].split(".");if(p){d=$filter("filter")(n,{name:p[0]},!0)[0],i.push($rootScope.getLanguageValue(d.languages,"label")+(d.lookupModulePrimaryField?" ("+d.lookupModulePrimaryField.label+")":"")),o.splice(u,1);break}}}r.push(i);for(var c=0;c<a.length;c++){for(var f=a[c],m=[],g=t.display_fields,v=0;v<g.length;v++){var _=f[g[v]];m.push(_)}r.push(m)}l.resolve(r)}),l.promise},getIcons:function(){return icons2.icons},getActionButtons:function(e,t){var a=$q.defer(),l="action_button_"+e,r=$cache.get(l);return!r||t||preview?($http.get(config.apiUrl+"action_button/get/"+e).then(function(e){$cache.put(l,e.data),a.resolve(e.data)})["catch"](function(e){a.reject(e.data)}),a.promise):(a.resolve(r),a.promise)},hasFieldDisplayPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0],a=function(e){if(!e.sectionObj||!e.sectionObj.permissions)return!0;var t=$filter("filter")(e.sectionObj.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"none"!==t.type:!0};return t&&"none"===t.type?!1:a(e)},hasFieldReadOnlyPermission:function(e){if(!e.permissions)return!1;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"read_only"===t.type:!1},hasFieldFullPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0],a=function(e){if(!e.sectionObj||!e.sectionObj.permissions)return!0;var t=$filter("filter")(e.sectionObj.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"full"===t.type:!0};return t&&"full"!==t.type?!1:a(e)},hasSectionDisplayPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"none"!==t.type:!0},hasSectionReadOnlyPermission:function(e){if(!e.permissions)return!1;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"read_only"===t.type:!1},hasSectionFullPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"full"===t.type:!0},hasActionButtonDisplayPermission:function(e,t,a,l){if(e.visible){var r=!1,i=!1;if("all_users"===e.visible)r=!0;else if("profiles"===e.visible)if(void 0!==e.permissions){var n=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];r=!!n}else r=!0;return i=t?!0:this.hasActionButtonDisplayCriteria(l,e,a),r===!0&&i===!0}if(!e.permissions)return!0;var o=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return o?"none"!==o.type:!0},convertRecordValue:function(e){var t=null;switch(e.field.data_type){case"date_time":case"date":if(!e.value)switch(e.costumeDate){case"costumeN":t="today("+e.valueX+e.nextprevdatetype+")";break;case"costumeM":t="this_month("+e.valueX+e.nextprevdatetype+")";
break;case"costumeW":t="this_week("+e.valueX+e.nextprevdatetype+")";break;case"costumeY":t="this_year("+e.valueX+e.nextprevdatetype+")";break;case"now()":t=Date.now().toLocaleString();break;default:t="costume"===e.value.name?e.costumeDate:e.value.value}break;case"multiselect":var a="";angular.forEach(e.value,function(e){a+=e.label[$rootScope.language]+"|"}),t=a.slice(0,-1);break;case"checkbox":t=e.value.system_code.toString();break;case"tag":var a="";angular.forEach(e.value,function(e){a+=e.text+"|"}),t=a.slice(0,-1);break;case"lookup":t="users"===e.lookup_type?0===e.value[0].id?"[me]":e.value.id:e.value;break;case"picklist":t=e.value.languages[$rootScope.globalization.Label].label;break;default:t=e.value}return t},buttonsFiltersConvertForRun:function(e,t,a,l){e.filters.forEach(function(e){if(null!=e.group)a.buttonsFiltersConvertForRun(e.group,t,a,l);else{l+=1;var r=!1,i=e.field;if(!i)return void($rootScope.filterLogicButtons="false");var n=i.name,o=e.value,s=t[n];if(o=a.convertRecordValue(e),"object"==typeof o&&"object"==typeof s&&"lookup"===e.field.data_type&&"users"===e.field.lookup_type){s=s.email;for(var d=0;d<o.length;d++){var u=o[d].email;if("[me]"===u){o=$rootScope.user.email;break}if(u===s){o=u;break}}}if("boolean"==typeof s&&(s=s.toString()),angular.isObject(s)&&s.languages&&(s=s.languages[$rootScope.globalization.Label].label),(null===s||void 0===s||null===o||void 0===o)&&(r=!1),o&&s)switch(e.operator.name){case"contains":r=s.toString().contains(o.toString());break;case"is":case"equals":r=s.toString()===o.toString();break;case"is_not":case"not_equal":r=s.toString()!==o.toString();break;case"greater":r=parseFloat(s.toString())>parseFloat(o.toString());break;case"greater_equal":r=parseFloat(s.toString())>=parseFloat(o.toString());break;case"less":r=parseFloat(s.toString())<parseFloat(o.toString());break;case"less_equal":r=parseFloat(s.toString())<=parseFloat(o.toString());break;case"empty":r=""===s||null===s||void 0===s;break;case"not_empty":r=angular.isObject(s)||angular.isDefined(s)&&null!=s&&""!==s&&s.length>0;break;case"not_contain":r=!s.toString().contains(o.toString());break;case"starts_with":r=s.toString().startsWith(o.toString());break;case"ends_with":r=s.toString().endsWith(o.toString())}else switch(e.operator.name){case"empty":r=""===s||null===s||void 0===s}$rootScope.filterLogicButtons=$rootScope.filterLogicButtons.replace(l,r.toString().toLocaleLowerCase())}})},hasActionButtonDisplayCriteria:function(module,actionButton,record){if($rootScope.filterLogicButtons=null,actionButton.filter_logic_json){$rootScope.filterLogicButtons=actionButton.filter_logic;var filterJson=JSON.parse(actionButton.filter_logic_json);if(0===filterJson.filters.length)return!0;var fullModule=$rootScope.modulus[module.name];this.convertFilterFields(filterJson,fullModule,!1);var index=0;return this.buttonsFiltersConvertForRun(filterJson,record,this,index),$rootScope.filterLogicButtons=$rootScope.filterLogicButtons.replaceAll("or","||"),$rootScope.filterLogicButtons=$rootScope.filterLogicButtons.replaceAll("and","&&"),eval($rootScope.filterLogicButtons)}return!0},convertFilterFields:function(e,t,a,l){if(null!=e.filters&&e.filters.length>0){const r=this;angular.forEach(e.filters,function(e){if(null!=e.group)r.convertFilterFields(e.group,t,a);else if(null!=e.operator&&""!==e.operator)if(a)e.field=angular.isObject(e.field)?e.field.value||e.field.id:e.field;else if(t.fields)e.field=angular.isObject(e.field)?e.field:$filter("filter")(t.fields,{id:e.field,deleted:!1},!0)[0];else{var i=angular.isObject(e.field)?e.field.value:e.field;(i.contains("[")||i.contains("]"))&&(e.field=i.replaceAll("[","").replaceAll("]",""));const n=angular.isObject(e.field)?e.field.value:e.field,o=n.contains(".")?n.split("."):[n],s=$filter("filter")(t,{label:o[0]},!0)[0];s?(e.field=$filter("filter")(s.properties,{name:o[1]},!0)[0],e.field.value=i):angular.isObject(e.field)||(e.field={value:n,data_type:"text_single",operators:l.text_single})}})}},getChartsTypes:function(){var e=[{label:$filter("translate")("Report.Chart.ColumnChart2d"),name:"column2d"},{label:$filter("translate")("Report.Chart.ColumnChart3d"),name:"column3d"},{label:$filter("translate")("Report.Chart.LineChart"),name:"line"},{label:$filter("translate")("Report.Chart.AreaChart"),name:"area2d"},{label:$filter("translate")("Report.Chart.BarChart2d"),name:"bar2d"},{label:$filter("translate")("Report.Chart.BarChart3d"),name:"bar3d"},{label:$filter("translate")("Report.Chart.PieChart"),name:"pie3d"},{label:$filter("translate")("Report.Chart.DoughnutChart2d"),name:"doughnut2d"},{label:$filter("translate")("Report.Chart.DoughnutChart3d"),name:"doughnut3d"},{label:$filter("translate")("Report.Chart.ScrollColumnChart"),name:"scrollcolumn2d"},{label:$filter("translate")("Report.Chart.ScrollLineChart"),name:"scrollline2d"},{label:$filter("translate")("Report.Chart.ScrollAreaChart"),name:"scrollarea2d"},{label:$filter("translate")("Report.Chart.FunnelChart"),name:"funnel"},{label:$filter("translate")("Report.Chart.PyramidChart"),name:"pyramid"}];return e},chartFilter:function(e){return $http.post(config.apiUrl+"view/chart_filter",e)},getChart:function(e){return $http.get(config.apiUrl+"view/get_chart/"+e)},getWidget:function(e){return $http.get(config.apiUrl+"view/get_widget/"+e)},saveView:function(e,t){return"edit"===e?$http.put(config.apiUrl+"view/update/"+t.id,t):$http.post(config.apiUrl+"view/create",t)},goToRecord:function(e,t,a,l,r){if(e){var i=e.split(".");i&&i.length>2&&(i[i.length-1]="id"),i=i.join("."),a&&(r&&""!=r?$window.open(unescape(r)+"?id="+l[i],"_self"):$window.open("#/app/record/"+t+"?id="+l[i],"_self"))}},goToMultiselectLookupRecord:function(e,t,a,l,r){e&&a&&(r&&""!=r?$window.open(unescape(r)+"?id="+e,"_self"):$window.open("#/app/record/"+t+"?id="+e,"_self"))},getTagAndMultiDatas:function(e,t){return t&&t.length>3?(e.show=!0,t.splice(3,t.length-3)):e.show=!1,t},getImageStyle:function(e,t){var a=$rootScope.modulus[t];if(a){var l=$filter("filter")(a.fields,{name:e,deleted:!1})[0];if(l&&l.image_size_list>0){var r={width:l.image_size_list+"px",height:l.image_size_list+"px"};return r}}},getRatingCount:function(e,t){var a=$rootScope.modulus[t];if(a){var l=$filter("filter")(a.fields,{name:e,deleted:!1})[0];if(l)return l.max||5}},getLocationUrl:function(e){return"https://maps.googleapis.com/maps/api/staticmap?zoom=10&size=300x150&maptype=roadmap&markers=color:red|"+e+"&key="+googleMapsApiKey},openCalendar:function(e){var t=void 0;switch(e.data_type){case"date":t="kendoDatePicker";break;case"date_time":t="kendoDateTimePicker";break;case"time":t="kendoTimePicker"}if(t){const a=angular.element(document.getElementById(e.name)).data(t);a&&a.open()}},rangeRuleForForms:function(){return function(e){const t=parseInt(e[0].ariaValueMin,10),a=parseInt(e[0].ariaValueMax,10);var l=parseInt(e[0].minLength,10),r=parseInt(e[0].maxLength,10);const i=e.val(),n=parseInt(i,10),o=e[0].id||(e[0].nextSibling?e[0].nextSibling.id:"");if((-1===l||-1===r)&&o){var s=o.split("_");if(s&&s.length>1)var d=$filter("filter")($rootScope.modules,{id:parseInt(s[1])},!0)[0];if(d){var u=$filter("filter")(d.fields,{name:s[0]},!0)[0];u&&(l=u.validation.min_length||0,r=u.validation.max_length||("text_single"===u.data_type?50:16))}}return!isNaN(l)&&!isNaN(r)&&i&&l>-1&&r>-1?l<=i.length&&i.length<=r:isNaN(t)||isNaN(a)||isNaN(l)||isNaN(r)||-1===l||-1===r?!0:isNaN(n)?!0:n>=t&&a>=n&&l<=i.length&&i.length<=r}},setMinMaxValueForField:function(e){return e.validation.min=e.validation.min||Number.MIN_SAFE_INTEGER,e.validation.max=e.validation.max||Number.MAX_SAFE_INTEGER,e},renderCurrencyFormat:function(e,t){e=e||"$";for(var a="",l=0;t>l;l++)a+="0";return"âº"===e?"#."+a+e:e+"#."+a},renderNumberDecimalFormat:function(e){for(var t="",a=0;e>a;a++)t+="0";return"#."+t},kendoCaleanderDataProcces:function(e,t,a,l){for(var r=[],i=0;i<e.length;i++)if(t&&e[i][t.startdatefield]){var n={};n[t.startdatefield]=e[i][t.startdatefield],l?n[t.enddatefield]=e[i][t.enddatefield]:n.end=e[i][t.startdatefield],n.id=e[i].id,n[a]=e[i][a],r.push(n)}return r},getLanguageOptions:function(){return{dataSource:$rootScope.globalizations,dataTextField:"Language",dataValueField:"Label",filter:$rootScope.globalizations.length>10?"startswith":null,optionLabel:$filter("translate")("Common.Select")}},getPicklistValue:function(e,t){if(e&&t){const a=$filter("filter")($rootScope.globalizations,function(e){return e.Culture.substr(0,2)===tenantLanguage},!0)[0];var l=e.languages[a?a.Label:$rootScope.globalization.Label];if(l&&l.label===t)return e.languages[$rootScope.globalization.Label].label}},getMenuList:function(){return $http.get(config.apiUrl+"menu/get_all")},getMenuItemsByMenuId:function(e){return $http.get(config.apiUrl+"menu/get_menu_items/"+e)},proccesMenuItems:function(e){for(var t=[],a=0;a<e.length;a++){var l=e[a];l.expanded=!0,l.enabled=!0,l.menu_items||l.module_id||(l.enabled=!1),l.parent||(l.menu_items&&(l.items=$filter("orderBy")(l.menu_items,"order",!1)),t.push(l))}return t=$filter("orderBy")(t,"order",!1)},moduleFilterById:function(e){return $filter("filter")($rootScope.modules,{id:e},!0)},getAllTenantSettingsByType:function(e,t){return $http.get(config.apiUrl+"settings/get_all/"+e+(t?"?user_id="+t:""))},processFilterField:function(e,t){if(e.contains(".")){var a=e.split(".");if(3===a.length){const l=$rootScope.modulus[a[1]];if(l){const e=$filter("filter")(l.fields,{name:a[2]},!0)[0];if(e&&e.auto_number_prefix&&(t=t.toString().replace(e.auto_number_prefix,""),!angular.isUndefined(t)))return parseInt(t)}}}return t}}}]);