"use strict";angular.module("primeapps").controller("ModuleFormController",["$rootScope","$scope","ngToast","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","$timeout","operations","$modal","FileUploader","activityTypes","transactionTypes","ModuleService","DocumentService","$http","resizeService","components",function(e,r,t,a,o,n,i,l,u,d,s,c,m,p,f,_,y,g,h,v,k,b,F,w){if(r.$parent.$parent.formType){var M=r.$parent.$parent;r.formType=M.formType,r.type=M.type,r.id=M.id,r.subtype=M.stype,r.parentType=M.ptype,r.parentId=M.pid,r.returnTab=M.rtab,r.previousParentType=M.pptype,r.previousParentId=M.ppid,r.previousReturnTab=M.prtab,r.back=M.back,r.many=M.many,r.clone=M.clone,r.revise=M.revise,r.paramField=M.field,r.paramValue=M.value}else r.type=l.type,r.subtype=l.stype,r.id=n.search().id,r.parentType=n.search().ptype,r.parentId=n.search().pid,r.returnTab=n.search().rtab,r.previousParentType=n.search().pptype,r.previousParentId=n.search().ppid,r.previousReturnTab=n.search().prtab,r.back=n.search().back,r.many=n.search().many,r.clone=n.search().clone,r.revise=n.search().revise,r.paramField=n.search().field,r.paramValue=n.search().value;if(r.operations=f,r.hasPermission=o.hasPermission,r.hasDocumentsPermission=o.hasDocumentsPermission,r.hasAdminRights=o.hasAdminRights,r.hasFieldFullPermission=v.hasFieldFullPermission,r.hasSectionFullPermission=v.hasSectionFullPermission,r.hasActionButtonDisplayPermission=v.hasActionButtonDisplayPermission,r.lookupUserAndGroup=o.lookupUserAndGroup,r.lookupUser=o.lookupUser,r.loading=!0,r.image={},r.document={},r.hasProcessEditPermission=!1,r.userAdded=!1,r.parentId&&d.scrollTo(0,0),r.module=a("filter")(e.modules,{name:r.type},!0)[0],w.run("BeforeFormLoaded","script",r),r.currentSectionComponentsTemplate=currentSectionComponentsTemplate,!r.id)for(var L=0;L<r.module.fields.length;L++){var S=r.module.fields[L];S.show_lock&&(S.show_lock=!1)}if(e.activeModuleName=r.parentType,!r.module)return t.create({content:a("translate")("Common.NotFound"),className:"warning"}),void i.go("app.dashboard");r.dropdownFields=a("filter")(r.module.fields,{data_type:"lookup",show_as_dropdown:!0},!0),r.dropdownFieldDatas={};for(var C=0;C<r.dropdownFields.length;C++)r.dropdownFieldDatas[r.dropdownFields[C].name]=[];if(!r.id&&!r.hasPermission(r.type,r.operations.write))return t.create({content:a("translate")("Common.Forbidden"),className:"warning"}),void i.go("app.dashboard");r.primaryField=a("filter")(r.module.fields,{primary:!0})[0],r.currentUser=v.processUser(e.user),r.currentDayMin=o.getCurrentDateMin().toISOString(),r.currentDayMax=o.getCurrentDateMax().toISOString(),r.currentHour=o.floorMinutes(new Date),r.relatedToField=a("filter")(r.module.fields,{name:"related_to"},!0)[0],r.record={},r.customLeaveFields={},r.id||(r.title=a("translate")("Module.New",{title:r.module["label_"+e.language+"_singular"]}));var T=function(){if("leaves"===r.module.name||"izinler"===r.module.name){var t=a("filter")(e.modules,{name:"holidays"},!0)[0];if(t){var n=a("filter")(t.fields,{name:"country"},!0)[0];o.getPicklists([n.picklist_id]).then(function(r){var t=r[n.picklist_id],o=a("filter")(t,{value:"tr"},!0)[0],i=a("filter")(t,{value:"en"},!0)[0],l=window.localStorage.NG_TRANSLATE_LANG_KEY||"tr",u={};u.limit=1e3,u.filters="tr"===e.language?[{field:"country",operator:"equals",value:o.labelStr,no:1}]:[{field:"country",operator:"is",value:i.labelStr}],v.findRecords("holidays",u).then(function(r){for(var t=r.data,o=[],n=0;n<t.length;n++)if(!t[n].half_day){var i=moment(t[n].date).format("DD-MM-YYYY");o.push(i)}var u=[1,2,3,4,5],d=a("filter")(e.moduleSettings,{key:"work_saturdays"},!0);d.length>0&&"t"===d[0].value&&u.push(6),e.holidaysData=t,moment.locale(l,{week:{dow:1},workingWeekdays:u,holidays:o,holidayFormat:"DD-MM-YYYY"})})})}}};T();for(var P=0;P<e.approvalProcesses.length;P++){var D=e.approvalProcesses[P];D.module_id===r.module.id&&(r.currentModuleProcess=D)}if(r.currentModuleProcess)for(var U=r.currentModuleProcess.profiles.split(","),C=0;C<U.length;C++)U[C]===e.user.profile.id.toString()&&(r.hasProcessEditPermission=!0);if(r.parentType)if("activities"===r.type||"mails"===r.type||r.many)r.parentModule=r.parentType;else if("current_accounts"===r.type)r.id?"supplier"===r.parentType?r.parentModule="suppliers":"customer"===r.parentType&&(r.parentModule="accounts"):r.parentModule=r.parentType;else{var A=a("filter")(r.module.fields,{name:r.parentType},!0)[0];A?r.parentModule=A.lookup_type:(r.parentType=null,r.parentId=null)}r.picklistFilter=function(){return function(e){return r.componentFilter={},r.componentFilter.item=e,r.componentFilter.result=!0,w.run("PicklistFilter","Script",r),!e.hidden&&!e.inactive&&r.componentFilter.result}};var N=function(e){var t=!1;if(1===e.process_status)return!0;if(r.module.dependencies.length>0){var o=a("filter")(r.module.dependencies,{dependency_type:"freeze"},!0);angular.forEach(o,function(o){var n=a("filter")(r.module.fields,{name:o.parent_field},!0);angular.forEach(n,function(r){angular.forEach(o.values_array,function(a){!e[r.name]||a!=e[r.name]&&a!=e[r.name].id||(t=!0)})})})}return t},I=function(){if("current_accounts"===r.module.name&&r.currencyField){var e;r.record.customer&&(e=r.record.customer.currency),r.record.supplier&&(e=r.record.supplier.currency),e&&(r.record.currency=angular.isObject(e)?e:a("filter")(r.picklistsModule[r.currencyField.picklist_id],{labelStr:e},!0)[0])}};v.getPicklists(r.module).then(function(o){r.picklistsModule=o;var n=a("filter")(r.module.fields,{name:"owner"},!0)[0],l=function(){angular.forEach(r.module.fields,function(e){v.setDependency(e,r.module,r.record,r.picklistsModule,r),"activities"!=r.module.name&&(!r.record.id&&e.default_value&&"picklist"==e.data_type||e.default_value&&"picklist"==e.data_type&&e.default_value==r.record[e.name].id)&&(r.record[e.name]=a("filter")(r.picklistsModule[e.picklist_id],{id:e.default_value})[0],r.fieldValueChange(e))})};if(w.run("BeforeFormPicklistLoaded","Script",r),r.module&&"izinler"===r.module.name){var u=a("filter")(r.module.fields,{name:"to_entry_type"},!0)[0],d=a("filter")(r.module.fields,{name:"from_entry_type"},!0)[0];r.customLeaveFields.to_entry_type=u,r.customLeaveFields.from_entry_type=d,r.record.to_entry_type||r.record.from_entry_type||!u||(r.record.to_entry_type=o[u.picklist_id][0],r.record.from_entry_type=o[u.picklist_id][0])}if(!r.id){if(r.loading=!1,r.record.owner=r.currentUser,!e.branchAvailable){var s=a("filter")(r.module.fields,{name:"kullanici_olustur"},!0)[0];s&&(s.hidden=!1)}if("calisanlar"===r.module.name&&v.getUserLicenseStatus().then(function(e){r.userLicenseControl=e.data,r.userLicenseKalan=r.userLicenseControl.Total-r.userLicenseControl.Used}),r.subtype&&("activities"==r.type?(r.record.activity_type=a("filter")(g,{system_code:r.subtype},!0)[0],r.subtypeNameLang=a("translate")("Module.New",{title:r.record.activity_type.label[e.language]})):"current_accounts"==r.type&&(r.record.transaction_type=a("filter")(h,{system_code:r.subtype},!0)[0],r.subtypeNameLang=a("translate")("Module.New",{title:r.record.transaction_type.label[e.language]}))),r.parentId){var c=a("filter")(e.modules,{name:r.parentModule},!0)[0];v.getRecord(r.parentModule,r.parentId).then(function(e){var t=a("filter")(c.fields,{primary:!0,deleted:!1},!0)[0],n={};if(n.id=e.data.id,n.primary_value=e.data[t.name],e.data.currency&&(n.currency=e.data.currency,I()),"calisanlar"===r.parentModule&&(n.e_posta=e.data.e_posta),"activities"!==r.type&&"mails"!==r.type||!r.relatedToField){"accounts"===r.parentModule&&"current_accounts"===r.type?r.record.customer=n:"suppliers"===r.parentModule&&"current_accounts"===r.type?r.record.supplier=n:r.record[r.parentType]=n;var i=a("filter")(r.module.dependencies,{dependent_field:r.parentType},!0)[0];if(i&&1!=i.deleted){var u=a("filter")(r.module.fields,{name:i.field},!0)[0];r.record[i.field]=a("filter")(r.picklistsModule[u.picklist_id],{id:i.values[0]},!0)[0];var d=a("filter")(r.module.fields,{name:i.dependent_field},!0)[0];d.hidden=!1}l()}else r.record.related_to=n,r.record.related_module=a("filter")(o[9e5],{value:r.parentType},!0)[0]})}else l();return v.setDefaultValues(r.module,r.record,o),v.setDisplayDependency(r.module,r.record),r.paramField&&(r.record[r.paramField]=r.paramValue,e.hideSipPhone()),void w.run("FieldChange","Script",r,r.record,n)}v.getRecord(r.module.name,r.id).then(function(o){if(0===Object.keys(o.data).length)return t.create({content:a("translate")("Common.Forbidden"),className:"warning"}),void i.go("app.dashboard");var u=v.processRecordSingle(o.data,r.module,r.picklistsModule);if("calisanlar"===r.module.name){var d=a("filter")(r.module.fields,{name:"kullanici_olustur"},!0)[0];d&&(d.hidden=!0,u[d.name]=!1)}else"calisanlar"===r.module.name&&v.getUserLicenseStatus().then(function(e){r.userLicenseControl=e.data,r.userLicenseKalan=r.userLicenseControl.Total-r.userLicenseControl.Used});if(!r.hasPermission(r.type,r.operations.modify,o.data)||N(u)&&!r.hasAdminRights)return t.create({content:a("translate")("Common.Forbidden"),className:"warning"}),void i.go("app.dashboard");w.run("BeforeFormRecordLoaded","Script",r,u),v.formatRecordFieldValues(angular.copy(o.data),r.module,r.picklistsModule),r.title=r.primaryField.valueFormatted,r.recordState=angular.copy(u),v.setDisplayDependency(r.module,u);for(var s=0;s<r.module.fields.length;s++){var c=r.module.fields[s],m=!1;if(c.encrypted&&c.encryption_authorized_users_list.length>0&&u[c.name])for(var p=0;p<c.encryption_authorized_users_list.length;p++){var f=c.encryption_authorized_users_list[p];e.user.id==parseInt(f)&&(m=!0)}c.show_lock=c.encrypted&&!m?!0:!1}if(r.relatedToField&&u.related_to){var _=a("filter")(e.modules,{id:u[r.relatedToField.lookup_relation].id-9e5},!0)[0],y=a("filter")(_.fields,{primary:!0},!0)[0];v.getRecord(_.name,u.related_to,!0).then(function(e){e=e.data,e.primary_value=e[y.name],u.related_to=e,r.record=u,r.recordState=angular.copy(r.record),"activities"!=r.module.name&&l(),r.module&&r.module.fields&&r.module.fields.length>0&&r.fieldValueChange(r.module.fields[0]),r.loading=!1})["catch"](function(e){404===e.status&&(u.related_to=null,r.record=u,r.recordState=angular.copy(r.record)),r.loading=!1})}else r.record=u,r.clone&&(r.record.owner=r.currentUser),"activities"!=r.module.name&&l(),r.loading=!1;r.record.currency&&(r.currencySymbol=r.record.currency.value||e.currencySymbol),v.customActions(r.module,r.record),w.run("FieldChange","Script",r,r.record,n),w.run("AfterFormRecordLoaded","Script",r)})["catch"](function(){r.loading=!1}),w.run("AfterFormPicklistLoaded","Script",r)}),r.lookup=function(t){if(r.searchTerm=t,"users"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="full_name",r.currentLookupField.lookupModulePrimaryField=o}if("profiles"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="name",r.currentLookupField.lookupModulePrimaryField=o}if("roles"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="label_"+e.user.tenantLanguage,r.currentLookupField.lookupModulePrimaryField=o}if("relation"===r.currentLookupField.lookup_type){if(!r.record.related_module)return r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),u.defer().promise;var n=a("filter")(e.modules,{name:r.record.related_module.value},!0)[0];if(!n)return r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),u.defer().promise;r.currentLookupField.lookupModulePrimaryField=a("filter")(n.fields,{primary:!0},!0)[0]}if(("number"===r.currentLookupField.lookupModulePrimaryField.data_type||"number_auto"===r.currentLookupField.lookupModulePrimaryField.data_type)&&isNaN(parseFloat(t)))return r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),u.defer().promise;if("current_accounts"===r.module.name&&r.currencyField){var i="";if("customer"===r.currentLookupField.name?i="accounts":"supplier"===r.currentLookupField.name&&(i="suppliers"),i){var l=a("filter")(e.modules,{name:i},!0)[0],d=a("filter")(l.fields,{name:"currency"},!0)[0];return d?v.lookup(t,r.currentLookupField,r.record,["currency"]):v.lookup(t,r.currentLookupField,r.record)}}return r.customFilters=null,w.run("BeforeLookup","Script",r),r.lookupCurrentData?r.lookupCurrentData:"users"===r.currentLookupField.lookup_type?v.lookup(t,r.currentLookupField,r.record,["email"],!1,r.customFilters):"profiles"===r.currentLookupField.lookup_type?v.lookup(t,r.currentLookupField,r.record,null,!1,r.customFilters):"roles"===r.currentLookupField.lookup_type?v.lookup(t,r.currentLookupField,r.record,null,!1,r.customFilters):"calisanlar"===r.currentLookupField.lookup_type?v.lookup(t,r.currentLookupField,r.record,["e_posta"],!1,r.customFilters):v.lookup(t,r.currentLookupField,r.record)},r.multiselect=function(e,t){var a=[];return angular.forEach(r.picklistsModule[t.picklist_id],function(r){r.inactive||r.hidden||(r.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||r.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||r.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||r.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&a.push(r)}),a},r.tags=function(e,r){return b.get(m.apiUrl+"tag/get_tag/"+r.id).then(function(r){var t=r.data;return t.filter(function(r){return-1!=r.text.toLowerCase().indexOf(e.toLowerCase())})})},r.setCurrentLookupField=function(e){r.currentLookupField=e},r.uploader=new y({url:"storage/record_file_upload"}),r.entityIdFunc=function(){return r.recordId},r.addUser=function(o){if(r.openCreateUserModal=function(){r.userCreateModal=r.userCreateModal||_({scope:r,templateUrl:"view/app/module/createUserModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal",keyboard:!1}),r.userCreateModal.$promise.then(r.userCreateModal.show)},0===r.userLicenseKalan||r.userLicenseKalan<0){if(!e.branchAvailable){var n=a("filter")(r.module.fields,{name:"kullanici_profili"},!0)[0],i=a("filter")(r.module.fields,{name:"kullanici_rolu"},!0)[0];r.record.kullanici_olustur=!1,r.record.kullanici_profili=null,r.record.kullanici_rolu=null,n&&(n.hidden=!0),i&&(i.hidden=!0)}return t.create({content:a("translate")("Setup.Users.LicenceRequired"),className:"warning"}),void(r.submitting=!1)}v.getUserEmailControl(r.record.e_posta).then(function(n){var i=n.data;if(!i){if(t.create({content:a("translate")("Setup.Users.NewUserError"),className:"warning"}),!e.branchAvailable){var l=a("filter")(r.module.fields,{name:"kullanici_profili"},!0)[0],d=a("filter")(r.module.fields,{name:"kullanici_rolu"},!0)[0];r.record.kullanici_olustur=!1,r.record.kullanici_profili=null,r.record.kullanici_rolu=null,l&&(l.hidden=!0),d&&(d.hidden=!0)}return void(r.submitting=!1)}var c=r.record.kullanici_profili?r.record.kullanici_profili.id:null,m=r.record.kullanici_rolu?r.record.kullanici_rolu.id:null,p=function(o,n,i){var l={};l.email=r.record.e_posta,l.first_name=r.record.ad,l.last_name=r.record.soyad,l.profile=n,l.role=o,l.full_name=l.first_name+" "+l.last_name,l&&l.email&&l.profile&&l.role&&l.first_name&&l.last_name&&(r.userInviting=!0,l.profile_id=l.profile,l.role_id=l.role,l.dont_send_mail=!0,r.addedUser=angular.copy(l),v.addUser(l).then(function(t){if(t.data){r.userCreatePassword=t.data,r.userCreateEmail=r.record.e_posta,r.userLicenseAvailable=r.userLicenseKalan-1,r.userLicensesBought=r.userLicenseControl.Total,r.userAdded=!0;var o=[];o.push(v.myAccount()),o.push(v.getAllUser()),u.all(o).then(function(r){var t=r[0].data,o=r[1].data;e.user=t.user,e.workgroups=t.instances;var n=s.read("Workgroup");if(e.workgroup=t.instances[0],n){var i=a("filter")(t.instances,{instanceID:n},!0)[0];i&&(e.workgroup=i)}var l=t.user.isDemo||!1;e.users=l?a("filter")(o,function(e){return e.Id==t.user.ID},!0):o}),r.submit(i),r.openCreateUserModal()}})["catch"](function(e){r.submitting=!1,409===e.status&&t.create({content:a("translate")("Setup.Users.NewUserError"),className:"warning"})}))};e.branchAvailable?v.getRecord("branchs",r.record.branch.id).then(function(e){m=e.data.branch,c=r.record.profile.id,p(m,c,o)})["catch"](function(){r.submitting=!1}):p(m,c,o)})},r.submit=function(o){function n(){var e=!0;if("current_accounts"===r.module.name)var n=!1;return angular.forEach(r.module.fields,function(i){o[i.name]&&("lookup"===i.data_type&&"object"!=typeof o[i.name]&&(r.moduleForm[i.name].$setValidity("object",!1),e=!1),"image"==i.data_type&&r.image[i.name]&&r.image[i.name].UniqueName&&null!=o[i.name]&&(o[i.name]=r.image[i.name].UniqueName),"document"==i.data_type&&r.document[i.name]&&r.document[i.name].UniqueName&&null!=o[i.name]&&(o[i.name]=r.document[i.name].UniqueName),"current_accounts"===r.module.name&&(!o.odendi||"cheque"!==o.payment_method.system_code&&"bill"!==o.payment_method.system_code||(o.kasa&&o.banka?(n||(t.create({content:a("translate")("Common.BankAndCaseChosen"),className:"warning"}),n=!0),delete o.kasa,delete o.banka,e=!1):o.kasa||o.banka||(n||(t.create({content:a("translate")("Common.ChooseBankOrCase"),className:"warning"}),n=!0),delete o.kasa,delete o.banka,e=!1))))}),e}function l(o){r.addedUser=!1,r.recordId=o.id,w.run("BeforeFormSubmitResult","Script",r,o),r.success=function(){var n={type:r.type,id:o.id};r.saveAndNew?(r.record={},r.moduleForm.$setPristine(),d.scrollTo(0,0),t.create({content:a("translate")("Module.SuccessMessage",{title:r.module["label_"+e.language+"_singular"]}),className:"success"}),r.uploader.clearQueue(),r.$broadcast("angucomplete-alt:clearInput"),"activities"===r.module.name&&(r.record.activity_type=r.activity_type_id,r.record.related_module=p.related_module,r.record.related_to=p.related_to),a("filter")(r.module.fields,{name:"owner"},!0)[0]&&(r.record.owner=r.currentUser,r.$broadcast("angucomplete-alt:changeInput","owner",r.currentUser)),angular.forEach(r.module.fields,function(e){"lookup"===e.data_type&&(a("filter")(r.module.dependencies,{child_field:e.name},!0)[0]||(r.record[e.name]=p[e.name],r.$broadcast("angucomplete-alt:changeInput",e.name,p[e.name])))}),v.setDefaultValues(r.module,r.record,r.picklistsModule)):(r.parentId&&(n.type=r.parentModule,n.id=r.parentId,n.rptype=r.returnTab,r.previousParentType&&(n.rpptype=r.previousParentType,n.rppid=r.previousParentId,n.rprtab=r.previousReturnTab)),r.back&&(n.back=r.back));var l=r.module.name+"_"+r.module.name;if(r.parentId){l=(r.relatedToField?"related_to":r.parentType)+r.parentId+"_"+(r.many?r.many:r.module.name);var u=r.parentType+"_"+r.parentType;c.remove(l),c.remove(u)}else c.remove(l),"opportunities"===r.module.name&&c.remove("opportunity"+r.id+"_stage_history");e.activePages&&e.activePages[r.module.name]&&(e.activePages[r.module.name]=null),(r.module.display_calendar||"activities"===r.module.name)&&c.remove("calendar_events"),r.saveAndNew?(("quotes"===r.type||"sales_invoices"===r.type)&&(v.getDailyRates().then(function(e){if(e.data){var t=e.data;r.exchangeRatesDate=a("date")(t.date,"dd MMMM yyyy")+" 15:30",r.record.exchange_rate_try_usd=t.usd,r.record.exchange_rate_try_eur=t.eur,r.record.exchange_rate_usd_try=1/t.usd,r.record.exchange_rate_usd_eur=1/t.usd*t.eur,r.record.exchange_rate_eur_try=1/t.eur,r.record.exchange_rate_eur_usd=1/t.eur*t.usd}}),"sales_invoices"===r.type&&(r.salesInvoiceProducts.quantity=null,r.salesInvoiceProducts.grand_total="",r.salesInvoiceProducts.product={},r.salesInvoiceProducts=[],r.vatList=[],r.record.grand_total=0)),"activities"==r.type?(r.submitting=!1,r.record.activity_type=a("filter")(g,{system_code:r.subtype},!0)[0],r.subtypeNameLang=a("translate")("Module.New",{title:r.record.activity_type.label[e.language]})):"current_accounts"==r.type&&(r.record.transaction_type=a("filter")(h,{system_code:r.subtype},!0)[0],r.subtypeNameLang=a("translate")("Module.New",{title:r.record.transaction_type.label[e.language]}))):"stock_transactions"===r.module.name?setTimeout(function(){i.go("app.moduleDetail",n)},500):"calisanlar"===r.module.name?(r.goModuleDetail=function(){i.go("app.moduleDetail",n),r.userCreateModal.hide()},r.id||!r.record.kullanici_olustur&&!e.branchAvailable?i.go("app.moduleDetail",n):r.loading=!0):i.go("app.moduleDetail",n),r.izinTuruData=null},r.success()}function u(e,t){r.addedUser=!1,409===t&&(r.moduleForm[e.field].$setValidity("unique",!1),e.field2&&r.moduleForm[e.field2].$setValidity("unique",!1))}if(r.submitting=!0,!r.moduleForm.$valid||!n())return void(r.submitting=!1);if(w.run("BeforeFormSubmit","Script",r,o),!r.id||r.clone){if(r.executeCode=!1,w.run("BeforeCreate","Script",r,o),r.executeCode)return void(r.submitting=!1)}else if(r.executeCode=!1,w.run("BeforeUpdate","Script",r,o),r.executeCode)return void(r.submitting=!1);if(!r.id&&"calisanlar"===r.module.name&&(r.record.kullanici_olustur||e.branchAvailable)&&!r.userAdded)return void r.addUser(o);if(e.branchAvailable&&r.branchManager&&(angular.forEach(r.record.Authorities,function(e){var t=a("filter")(r.authorities,{user_id:e.id},!0)[0];t||b.post(m.apiUrl+"user_custom_shares/create/",{shared_user_id:r.branchManager.Id,user_id:e.id})}),angular.forEach(r.authorities,function(e){var t=a("filter")(r.record.Authorities,{id:e.user_id},!0)[0];t||b["delete"](m.apiUrl+"user_custom_shares/delete/"+e.id)})),delete o.Authorities,"izinler"===r.module.name){var s="";if(r.skipValidation?(delete o.goreve_baslama_tarihi,delete o.calisan_data,delete o.dogum_tarihi,delete o.izin_turu_data,delete o.alinan_izinler):s=v.customValidations(r.module,o),""!=s)return t.create({content:s,className:"warning",timeout:8e3}),void(r.submitting=!1)}r.clone&&(delete r.record.created_at,delete r.record.created_by,delete r.record.updated_at,delete r.record.updated_by,angular.forEach(r.module.fields,function(e){"number_auto"===e.data_type&&delete o[e.name]}),r.recordState=null),o=v.prepareRecord(o,r.module,r.recordState);var p=angular.copy(r.record);if(r.activity_type_id=a("filter")(g,{id:o.activity_type},!0)[0],(o.activity_type_system||null===o.activity_type_system)&&delete o.activity_type_system,(o.transaction_type_system||null===o.transaction_type_system)&&delete o.transaction_type_system,r.id){for(var f=0;f<r.module.fields.length;f++){var _=r.module.fields[f],y=!1;if(_.encrypted&&_.encryption_authorized_users_list.length>0&&o[_.name])for(var k=0;k<_.encryption_authorized_users_list.length;k++){var F=_.encryption_authorized_users_list[k];e.user.id==parseInt(F)&&(y=!0)}_.encrypted&&!y&&delete o[_.name]}if(r.clone){if(r.revise){o.master_id=o.id;var M=a("filter")(r.module.fields,{name:"quote_stage"},!0)[0];o.quote_stage=a("filter")(r.picklistsModule[M.picklist_id],{value:"delivered"},!0)[0].id}delete o.id,delete o.process_id,delete o.process_status,delete o.process_status_order,delete o.process_request_updated_at,delete o.process_request_updated_by,delete o.operation_type,o.auto_id&&(o.auto_id=""),v.insertRecord(r.module.name,o).then(function(e){o.master_id?"quotes"===r.module.name&&v.getRecord(r.module.name,o.master_id).then(function(t){var o=v.processRecordSingle(t.data,r.module,r.picklistsModule),n=angular.copy(o),i=a("filter")(r.module.fields,{name:"quote_stage"},!0)[0];o.quote_stage=a("filter")(r.picklistsModule[i.picklist_id],{value:"revised"},!0)[0],o=v.prepareRecord(o,r.module,n),v.updateRecord(r.module.name,o).then(function(){r.submitting=!1,l(e.data)})}):(r.submitting=!1,l(e.data)),w.run("AfterCreate","Script",r,o)})["catch"](function(){u(data,status),r.submitting=!1})}else v.updateRecord(r.module.name,o).then(function(t){var n=a("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(n){for(var i=!1,u=0;u<n.length;u++)(0===n[u].user_id||n[u].user_id===r.currentUser.id)&&n[u].operations.indexOf("update")>-1&&(i=!0);i?setTimeout(function(){l(t.data)},2e3):l(t.data)}else l(t.data);w.run("AfterUpdate","Script",r,o)})["catch"](function(e){u(e.data,e.status)})["finally"](function(){var t=a("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(t){for(var o=!1,n=0;n<t.length;n++)(0===t[n].user_id||t[n].user_id===r.currentUser.id)&&t[n].operations.indexOf("update")>-1&&(o=!0);o?setTimeout(function(){r.submitting=!1},2e3):r.submitting=!1}else r.submitting=!1})}else"masraf_kalemleri"!==r.module.name||o.masraf||(o.masraf=r.$parent.$parent.currentExpense.id),v.insertRecord(r.module.name,o).then(function(t){var n=a("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(n){for(var i=!1,u=0;u<n.length;u++)(0===n[u].user_id||n[u].user_id===r.currentUser.id)&&n[u].operations.indexOf("insert")>-1&&(i=!0);i?setTimeout(function(){l(t.data)},2e3):l(t.data)}else l(t.data);w.run("AfterCreate","Script",r,o)})["catch"](function(e){u(e.data,e.status)})["finally"](function(){var t=a("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(t){for(var o=!1,n=0;n<t.length;n++)(0===t[n].user_id||t[n].user_id===r.currentUser.id)&&t[n].operations.indexOf("insert")>-1&&(o=!0);o?setTimeout(function(){r.submitting=!1},2e3):r.submitting=!1}else r.submitting=!1})},r.calculate=function(e){v.calculate(e,r.module,r.record)},r.fieldValueChange=function(t){return"activities"===r.module.name&&"related_module"===t.name&&(r.dropdownFieldDatas.related_to=[]),t.valueChangeDontRun?void delete t.valueChangeDontRun:(v.setDependency(t,r.module,r.record,r.picklistsModule,r),v.setDisplayDependency(r.module,r.record),v.setCustomCalculations(r.module,r.record,r.picklistsModule,r),v.customActions(r.module,r.record,r.moduleForm,r.picklistsModule,r),w.run("FieldChange","Script",r,r.record,t),r.moduleForm[t.name]&&r.moduleForm[t.name].$error&&r.moduleForm[t.name].$error.unique&&r.moduleForm[t.name].$setValidity("unique",!0),r.record.currency&&(r.currencySymbol=r.record.currency.value||e.currencySymbol),void("current_accounts"!==r.module.name||!r.currencyField||"customer"!==t.name&&"supplier"!==t.name||I()))},r.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"!==e.lookup_type||r.record.related_module?!1:!0},r.openFormModal=function(e){r.primaryValueModal=e,r.formModal=r.formModal||_({scope:r,templateUrl:"view/app/module/moduleFormModal.html",animation:"",backdrop:"static",show:!1}),r.formModal.$promise.then(r.formModal.show)},v.getActionButtons(r.module.id).then(function(e){r.actionButtons=a("filter")(e,function(e){return"Detail"!==e.trigger&&"List"!==e.trigger},!0)}),r.showModuleFrameModal=function(e){if(new RegExp("https:").test(e)){var t,a,o;t="myPop1",a=document.body.offsetWidth-200,o=document.body.offsetHeight-200;var n=screen.width/2-a/2,i=screen.height/2-o/2;window.open(e,t,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+a+", height="+o+", top="+i+", left="+n)}else r.frameUrl=e,r.frameModal=r.frameModal||_({scope:r,controller:"ActionButtonFrameController",templateUrl:"view/app/actionbutton/actionButtonFrameModal.html",backdrop:"static",show:!1}),r.frameModal.$promise.then(r.frameModal.show)},r.openLocationModal=function(e){r.filedName=e,r.locationModal=r.frameModal||_({scope:r,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",backdrop:"static",show:!1}),r.locationModal.$promise.then(r.locationModal.show)},r.removeDocument=function(t){var a={};a.module=r.module.name,a.recordId=r.record.id,a.fieldName=t.name,a.fileNameExt=o.getFileExtension(r.record[t.name]),a.instanceId=e.workgroup.tenant_id,r.record[t.name]=null,"document"==t.data_type&&(r.uploaderBasic[t.name].queue=[]),"image"==t.data_type&&(r.uploaderImage[t.name].queue=[]),angular.forEach(r.moduleForm[t.name].$error,function(e,a){r.moduleForm[t.name].$setValidity(a,e)})},r.checkUploadFile=function(e){var r=e.target.files,t=e.target.id,a=angular.element(document.getElementById("lbl_"+t))[0];isAcceptedExtension(r[0])&&(a.innerText=r[0].name)},r.fileLoadingCounter=0,r.uploaderBasic=function(e){r.document[e.name]={};var n=r.uploaderBasic[e.name]=new y({url:"storage/record_file_upload",queueLimit:1});return n.onAfterAddingFile=function(t){r.fileLoadingCounter++;var a=t.uploader.queue[0].file.name;r.record[e.name]=a,r.document[e.name].Name=t.uploader.queue[0].file.name,r.document[e.name].Size=t.uploader.queue[0].file.size,r.document[e.name].Type=t.uploader.queue[0].file.type,t.upload()},n.onWhenAddingFileFailed=function(e,r){switch(r.name){case"docFilter":t.create({content:a("translate")("Setup.Settings.DocumentTypeError"),className:"warning"});break;case"sizeFilter":t.create({content:a("translate")("Setup.Settings.SizeError"),className:"warning"})}},n.filters.push({name:"docFilter",fn:function(e){var r=o.getFileExtension(e.name);return"txt"===r||"docx"==r||"pdf"==r||"doc"==r||"xlsx"==r||"xls"==r}}),n.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),n.onSuccessItem=function(t,a){r.document[e.name].UniqueName=a.unique_name,r.fileLoadingCounter--},n},r.uploaderImage=function(e){function n(e){var r=u.defer(),t=new FileReader;return t.onload=function(e){r.resolve(e.target.result)},t.readAsDataURL(e),r.promise}r.image[e.name]={};var i=r.uploaderImage[e.name]=new y({url:"storage/record_file_upload",queueLimit:1});i.onAfterAddingFile=function(t){n(t._file).then(function(a){t.image=a;new Image;F.resizeImage(t.image,{width:1024},function(a,o){if(!a){t._file=l(o),t.file.size=t._file.size,r.fileLoadingCounter++;var n=t.uploader.queue[0].file.name;r.record[e.name]=n,r.image[e.name].Name=t.uploader.queue[0].file.name,r.image[e.name].Size=t.uploader.queue[0].file.size,r.image[e.name].Type=t.uploader.queue[0].file.type,t.upload()}})})},i.onWhenAddingFileFailed=function(e,r){switch(r.name){case"imgFilter":t.create({content:a("translate")("Setup.Settings.ImageError"),className:"warning"});break;case"sizeFilter":t.create({content:a("translate")("Setup.Settings.SizeError"),className:"warning"})}},i.filters.push({name:"imgFilter",fn:function(e){var r=o.getFileExtension(e.name);return"jpg"===r||"jpeg"==r||"png"==r||"doc"==r||"gif"==r}}),i.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),i.onSuccessItem=function(t,a){r.image[e.name].UniqueName=a.public_url,r.fileLoadingCounter--};var l=function(e){for(var r=atob(e.split(",")[1]),t=e.split(",")[0].split(":")[1].split(";")[0],a=[],o=0;o<r.length;o++)a.push(r.charCodeAt(o));return new Blob([new Uint8Array(a)],{type:t})};return i},r.webhookRequest=function(o){var n={},i=[],l=o.parameters.split(","),u=o.headers.split(",");if(r.webhookRequesting={},r.webhookRequesting[o.id]=!0,angular.forEach(l,function(e){var t=e.split("|"),a=t[0],o=t[1],i=t[2];n[a]=o!=r.module.name?r.record[o]?r.record[o][i]:null:r.record[i]?r.record[i]:null}),angular.forEach(u,function(t){var a=t.split("|"),o=a[0],n=a[1],l=a[2],u=a[3];switch(o){case"module":var d=u;i[l]=n!=r.module.name?r.record[n]?r.record[n][d]:null:r.record[d]?r.record[d]:null;break;case"static":switch(u){case"{:app:}":i[l]=e.user.app_id;break;case"{:tenant:}":i[l]=e.user.tenant_id;break;case"{:user:}":i[l]=e.user.id;break;default:i[l]=null}break;case"custom":i[l]=u;break;default:i[l]=null}}),"post"===o.method_type)b.post(o.url,n,{headers:i}).then(function(){t.create({content:a("translate")("Module.ActionButtonWebhookSuccess"),className:"success"}),r.webhookRequesting[o.id]=!1})["catch"](function(){t.create({content:a("translate")("Module.ActionButtonWebhookFail"),className:"warning"}),r.webhookRequesting[o.id]=!1});else if("get"===o.method_type){var d="";for(var s in n)d+=s+"="+n[s]+"&";d.length>0&&(d=d.substring(0,d.length-1)),b.get(o.url+"?"+d).then(function(){t.create({content:a("translate")("Module.ActionButtonWebhookSuccess"),className:"success"}),r.webhookRequesting[o.id]=!1})["catch"](function(){t.create({content:a("translate")("Module.ActionButtonWebhookFail"),className:"warning"}),r.webhookRequesting[o.id]=!1})}},r.$on("$locationChangeStart",function(e){r.moduleForm&&r.moduleForm.$dirty&&(confirm(a("translate")("Module.LeavePageWarning"))||e.preventDefault())}),r.setDropdownData=function(e){if(e.filters&&e.filters.length>0)r.dropdownFieldDatas[e.name]=null;else if(r.dropdownFieldDatas[e.name]&&r.dropdownFieldDatas[e.name].length>0)return;
r.currentLookupField=e,r.lookup().then(function(t){r.dropdownFieldDatas[e.name]=t})},r.getAttachments=function(){o.hasDocumentsPermission(r.operations.read)&&k.getEntityDocuments(e.workgroup.tenant_id,r.id,r.module.id).then(function(t){r.documentsResultSet=k.processDocuments(t.data,e.users),r.documents=r.documentsResultSet.documentList,r.loadingDocuments=!1})},w.run("AfterFormLoaded","script",r)}]);