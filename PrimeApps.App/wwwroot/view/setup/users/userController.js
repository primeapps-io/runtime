"use strict";angular.module("primeapps").controller("UserController",["$rootScope","$scope","$filter","$state","ngToast","guidEmpty","$popover","helper","UserService","WorkgroupService","AppService","ProfileService","RoleService","LicenseService","$q","officeHelper",function(e,t,i,n,l,a,s,o,r,d,c,m,p,T,O){function D(){var i=[];i.push(r.getAllUser()),i.push(m.getAll()),i.push(p.getAll()),i.push(T.getUserLicenseStatus()),O.all(i).then(function(i){var n=i[0].data,l=i[1].data,a=i[2].data,s=i[3].data;e.workgroup.users=n,t.profiles=m.getProfiles(l,e.workgroup.tenant_id,!0),t.roles=a,t.users=r.getUsers(n,t.profiles,t.roles),t.licensesBought=s.total||0,t.licensesUsed=s.used||0,t.licenseAvailable=t.licensesBought-t.licensesUsed,t.loading=!1})}t.loading=!0,t.isOfficeConnected=!1,t.officeUserReady=!1,t.officeUsers=null,t.selectedOfficeUser={},t.addUserModel={},t.addUserForm=!0,t.submitting=!1,t.hideSendEmailToUser=!1,t.officeUserChanged=function(e){t.addUserModel.email=e.email,t.addUserModel.phone=e.phone,t.addUserModel.fullName=e.fullName,t.addUserModel.firstName=e.name,t.addUserModel.lastName=e.surname},t.sendOfficeUserPassword=function(){var n="crm";switch(e.user.appId){case 2:n="kobi";break;case 3:n="asistan";break;case 4:n="ik";break;case 5:n="cagri";break;default:n="crm"}t.submitting=!0;var a=i("translate")("Setup.Office.EmailNotification.Hello")+" "+t.addedUser.fullName+"<br />"+i("translate")("Setup.Office.EmailNotification.Created")+"<br />"+i("translate")("Setup.Office.EmailNotification.Email")+t.addedUser.email+"<br />"+i("translate")("Setup.Office.EmailNotification.Password")+t.userPassword,s={};s.Subject=i("translate")("Setup.Office.EmailNotification.Subject"),s.TemplateWithBody='<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"> <html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office"> <head><title>Ofisim</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><style type="text/css">body, .maintable {height: 100% !important; width: 100% !important; margin: 0; padding: 0;}img, a img {border: 0;outline: none;             text-decoration: none;         }          .imagefix {             display: block;         }          p {             margin-top: 0;             margin-right: 0;             margin-left: 0;             padding: 0;         }          .ReadMsgBody {             width: 100%;         }          .ExternalClass {             width: 100%;         }              .ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div {                 line-height: 100%;             }          img {             -ms-interpolation-mode: bicubic;         }          body, table, td, p, a, li, blockquote {             -ms-text-size-adjust: 100%;             -webkit-text-size-adjust: 100%;         }     </style>     <style type="text/css">         @media only screen and (max-width: 600px) {             .rtable {                 width: 100% !important;                 table-layout: fixed;             }                  .rtable tr {                     height: auto !important;                     display: block;                 }              .contenttd {                 max-width: 100% !important;                 display: block;             }                  .contenttd:after {                     content: "";                     display: table;                     clear: both;                 }              .hiddentds {                 display: none;             }              .imgtable, .imgtable table {                 max-width: 100% !important;                 height: auto;                 float: none;                 margin: 0 auto;             }                  .imgtable.btnset td {                     display: inline-block;                 }                  .imgtable img {                     width: 100%;                     height: auto;                     display: block;                 }              table {                 float: none;                 table-layout: fixed;             }         }     </style>     <!--[if gte mso 9]>     <xml>       <o:OfficeDocumentSettings>         <o:AllowPNG/>         <o:PixelsPerInch>96</o:PixelsPerInch>       </o:OfficeDocumentSettings>     </xml>     <![endif]--> </head> <body style="overflow: auto; padding:0; margin:0; font-size: 12px; font-family: arial, helvetica, sans-serif; cursor:auto; background-color:#f4f4f4">     <table cellspacing="0" cellpadding="0" width="100%"            bgcolor="#f4f4f4">         <tr>             <td style="FONT-SIZE: 0px; HEIGHT: 20px; LINE-HEIGHT: 0"></td>         </tr>         <tr>             <td valign="top">                 <table class="rtable" style="WIDTH: 600px; MARGIN: 0px auto"                        cellspacing="0" cellpadding="0" width="600" align="center"                        border="0">                     <tr>                         <td class="contenttd"                             style="BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: medium none; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent">                             <table style="WIDTH: 100%" cellspacing="0" cellpadding="0"                                    align="left">                                 <tr class="hiddentds">                                     <td style="FONT-SIZE: 0px; HEIGHT: 0px; WIDTH: 367px; LINE-HEIGHT: 0; mso-line-height-rule: exactly"></td>                                     <td style="FONT-SIZE: 0px; HEIGHT: 0px; WIDTH: 233px; LINE-HEIGHT: 0; mso-line-height-rule: exactly"></td>                                 </tr>                                 <tr style="HEIGHT: 10px">                                     <th class="contenttd" style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; VERTICAL-ALIGN: middle; BORDER-BOTTOM: medium none; FONT-WEIGHT: normal; PADDING-BOTTOM: 20px; TEXT-ALIGN:center !important; PADDING-TOP: 20px; PADDING-LEFT: 0px; BORDER-LEFT: medium none; PADDING-RIGHT: 15px; BACKGROUND-COLOR: transparent; text-aling:center;">                                         <table class="imgtable" cellspacing="0" cellpadding="0"                                                align=" center" border="0">                                             <tr>                                                 <td style="PADDING-BOTTOM: 2px; PADDING-TOP: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; text-aling:center;" align="center">                                                     <table cellspacing="0" cellpadding="0" border="0">                                                         <tr>                                                             <td style="BORDER-TOP: medium none; BORDER-RIGHT: medium none;  BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; BACKGROUND-COLOR: transparent; text-align:center;">                                                                 <a href="http://www.ofisim.com/'+n+'/" target="_blank"><img style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; DISPLAY: block" alt="" src="http://www.ofisim.com/mail/'+n+'/logo.png" width="200" height="50" hspace="0" vspace="0" border="0" /></a>                                                             </td>                                                         </tr>                                                     </table>                                                 </td>                                             </tr>                                         </table>                                     </th>                                     <th class="contenttd" style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; VERTICAL-ALIGN: middle; BORDER-BOTTOM: medium none; FONT-WEIGHT: normal; PADDING-BOTTOM: 20px; TEXT-ALIGN: center; PADDING-TOP: 20px; PADDING-LEFT: 15px; BORDER-LEFT: medium none; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent">                                     </th>                                 </tr>                             </table>                         </td>                     </tr>                     <tr>                         <td class="contenttd" style="BORDER-TOP: #fff 5px solid; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: medium none; PADDING-RIGHT: 0px; BACKGROUND-COLOR: #fff;">                             <table style="WIDTH: 100%" cellspacing="0" cellpadding="0" align="center">                                 <tr class="hiddentds">                                     <td style="FONT-SIZE: 0px; HEIGHT: 0px; WIDTH: 600px; LINE-HEIGHT: 0; mso-line-height-rule: exactly"></td>                                 </tr>                                 <tr style="HEIGHT: 10px">                                     <th class="contenttd" style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; VERTICAL-ALIGN: top; BORDER-BOTTOM: medium none; FONT-WEIGHT: normal; PADDING-BOTTOM: 0px; TEXT-ALIGN: left; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: medium none; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent">                                         <!--[if gte mso 12]>                                             <table cellspacing="0" cellpadding="0" border="0" width="100%"><tr><td align="center">                                         <![endif]-->                                         <table class="imgtable" style="MARGIN: 0px auto" cellspacing="0"                                                cellpadding="0" align="center" border="0">                                             <tr>                                                 <td style="PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; PADDING-RIGHT: 0px"                                                     align="center"></td>                                             </tr>                                         </table>                                         <!--[if gte mso 12]>                                             </td></tr></table>                                         <![endif]-->                                     </th>                                 </tr>                             </table>                         </td>                     </tr>                      <tr>                            <td class="contenttd" style="BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; PADDING-BOTTOM: 0px; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: medium none; PADDING-RIGHT: 0px; BACKGROUND-COLOR: #fff;">                             <table style="WIDTH: 100%" cellspacing="0" cellpadding="0"                                    align="left">                                 <tr class="hiddentds">                                     <td style="FONT-SIZE: 0px; HEIGHT: 0px; WIDTH: 600px; LINE-HEIGHT: 0; mso-line-height-rule: exactly"></td>                                 </tr>                                 <tr style="HEIGHT: 20px">                                     <th class="contenttd" style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; VERTICAL-ALIGN: middle; BORDER-BOTTOM: medium none; FONT-WEIGHT: normal; PADDING-BOTTOM: 20px; TEXT-ALIGN: left; PADDING-TOP: 20px; PADDING-LEFT: 20px; BORDER-LEFT: medium none; PADDING-RIGHT: 20px; BACKGROUND-COLOR: #fff;">                                         <p style="FONT-SIZE: 18px; MARGIN-BOTTOM: 1em; FONT-FAMILY: arial, helvetica, sans-serif; MARGIN-TOP: 0px; COLOR: #333330; LINE-HEIGHT: 33px; BACKGROUND-COLOR: #fff; mso-line-height-rule: exactly"                                            align="center">                                             '+a+'<br />                                                                                     </p>                                         <p style="FONT-SIZE: 16px; MARGIN-BOTTOM: 1em; FONT-FAMILY: arial, helvetica, sans-serif; MARGIN-TOP: 0px; COLOR: #575757; LINE-HEIGHT: 24px; BACKGROUND-COLOR: transparent; mso-line-height-rule: exactly"                                            align="center"></p>                                          <p style="FONT-SIZE: 22px; MARGIN-BOTTOM: 1em; FONT-FAMILY: arial, helvetica, sans-serif; MARGIN-TOP: 0px; COLOR: #333330; LINE-HEIGHT: 33px; BACKGROUND-COLOR: #fff; mso-line-height-rule: exactly"                                            align="center">                                             <br />                                         </p>                                          <p style="FONT-SIZE: 11px; MARGIN-BOTTOM: 1em; FONT-FAMILY: arial, helvetica, sans-serif; MARGIN-TOP: 0px; COLOR: #333330; LINE-HEIGHT: 14px; BACKGROUND-COLOR: #fff; mso-line-height-rule: exactly"                                            align="center">'+i("translate")("Setup.Office.EmailNotification.Footer")+'</p>                                     </th>                                 </tr>                             </table>                         </td>                     </tr>                     <tr>                     <tr style="HEIGHT: 20px">                         <th class="contenttd"                             style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; VERTICAL-ALIGN: top; BORDER-BOTTOM: medium none; FONT-WEIGHT: normal; PADDING-BOTTOM: 20px; TEXT-ALIGN: left; PADDING-TOP: 20px; PADDING-LEFT: 15px; BORDER-LEFT: medium none; PADDING-RIGHT: 15px; BACKGROUND-COLOR: transparent">                             <div style="PADDING-BOTTOM: 10px; TEXT-ALIGN: center; PADDING-TOP: 10px; PADDING-LEFT: 10px; PADDING-RIGHT: 10px">                                 <table class="imgtable" style="DISPLAY: inline-block"                                        cellspacing="0" cellpadding="0" border="0">                                     <tr>                                         <td style="PADDING-RIGHT: 5px">                                             <a href="https://www.facebook.com/ofisimcrm" target="_blank">                                                 <img title="Facebook"                                                      style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; DISPLAY: block"                                                      alt="Facebook" src="http://www.ofisim.com/mail/KobiMail_files/fb.png" width="34"                                                      height="34" />                                             </a>                                         </td>                                         <td style="PADDING-RIGHT: 5px">                                             <a href="https://twitter.com/ofisim_com" target="_blank">                                                 <img title="Twitter"                                                      style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; DISPLAY: block"                                                      alt="Twitter" src="http://www.ofisim.com/mail/KobiMail_files/tw.png" width="34"                                                      height="34" />                                             </a>                                         </td>                                         <td style="PADDING-RIGHT: 5px">                                             <a href="https://www.linkedin.com/company/ofisim.com"                                                target="_blank">                                                 <img title="Linkedin"                                                      style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; BORDER-LEFT: medium none; DISPLAY: block"                                                      alt="Linkedin" src="http://www.ofisim.com/mail/KobiMail_files/in.png" width="34"                                                      height="34" />                                             </a>                                         </td>                                     </tr>                                 </table>                             </div>                             <p style="FONT-SIZE: 14px; MARGIN-BOTTOM: 1em; FONT-FAMILY: arial, helvetica, sans-serif; MARGIN-TOP: 0px; COLOR: #575757; LINE-HEIGHT: 21px; BACKGROUND-COLOR: transparent; mso-line-height-rule: exactly"                                align="left">&nbsp;</p>                         </th>                     </tr>                 </table>             </td>         </tr>         <tr>             <td class="contenttd"                 style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; PADDING-BOTTOM: 10px; PADDING-TOP: 10px; PADDING-LEFT: 0px; BORDER-LEFT: medium none; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent">                 <table style="WIDTH: 100%" cellspacing="0" cellpadding="0"                        align="left">                     <tr class="hiddentds">                         <td style="FONT-SIZE: 0px; HEIGHT: 0px; WIDTH: 600px; LINE-HEIGHT: 0; mso-line-height-rule: exactly"></td>                     </tr>                     <tr style="HEIGHT: 10px">                         <th class="contenttd"                             style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; VERTICAL-ALIGN: top; BORDER-BOTTOM: medium none; FONT-WEIGHT: normal; PADDING-BOTTOM: 0px; TEXT-ALIGN: left; PADDING-TOP: 0px; PADDING-LEFT: 0px; BORDER-LEFT: medium none; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent">                         </th>                     </tr>                 </table>             </td>         </tr>         <tr>             <td class="contenttd"                 style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; BORDER-BOTTOM: medium none; PADDING-BOTTOM: 1px; PADDING-TOP: 1px; PADDING-LEFT: 0px; BORDER-LEFT: medium none; PADDING-RIGHT: 0px; BACKGROUND-COLOR: transparent">                 <table style="WIDTH: 100%" cellspacing="0" cellpadding="0"                        align="left">                     <tr class="hiddentds">                         <td style="FONT-SIZE: 0px; HEIGHT: 0px; WIDTH: 600px; LINE-HEIGHT: 0; mso-line-height-rule: exactly"></td>                     </tr>                     <tr style="HEIGHT: 10px">                         <th class="contenttd"                             style="BORDER-TOP: medium none; BORDER-RIGHT: medium none; VERTICAL-ALIGN: top; BORDER-BOTTOM: medium none; FONT-WEIGHT: normal; PADDING-BOTTOM: 1px; TEXT-ALIGN: left; PADDING-TOP: 1px; PADDING-LEFT: 15px; BORDER-LEFT: medium none; PADDING-RIGHT: 15px; BACKGROUND-COLOR: transparent">                         </th>                     </tr>                 </table>             </td>         </tr>         <tr>             <td style="FONT-SIZE: 0px; HEIGHT: 8px; LINE-HEIGHT: 0">&nbsp;</td>         </tr>     </table>      <!-- Created with MailStyler 2.0.0.330 --> </body> </html>',s.ToAddresses=[t.addedUser.email],r.sendPasswordToOfficeUser(s).then(function(){t.closeUserInfoPopover(),l.create({content:i("translate")("Setup.Office.SendEmailSuccess"),className:"success",timeout:5e3})})["catch"](function(){t.closeUserInfoPopover(),l.create({content:i("translate")("Setup.Office.SendEmailError"),className:"success",timeout:5e3})})},t.closeUserInfoPopover=function(){t.submitting=!1,t.addUserForm=!0,t.userPassword=null,t.hideSendEmailToUser=!1,t.createOfficePopover?t.createOfficePopover.hide():t.createPopover&&t.createPopover.hide(),t.addedUser={}},D(),t.showCreateForm=function(){t.addedUser={},t.addUserForm=!0,t.createPopover=t.createPopover||s(angular.element(document.getElementById("createButton")),{templateUrl:"view/setup/users/userCreate.html",placement:"bottom-right",scope:t,autoClose:!0,show:!0})},t.showOfficeUserCreateForm=function(){t.addedUser={},t.addUserForm=!0,t.createOfficePopover=t.createOfficePopover||s(angular.element(document.getElementById("officeCreateButton")),{templateUrl:"view/setup/users/officeUserCreate.html",placement:"bottom-right",scope:t,autoClose:!0,show:!0})},t.addUser=function(e){e&&e.email&&e.profile&&e.role&&e.firstName&&e.lastName&&(e.fullName||(e.fullName=e.firstName+" "+e.lastName),t.userInviting=!0,e.profileId=e.profile,e.roleId=e.role,t.addedUser=angular.copy(e),e=o.SnakeToCamel(e),r.addUser(e).then(function(e){e.data&&(D(),t.userInviting=!1,l.create({content:i("translate")("Setup.Users.NewUserSuccess"),className:"success"}),t.userPassword=e.data.password,t.hideSendEmailToUser=e.data.password.contains("***"),t.addUserForm=!1,t.addUserModel={})})["catch"](function(e){t.userInviting=!1,409===e.status&&l.create({content:i("translate")("Setup.Users.NewUserError"),className:"warning"})}))},t.showEditForm=function(e){t.selectedUser=e,t.editModel={},t.editModel.profile=e.profile.id,t.editModel.role=e.role.id,t.editModel.activeDirectoryEmail=e.activeDirectoryEmail,t.userHaveActiveDirectoryEmail=null!==e.activeDirectoryEmail&&"null"!==e.activeDirectoryEmail&&""!==e.activeDirectoryEmail,t.editModelState=angular.copy(t.editModel),t["editPopover"+e.id]=t["editPopover"+e.id]||s(angular.element(document.getElementById("editButton"+e.id)),{templateUrl:"view/setup/users/userEdit.html",placement:"left",scope:t,autoClose:!0,show:!0})},t.edit=function(){if(t.userEditing=!0,t.editModel.profile===t.editModelState.profile&&t.editModel.role===t.editModelState.role&&t.editModel.activeDirectoryEmail===t.editModelState.activeDirectoryEmail)return t.userEditing=!1,void t.popover.hide();var n=function(){D(),t.userEditing=!1,t.popover.hide(),l.create({content:i("translate")("Setup.Users.EditSuccess"),className:"success"})},a=function(){r.updateActiveDirectoryEmail(t.selectedUser.id,t.editModel.activeDirectoryEmail).then(function(){n()})["catch"](function(e){t.userEditing=!1,409===e.status&&l.create({content:i("translate")("Setup.Users.NewUserError"),className:"warning"})})};m.changeUserProfile(t.selectedUser.id,e.workgroup.tenant_id,t.editModel.profile).then(function(){p.updateUserRole(t.selectedUser.id,t.editModel.role).then(function(){null===t.editModel.activeDirectoryEmail&&""===t.editModel.activeDirectoryEmail||t.editModel.activeDirectoryEmail===t.editModelState.activeDirectoryEmail?n():a()})["catch"](function(){t.userEditing=!1})})["catch"](function(){t.userEditing=!1})},t.dismiss=function(n,a,s){t.userDeleting=!0,r.dismiss(n,e.workgroup.tenant_id).then(function(){t.users.splice(a,1),t.userDeleting=!1,l.create({content:i("translate")("Setup.Users.DismissSuccess"),className:"success"}),c.getMyAccount(!0),T.getUserLicenseStatus().then(function(e){t.licensesBought=e.data.total||0,t.licensesUsed=e.data.used||0,t.licenseAvailable=t.licensesBought-t.licensesUsed}),s()})["catch"](function(){t.userDeleting=!1,s()})},t.gotoLicencePage=function(){var e=i("filter")(t.$parent.menuItems,{link:"#/app/setup/license"})[0];t.$parent.selectMenuItem(e),n.go("app.setup.license")}}]);